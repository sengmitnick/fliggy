#!/bin/bash -e

echo "Running docker entrypoint"

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ] && [ -f /usr/lib/*/libjemalloc.so.2 ]; then
  export LD_PRELOAD="$(echo /usr/lib/*/libjemalloc.so.2)"
fi

echo "Check if application.yml and database.yml are present"

# Skip application.yml in production - use environment variables instead
if [ "${RAILS_ENV}" != "production" ]; then
  if [ ! -f "config/application.yml" ]; then
    cp config/application.yml.example config/application.yml 2>/dev/null || true
  fi
fi

# Always create database.yml if missing (needed for solid_cable even in production)
if [ ! -f "config/database.yml" ]; then
  cp config/database.yml.example config/database.yml 2>/dev/null || true
fi

echo "If running the rails server then create or migrate existing database"

if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  # 生产环境：创建 app_user 角色（RLS 策略需要）
  if [ "${RAILS_ENV}" == "production" ]; then
    echo "[Production] Initializing database roles for RLS policies..."

    # 获取超级用户数据库连接信息（仅用于创建 app_user）
    SUPER_USER="${DB_USER:-travel01}"
    SUPER_PASSWORD="${DB_PASSWORD}"
    DB_HOST="${DB_HOST:-db}"
    DB_NAME="${DB_NAME:-travel01_production}"

    # 临时使用超级用户连接创建 app_user（之后 db:prepare 会使用 app_user）
    export TEMP_DATABASE_URL="postgresql://${SUPER_USER}:${SUPER_PASSWORD}@${DB_HOST}:5432/${DB_NAME}"

    echo "[Production] Waiting for database to be ready..."
    for i in {1..30}; do
      if bundle exec rails runner -e production "ActiveRecord::Base.connection" 2>/dev/null; then
        echo "[Production] Database is ready"
        break
      fi
      echo "[Production] Waiting for database... ($i/30)"
      sleep 2
    done

    # 使用 Rails runner 创建 app_user 角色
    echo "[Production] Creating app_user role..."
    bundle exec rails runner -e production "$(cat <<'RUBY'
begin
  # 检查 app_user 是否存在
  result = ActiveRecord::Base.connection.execute("SELECT 1 FROM pg_roles WHERE rolname = 'app_user'")

  if result.to_a.empty?
    puts '[Production] Creating app_user role...'

    # 获取密码
    password = ENV['DB_PASSWORD'] || ENV['SUPER_PASSWORD']
    db_name = ENV['DB_NAME'] || 'travel01_production'

    # 创建 app_user 角色
    ActiveRecord::Base.connection.execute("CREATE ROLE app_user WITH LOGIN NOSUPERUSER PASSWORD '#{password}'")

    # 授予权限
    ActiveRecord::Base.connection.execute("GRANT CONNECT ON DATABASE #{db_name} TO app_user")
    ActiveRecord::Base.connection.execute("GRANT USAGE, CREATE ON SCHEMA public TO app_user")
    ActiveRecord::Base.connection.execute("GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user")
    ActiveRecord::Base.connection.execute("GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO app_user")
    ActiveRecord::Base.connection.execute("ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_user")
    ActiveRecord::Base.connection.execute("ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO app_user")
    ActiveRecord::Base.connection.execute("ALTER ROLE app_user SET search_path TO public")

    puts '[Production] ✅ app_user role created successfully'
  else
    puts '[Production] ✅ app_user role already exists'
  end
rescue => e
  puts "[Production] ⚠️  Error initializing app_user: #{e.message}"
  # 不退出，继续执行（可能是权限问题或角色已存在）
end
RUBY
)" 2>&1

    # 恢复使用 app_user 连接
    unset TEMP_DATABASE_URL

    echo "[Production] Role initialization complete"
  fi
  
  ./bin/rails db:prepare
fi

exec "${@}"
