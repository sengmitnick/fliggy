#!/usr/bin/env ruby
# frozen_string_literal: true

# Verify - éªŒè¯ç³»ç»Ÿå‘½ä»¤è¡Œå·¥å…·
# 
# ç”¨æ³•:
#   bin/verify list                        # åˆ—å‡ºæ‰€æœ‰éªŒè¯å™¨
#   bin/verify run <validator_id>          # è¿è¡ŒéªŒè¯å™¨ï¼ˆäº¤äº’æ¨¡å¼ï¼‰
#   bin/verify show <validator_id>         # æ˜¾ç¤ºéªŒè¯å™¨è¯¦æƒ…

require_relative '../config/environment'

class VerifyCLI
  def initialize(args)
    @args = args
    @command = args[0]
  end
  
  def run
    case @command
    when 'list'
      list_validators
    when 'show'
      show_validator(@args[1])
    when 'run'
      run_validator(@args[1])
    when 'help', '-h', '--help', nil
      show_help
    else
      puts "æœªçŸ¥å‘½ä»¤: #{@command}"
      show_help
      exit 1
    end
  end
  
  private
  
  # åˆ—å‡ºæ‰€æœ‰éªŒè¯å™¨
  def list_validators
    validators = load_all_validators
    
    if validators.empty?
      puts "âŒ æœªæ‰¾åˆ°ä»»ä½•éªŒè¯å™¨"
      puts "æç¤º: éªŒè¯å™¨åº”æ”¾åœ¨ app/validators/*_validator.rb"
      return
    end
    
    puts "\nğŸ“‹ å¯ç”¨çš„éªŒè¯å™¨ (å…± #{validators.size} ä¸ª):\n\n"
    
    validators.each do |validator|
      meta = validator.metadata
      puts "  ğŸ”¹ ID: #{meta[:id]}"
      puts "     æ ‡é¢˜: #{meta[:title]}"
      puts "     æè¿°: #{meta[:description]}"
      puts "     æ•°æ®åŒ…: #{meta[:data_pack_version]}"
      puts "     è¶…æ—¶: #{meta[:timeout]}ç§’"
      puts ""
    end
  end
  
  # æ˜¾ç¤ºéªŒè¯å™¨è¯¦æƒ…
  def show_validator(validator_id)
    unless validator_id
      puts "âŒ é”™è¯¯: è¯·æŒ‡å®šéªŒè¯å™¨ ID"
      puts "ç”¨æ³•: bin/verify show <validator_id>"
      exit 1
    end
    
    validator = find_validator(validator_id)
    meta = validator.metadata
    
    puts "\nğŸ“„ éªŒè¯å™¨è¯¦æƒ…:\n\n"
    puts "  ID:          #{meta[:id]}"
    puts "  æ ‡é¢˜:        #{meta[:title]}"
    puts "  æè¿°:        #{meta[:description]}"
    puts "  æ•°æ®åŒ…ç‰ˆæœ¬:  #{meta[:data_pack_version]}"
    puts "  è¶…æ—¶æ—¶é—´:    #{meta[:timeout]}ç§’"
    puts ""
  end
  
  # è¿è¡ŒéªŒè¯å™¨ï¼ˆäº¤äº’æ¨¡å¼ï¼‰
  def run_validator(validator_id)
    unless validator_id
      puts "âŒ é”™è¯¯: è¯·æŒ‡å®šéªŒè¯å™¨ ID"
      puts "ç”¨æ³•: bin/verify run <validator_id>"
      exit 1
    end
    
    validator_class = find_validator(validator_id)
    execution_id = SecureRandom.uuid
    instance = validator_class.new(execution_id)
    
    puts "\n" + "="*60
    puts "ğŸš€ å¼€å§‹æ‰§è¡ŒéªŒè¯: #{validator_class.title}"
    puts "="*60
    
    # === å‡†å¤‡é˜¶æ®µ ===
    puts "\nğŸ“¦ å‡†å¤‡é˜¶æ®µ: åŠ è½½æ•°æ®åŒ…..."
    
    begin
      # execute_prepare å†…éƒ¨å·²ç»å¤„ç†äº†äº‹åŠ¡å’ŒçŠ¶æ€ä¿å­˜ï¼Œä¸éœ€è¦å¤–å±‚äº‹åŠ¡
      prepare_info = instance.execute_prepare
      
      puts "\nâœ… å‡†å¤‡å®Œæˆï¼ä»»åŠ¡ä¿¡æ¯ï¼š"
      puts JSON.pretty_generate(prepare_info)
    rescue StandardError => e
      puts "\nâŒ å‡†å¤‡é˜¶æ®µå¤±è´¥: #{e.message}"
      puts e.backtrace.first(5).join("\n")
      exit 1
    end
    
    # === ç­‰å¾…ç”¨æˆ·æ“ä½œ ===
    puts "\n" + "-"*60
    puts "â¸ï¸  è¯·æ‰‹åŠ¨å®Œæˆä»¥ä¸‹æ“ä½œ:"
    puts "   1. å¯åŠ¨é¡¹ç›®: bin/dev"
    puts "   2. åœ¨æµè§ˆå™¨ä¸­å®Œæˆä»»åŠ¡"
    puts "   3. å®ŒæˆåæŒ‰å›è½¦ç»§ç»­éªŒè¯..."
    puts "-"*60
    
    $stdin.gets
    
    # === éªŒè¯é˜¶æ®µ ===
    puts "\nğŸ” éªŒè¯é˜¶æ®µ: æ£€æŸ¥ç»“æœ..."
    
    begin
      # execute_verify å†…éƒ¨å·²ç»å¤„ç†äº†äº‹åŠ¡ï¼Œä¸éœ€è¦å¤–å±‚äº‹åŠ¡
      result = instance.execute_verify
      
      # æ˜¾ç¤ºç»“æœ
      display_result(result)
      
    rescue StandardError => e
      puts "\nâŒ éªŒè¯é˜¶æ®µå¤±è´¥: #{e.message}"
      puts e.backtrace.first(5).join("\n")
      exit 1
    end
  end
  
  # æ˜¾ç¤ºéªŒè¯ç»“æœ
  def display_result(result)
    puts "\n" + "="*60
    puts "ğŸ“Š éªŒè¯ç»“æœ"
    puts "="*60
    
    status_icon = case result[:status]
                  when 'passed' then 'âœ…'
                  when 'failed' then 'âŒ'
                  else 'âš ï¸'
                  end
    
    puts "\n#{status_icon} çŠ¶æ€: #{result[:status].upcase}"
    puts "ğŸ¯ å¾—åˆ†: #{result[:score]}/100"
    puts ""
    
    # æ˜¾ç¤ºæ–­è¨€ç»“æœ
    if result[:assertions].any?
      puts "ğŸ“‹ æ–­è¨€è¯¦æƒ…:\n\n"
      result[:assertions].each do |assertion|
        icon = assertion[:passed] ? 'âœ“' : 'âœ—'
        status = assertion[:passed] ? 'é€šè¿‡' : 'å¤±è´¥'
        
        puts "  #{icon} #{assertion[:name]} (æƒé‡: #{assertion[:weight]}) - #{status}"
        
        if assertion[:error]
          puts "     é”™è¯¯: #{assertion[:error]}"
        end
      end
      puts ""
    end
    
    # æ˜¾ç¤ºé”™è¯¯åˆ—è¡¨
    if result[:errors].any?
      puts "âŒ é”™è¯¯åˆ—è¡¨:\n\n"
      result[:errors].each do |error|
        puts "  â€¢ #{error}"
      end
      puts ""
    end
    
    # æœ€ç»ˆè¯„ä»·
    case result[:score]
    when 90..100
      puts "ğŸ† ä¼˜ç§€ï¼å®Œç¾å®Œæˆä»»åŠ¡ï¼"
    when 70..89
      puts "ğŸ‘ è‰¯å¥½ï¼å¤§éƒ¨åˆ†è¦æ±‚å·²è¾¾æˆã€‚"
    when 60..69
      puts "âœ… åŠæ ¼ï¼Œä½†è¿˜æœ‰æ”¹è¿›ç©ºé—´ã€‚"
    else
      puts "ğŸ’ª ç»§ç»­åŠªåŠ›ï¼è¯·ä»”ç»†æ£€æŸ¥ä»»åŠ¡è¦æ±‚ã€‚"
    end
    
    puts "="*60 + "\n"
  end
  
  # åŠ è½½æ‰€æœ‰éªŒè¯å™¨ç±»
  def load_all_validators
    validator_files = Dir[Rails.root.join('app/validators/*_validator.rb')]
    
    validator_files.map do |file|
      next if file.end_with?('base_validator.rb')
      
      class_name = File.basename(file, '.rb').camelize
      require file
      class_name.constantize
    end.compact.select { |klass| klass < BaseValidator }
  end
  
  # æ ¹æ® ID æŸ¥æ‰¾éªŒè¯å™¨
  def find_validator(id)
    validators = load_all_validators
    validator = validators.find { |v| v.validator_id == id }
    
    unless validator
      puts "âŒ é”™è¯¯: éªŒè¯å™¨ '#{id}' ä¸å­˜åœ¨"
      puts "\nå¯ç”¨çš„éªŒè¯å™¨:"
      validators.each { |v| puts "  - #{v.validator_id}" }
      exit 1
    end
    
    validator
  end
  
  # æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
  def show_help
    puts <<~HELP
      
      ğŸ“˜ Verify - éªŒè¯ç³»ç»Ÿå‘½ä»¤è¡Œå·¥å…·
      
      ç”¨æ³•:
        bin/verify <command> [options]
      
      å‘½ä»¤:
        list                     åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„éªŒè¯å™¨
        show <validator_id>      æ˜¾ç¤ºéªŒè¯å™¨è¯¦ç»†ä¿¡æ¯
        run <validator_id>       è¿è¡ŒéªŒè¯å™¨ï¼ˆäº¤äº’æ¨¡å¼ï¼‰
        help, -h, --help         æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯
      
      ç¤ºä¾‹:
        # æŸ¥çœ‹æ‰€æœ‰éªŒè¯å™¨
        bin/verify list
        
        # æŸ¥çœ‹ç‰¹å®šéªŒè¯å™¨è¯¦æƒ…
        bin/verify show book_flight_sz_to_bj
        
        # è¿è¡ŒéªŒè¯å™¨
        bin/verify run book_flight_sz_to_bj
      
      éªŒè¯å™¨å¼€å‘:
        éªŒè¯å™¨æ–‡ä»¶åº”æ”¾åœ¨: app/validators/*_validator.rb
        ç»§æ‰¿è‡ª: BaseValidator
        å®ç°æ–¹æ³•: prepare, verify
      
    HELP
  end
end

# è¿è¡Œ CLI
VerifyCLI.new(ARGV).run
