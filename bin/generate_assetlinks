#!/bin/bash

# Generate assetlinks.json with actual keystore fingerprint for TWA
# This script extracts the SHA256 fingerprint from android.keystore

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

echo "========================================="
echo "  Generate assetlinks.json for TWA"
echo "========================================="
echo

# Check if keystore exists
if [ ! -f "android.keystore" ]; then
    print_error "android.keystore 未找到！"
    echo "请确保 android.keystore 文件在当前目录"
    exit 1
fi

print_success "检测到 android.keystore"

# Try to read keystore password from twa-manifest.json or prompt user
echo
echo "请输入 keystore 密码 (留空使用默认密码 'android'):"
read -s KEYSTORE_PASSWORD

if [ -z "$KEYSTORE_PASSWORD" ]; then
    KEYSTORE_PASSWORD="android"
    print_warning "使用默认密码: android"
fi

# Extract SHA256 fingerprint
echo
echo "正在提取 SHA256 指纹..."
FINGERPRINT=$(keytool -list -v -keystore android.keystore -alias android -storepass "$KEYSTORE_PASSWORD" -keypass "$KEYSTORE_PASSWORD" 2>/dev/null | \
    grep "SHA256:" | \
    sed 's/.*SHA256: //g' | \
    tr -d ' ')

if [ -z "$FINGERPRINT" ]; then
    print_error "无法提取 SHA256 指纹"
    echo "请检查:"
    echo "  1. keystore 密码是否正确"
    echo "  2. alias 是否为 'android'"
    echo "  3. keystore 文件是否损坏"
    exit 1
fi

print_success "SHA256 指纹: $FINGERPRINT"

# Format fingerprint (add colons every 2 characters)
FORMATTED_FINGERPRINT=$(echo "$FINGERPRINT" | sed 's/\(..\)/\1:/g' | sed 's/:$//')

print_success "格式化指纹: $FORMATTED_FINGERPRINT"

# Update PwaController
echo
echo "正在更新 app/controllers/pwa_controller.rb..."

# Use sed to replace the placeholder fingerprint
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    sed -i '' "s/00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00/$FORMATTED_FINGERPRINT/g" app/controllers/pwa_controller.rb
else
    # Linux
    sed -i "s/00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00/$FORMATTED_FINGERPRINT/g" app/controllers/pwa_controller.rb
fi

print_success "PwaController 已更新"

# Test assetlinks endpoint
echo
echo "正在测试 assetlinks.json 端点..."
if command -v curl &> /dev/null; then
    if pgrep -f "rails.*server\|puma" > /dev/null; then
        PORT=$(grep -o "port [0-9]*" config/puma.rb 2>/dev/null | awk '{print $2}' || echo "3000")
        RESPONSE=$(curl -s http://localhost:$PORT/.well-known/assetlinks.json 2>/dev/null || echo "")
        if [ -n "$RESPONSE" ]; then
            print_success "assetlinks.json 端点可访问"
            echo "$RESPONSE" | python3 -m json.tool 2>/dev/null || echo "$RESPONSE"
        else
            print_warning "Rails 服务器未运行，跳过端点测试"
        fi
    else
        print_warning "Rails 服务器未运行，跳过端点测试"
    fi
fi

echo
print_success "完成！assetlinks.json 配置已更新"
echo
echo "下一步操作:"
echo "1. 重启 Rails 服务器（如果正在运行）"
echo "2. 访问 http://localhost:PORT/.well-known/assetlinks.json 验证配置"
echo "3. 使用 rebuild_apk.sh 重新生成 APK"
echo "4. 安装新 APK 后，TWA 应该不再显示浏览器地址栏"
echo
echo "注意: 客户端部署后需要:"
echo "  1. 运行此脚本更新 assetlinks.json"
echo "  2. 重启服务器使更改生效"
echo "  3. 重新构建 APK（因为 assetlinks.json URL 需要匹配部署域名）"
