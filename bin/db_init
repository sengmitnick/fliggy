#!/usr/bin/env ruby
require 'fileutils'

# path to your application root.
APP_ROOT = File.expand_path('..', __dir__)

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

FileUtils.chdir APP_ROOT do
  puts "\n=========================================="
  puts "ğŸš€ æ•°æ®åº“åˆå§‹åŒ–å¼€å§‹..."
  puts "==========================================\n"

  # Step 1: åˆ›å»º app_user è§’è‰²
  puts "ğŸ“Š [1/3] åˆ›å»ºæ•°æ®åº“è§’è‰² app_user..."
  
  require_relative '../config/environment'
  
  begin
    ActiveRecord::Base.connection.execute(<<~SQL)
      DO $$
      BEGIN
         IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'app_user') THEN
            CREATE ROLE app_user WITH LOGIN NOSUPERUSER INHERIT NOCREATEDB NOCREATEROLE NOREPLICATION;
            RAISE NOTICE 'Created app_user role';
         ELSE
            RAISE NOTICE 'app_user role already exists';
         END IF;
      END $$;
    SQL
    
    # è®¾ç½®å¯†ç ï¼ˆä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œæˆ–ä½¿ç”¨é»˜è®¤å€¼ï¼‰
    db_password = ENV['DB_PASSWORD'] || ENV.fetch('DATABASE_URL', '').match(/postgres:\/\/[^:]+:([^@]+)@/)&.[](1) || 'password'
    
    ActiveRecord::Base.connection.execute("ALTER ROLE app_user WITH PASSWORD '#{db_password}';")
    
    # è·å–å½“å‰æ•°æ®åº“å
    db_name = ActiveRecord::Base.connection.current_database
    
    # æˆäºˆåŸºæœ¬æƒé™
    ActiveRecord::Base.connection.execute("GRANT CONNECT ON DATABASE #{db_name} TO app_user;")
    ActiveRecord::Base.connection.execute("GRANT USAGE, CREATE ON SCHEMA public TO app_user;")
    ActiveRecord::Base.connection.execute("GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;")
    ActiveRecord::Base.connection.execute("GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO app_user;")
    
    # é»˜è®¤æƒé™ï¼ˆæœªæ¥åˆ›å»ºçš„è¡¨è‡ªåŠ¨æˆæƒï¼‰
    ActiveRecord::Base.connection.execute("ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_user;")
    ActiveRecord::Base.connection.execute("ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO app_user;")
    
    # è®¾ç½®é»˜è®¤æœç´¢è·¯å¾„
    ActiveRecord::Base.connection.execute("ALTER ROLE app_user SET search_path TO public;")
    
    puts "âœ“ app_user è§’è‰²å·²å°±ç»ª"
  rescue => e
    puts "âš ï¸  åˆ›å»º app_user æ—¶å‡ºé”™: #{e.message}"
    puts "ç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤..."
  end
  
  # Step 2: è¿è¡Œæ•°æ®åº“è¿ç§»
  puts "\nğŸ“Š [2/3] è¿è¡Œæ•°æ®åº“è¿ç§»..."
  system! 'bin/rails db:migrate'
  
  # Step 3: åŠ è½½åŸºçº¿æ•°æ®
  puts "\nğŸ“Š [3/3] åŠ è½½åŸºçº¿éªŒè¯æ•°æ®..."
  system! 'bin/rails validator:reset_baseline'
  
  puts "\n=========================================="
  puts "âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼"
  puts "==========================================\n"
  puts "ğŸ“ åç»­æ“ä½œï¼š"
  puts "   å¯åŠ¨æœåŠ¡: bin/dev"
  puts "   è¿è¡Œæµ‹è¯•: rake test"
  puts ""
end
