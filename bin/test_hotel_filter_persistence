#!/bin/bash

# é…’åº—ç­›é€‰æ¡ä»¶ä¿ç•™åŠŸèƒ½ - æ‰‹åŠ¨æµ‹è¯•è„šæœ¬
# ç”¨äºå¿«é€ŸéªŒè¯åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ

set -e

echo "=============================================="
echo "ğŸ¯ é…’åº—ç­›é€‰æ¡ä»¶ä¿ç•™åŠŸèƒ½ - æµ‹è¯•éªŒè¯"
echo "=============================================="
echo ""

# æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
if ! curl -s http://localhost:3000 > /dev/null; then
  echo "âŒ é”™è¯¯: RailsæœåŠ¡å™¨æœªè¿è¡Œ"
  echo "è¯·å…ˆè¿è¡Œ: bin/dev"
  exit 1
fi

echo "âœ… RailsæœåŠ¡å™¨è¿è¡Œä¸­..."
echo ""

# 1. æ£€æŸ¥é…’åº—é¡µé¢æ˜¯å¦åŒ…å« controller
echo "ğŸ“‹ æ­¥éª¤ 1: æ£€æŸ¥ hotel-filter-persistence controller æ˜¯å¦å·²é›†æˆ..."
if curl -s 'http://localhost:3000/hotels' | grep -q 'hotel-filter-persistence'; then
  echo "   âœ… Controller å·²æ­£ç¡®é›†æˆåˆ°é¡µé¢"
else
  echo "   âŒ Controller æœªæ‰¾åˆ°"
  exit 1
fi
echo ""

# 2. æ£€æŸ¥ JavaScript æ˜¯å¦å·²ç¼–è¯‘
echo "ğŸ“‹ æ­¥éª¤ 2: æ£€æŸ¥ JavaScript ç¼–è¯‘çŠ¶æ€..."
if [ -f "app/assets/builds/application.js" ] && grep -q "HotelFilterPersistence" app/assets/builds/application.js; then
  echo "   âœ… JavaScript å·²ç¼–è¯‘"
else
  echo "   âŒ JavaScript æœªç¼–è¯‘æˆ–ä¸åŒ…å« HotelFilterPersistence"
  exit 1
fi
echo ""

# 3. æ£€æŸ¥ TypeScript æºæ–‡ä»¶
echo "ğŸ“‹ æ­¥éª¤ 3: æ£€æŸ¥ TypeScript æºæ–‡ä»¶..."
if [ -f "app/javascript/controllers/hotel_filter_persistence_controller.ts" ]; then
  echo "   âœ… Controller æºæ–‡ä»¶å­˜åœ¨"
  
  # æ£€æŸ¥å…³é”®æ–¹æ³•
  if grep -q "saveFilters" app/javascript/controllers/hotel_filter_persistence_controller.ts; then
    echo "   âœ… saveFilters æ–¹æ³•å­˜åœ¨"
  fi
  
  if grep -q "restoreFilters" app/javascript/controllers/hotel_filter_persistence_controller.ts; then
    echo "   âœ… restoreFilters æ–¹æ³•å­˜åœ¨"
  fi
  
  if grep -q "sessionStorage" app/javascript/controllers/hotel_filter_persistence_controller.ts; then
    echo "   âœ… sessionStorage é›†æˆæ­£ç¡®"
  fi
else
  echo "   âŒ Controller æºæ–‡ä»¶ä¸å­˜åœ¨"
  exit 1
fi
echo ""

# 4. æ£€æŸ¥æ–‡æ¡£
echo "ğŸ“‹ æ­¥éª¤ 4: æ£€æŸ¥ç›¸å…³æ–‡æ¡£..."
if [ -f "FILTER_PERSISTENCE_TEST.md" ]; then
  echo "   âœ… FILTER_PERSISTENCE_TEST.md å­˜åœ¨"
fi

if [ -f "HOTEL_FILTER_PERSISTENCE_SUMMARY.md" ]; then
  echo "   âœ… HOTEL_FILTER_PERSISTENCE_SUMMARY.md å­˜åœ¨"
fi
echo ""

# 5. æ¨¡æ‹Ÿç”¨æˆ·æµç¨‹æµ‹è¯•
echo "ğŸ“‹ æ­¥éª¤ 5: æ¨¡æ‹Ÿç”¨æˆ·æµç¨‹æµ‹è¯•..."
echo "   âš ï¸  éœ€è¦æ‰‹åŠ¨åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•ï¼š"
echo ""
echo "   1. è®¿é—® http://localhost:3000/hotels"
echo "   2. ä¿®æ”¹ç­›é€‰æ¡ä»¶ï¼ˆåŸå¸‚ã€æ—¥æœŸã€æˆ¿é—´æ•°ç­‰ï¼‰"
echo "   3. ç‚¹å‡»æœç´¢æŒ‰é’®"
echo "   4. ç‚¹å‡»è¿”å›æŒ‰é’®å›åˆ°é¦–é¡µ"
echo "   5. å†æ¬¡ç‚¹å‡»é…’åº—æŒ‰é’®"
echo "   6. éªŒè¯ç­›é€‰æ¡ä»¶æ˜¯å¦è‡ªåŠ¨æ¢å¤"
echo ""

# 6. æµè§ˆå™¨æ§åˆ¶å°éªŒè¯å‘½ä»¤
echo "ğŸ“‹ æ­¥éª¤ 6: æµè§ˆå™¨æ§åˆ¶å°éªŒè¯å‘½ä»¤..."
echo "   æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ï¼Œåœ¨æ§åˆ¶å°æ‰§è¡Œï¼š"
echo ""
echo "   // æŸ¥çœ‹ä¿å­˜çš„ç­›é€‰æ¡ä»¶"
echo "   JSON.parse(sessionStorage.getItem('hotel_filters_state'))"
echo ""
echo "   // æ‰‹åŠ¨æ¸…é™¤ç­›é€‰æ¡ä»¶"
echo "   sessionStorage.removeItem('hotel_filters_state')"
echo ""

echo "=============================================="
echo "âœ… æ‰€æœ‰è‡ªåŠ¨æ£€æŸ¥é€šè¿‡ï¼"
echo "=============================================="
echo ""
echo "ğŸ“– åŠŸèƒ½è¯´æ˜ï¼š"
echo "   å½“ç”¨æˆ·åœ¨é…’åº—é¡µé¢è®¾ç½®ç­›é€‰æ¡ä»¶åï¼Œè¿”å›é¦–é¡µå†è¿›å…¥é…’åº—é¡µé¢æ—¶ï¼Œ"
echo "   ä¹‹å‰çš„ç­›é€‰æ¡ä»¶ä¼šè‡ªåŠ¨æ¢å¤ã€‚"
echo ""
echo "ğŸ”§ æŠ€æœ¯å®ç°ï¼š"
echo "   - Controller: hotel-filter-persistence (Stimulus)"
echo "   - å­˜å‚¨æ–¹å¼: sessionStorage"
echo "   - å­˜å‚¨é”®: hotel_filters_state"
echo "   - è¿‡æœŸæ—¶é—´: 24å°æ—¶"
echo ""
echo "ğŸ“š è¯¦ç»†æ–‡æ¡£ï¼š"
echo "   - FILTER_PERSISTENCE_TEST.md (æµ‹è¯•æŒ‡å—)"
echo "   - HOTEL_FILTER_PERSISTENCE_SUMMARY.md (åŠŸèƒ½æ€»ç»“)"
echo ""
