手机应用环境交付规范

> 由于云手机无法部署全套服务+存储，因此需要采用中心化部署服务端 + APK 的交付方式

## 服务端 + 存储

供应商可选择交付 Dockfile、或者源码的方式（最好是 docker 的形式，我们内部可以直接一键部署），整个服务 + 存储可独立部署在一台 8核32G 的服务器上，具体要求如下：
  - server + 存储需要部署在单台实例上，服务的端口使用 5001-5050 之间
  - 服务端自带 verify 的 server，暴露可用于对不同 task 进行 verify 的接口（如/verify/run）
  - 服务端自带 setup 的 server，暴露可用于对不同 task 进行 setup （针对任务的环境初始化） 的接口（如/setup/run）
  - 服务端自带创建 session_id 的接口，session_id 用于隔离不同 Agent 执行相同 task 时的状态，避免互相干扰

### 创建训练会话

```
POST /api/tasks/:id/start

Return
    TaskJson
    session_id

```

APK 将部署在云手机上
算法侧使用 task_id 从字节内部调度平台申请 1 台云手机实例
字节内部调度平台为算法侧分配 1 台云手机实例时：
  - 会使用 task_id 从服务端申请 1 个 session_id 
  - 使用 session_id 作为参数，使用 ADB am start 命令启动 APK + 并完成 setup
  - APK 将当前云手机实例和 session_id 做绑定

### Setup 配置规范
- 无具体的额外 setup 配置
- 在创建 session_id  阶段，会携带 task_id 发起对服务端的请求
  - 对于需要进行 setup 的 task，可以在这个阶段直接完成 setup

### Verify 规范
- 配置规范
由于手机环境的服务端为中心化部署，且需要通过 session_id 隔离不同 rollout，那么 verify 也需要按照 session_id 的维度进行隔离。
Verify 由算法侧发起，直接请求中心化服务的 verify 接口。
供应商自行实现 verify 的接口

```
"verification": {
    "driver": "vm_http",  // 供应商不需要关心，先默认填写 vm_http
    "config": {
      "domain": "xiaohongshu",  // verify 的任务类型，如 xiaohongshu 应用的 verify
      "verfiy_api": "/api/verify/run", // 具体用于 verify 的接口路径，POST，参数为 task_id / session_id
      "params": {
          "task_id":"" // 题目 id
          // session_id 是在申请手机实例的运行时产生，算法侧记录 session_id 用于发起对 verfiy_api 的请求 
      }
    }
 }

```

### 返回规范
返回的核心字段为 score 和 reason。
score：任务执行的得分 0 ～ 1
reason：任务执行错误的原因
如果 verify 执行过程中因为其他原因失败（并非 Agent 做错），如网络问题、系统问题、内部错误等，需要返回 execution_status，并在 reason 中返回原因
```
{
    "score": 0.59,
    "reason":"", // verify 逻辑正常执行的结果，正常通过 or 为通过
    "execution_status":"", // verify 接口跑崩、内部错误等【非 Agent 做错任务】情况，返回 fail，正常情况下返回 success
    "metadata":{ // 可选
        "details": [ // 如果 reward_function 内会验证多个子步骤，则按照下面的方式补齐 details
            "process":[]
            "result":[
              {
                  "child_verify_id": "check_login",
                  "score": 0.8,
                  "weight": 0.3
                  "child_reason": {  // 供应商自定义组装需要的信息
                    "status_code": "200",
              },
              {
                  "child_verify_id": "check_like",
                  "score": 0.5,
                  "weight": 0.7,
                  "child_reason": {
                    "like_nums": "1",
                    "like_detail": "Tom"
                  }
                }
            ]
          ]
    }
}
```

### task 交付的整体格式
{
    "id":"task_uniq_id_gen_by_uuid",
    "task":{
        "instruction": ""， // 任务描述
        "simulated_user_known_info": "",  // 预留字段
        "simulated_user_persona": "",  // 预留字段
        "success_criteria": "***"  // 预留字段
    },
    "env_id": "env_uniq_id_desc_the_env_name",
    "version": "", // 需要和 verify 版本一致，以确保 verify 可在相同版本的环境中执行
    "verification": {
        "driver": "vm_http",  // 供应商不需要关心，先默认填写 vm_http
        "config": {
          "domain": "xiaohongshu",  // verify 的任务类型，如 xiaohongshu 应用的 verify
          "verfiy_api": "/api/verify/run", // 具体用于 verify 的接口路径，POST，参数为 task_id / session_id
          "params": {
              "task_id":""
              // session_id 是在申请手机实例的运行时产生，算法侧记录 session_id 用于发起对 verfiy_api 的请求 
          }
        }
     }
}