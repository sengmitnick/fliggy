# 验证器实现路线图

## 📋 项目目标

为旅游平台的各个业务模块创建验证器用例，用于训练和验证大模型的操作能力。

**验证器设计原则**：
- ✅ 每个模块创建 **2个验证器用例**
- ✅ 任务复杂度适中：**大模型不能一次性完成**
- ✅ 需要多步操作：搜索 → 筛选 → 对比 → 决策 → 预订
- ✅ 数据量适中：提供足够选择，但不过载

---

## ✅ 已完成模块

### 1. ✈️ 机票模块 (Flights) - 已完成

**数据包**: `app/validators/support/data_packs/v1/flights.rb`
- ✅ 深圳→北京：每天4个航班，最低价¥550（共28个）
- ✅ 上海→深圳：每天2个航班，最低价¥450（共14个）
- ✅ 未来7天数据，共42个航班

**验证器**:
1. ✅ `BookFlightValidator` - 预订后天深圳到北京的低价机票
2. ✅ `SearchCheapestFlightValidator` - 搜索后天上海到深圳的最便宜航班（考虑折扣）

**验证标准**：
- 需要Agent搜索指定日期的航班
- 需要对比多个航班价格
- 需要考虑折扣因素（不是直接看price字段）
- 需要填写乘客信息并完成预订

---

### 2. 🏨 酒店模块 (Hotels) - ✅ 已完成

**数据包**: `app/validators/support/data_packs/v1/hotels.rb`
- ✅ 600家住宿场所（500酒店 + 100民宿）
- ✅ 覆盖10个城市，每城市60家（50酒店 + 10民宿）
- ✅ 酒店星级分布：3星40%, 4星35%, 5星25%
- ✅ 价格区间：3星(200-600元), 4星(400-800元), 5星(800-2000元)
- ✅ 民宿价格：150-400元
- ✅ 数据量：1869个房型，3056条评论

**数据复杂度评估**：
- ✅ 城市维度：10个城市，每城市60家，需要筛选
- ✅ 星级维度：3/4/5星，需要对比
- ✅ 价格维度：¥150-¥2000，需要预算控制
- ✅ 评分维度：3.8-4.9分，需要质量判断
- ✅ 类型维度：酒店 vs 民宿，需要识别

**验证器**：
1. ✅ `BookBudgetHotelValidator` - 预订后天深圳的经济型酒店（预算≤500元）
2. ✅ `SearchHighRatedHotelValidator` - 搜索后天北京评分最高的高档酒店（4星级及以上）

**验证标准**：
- 需要Agent搜索指定城市的酒店（从600家中筛选）
- 需要对比多个酒店价格和评分
- 需要理解"经济型"、"高档"等概念
- 需要填写入住信息并完成预订

**测试结果**：
- ✅ 验证器1：100/100分（选择了深圳市山海居13，价格282元，评分4.9）
- ✅ 验证器2：100/100分（选择了北京市皇冠假日25酒店，4星，评分4.8）

---

## 🎯 待实现模块（按优先级排序）

### 3. 🚄 火车票模块 (Trains) - 待规划

**数据包状态**: ❌ 未创建
**优先级**: 高（核心交通业务）

**数据包设计要点**：
- 创建 `trains.rb`
- 路线：上海→杭州（高铁密集），北京→天津（价格区间大）
- 车次：每条线路5-8个车次（G/D/C不同类型）
- 座位类型：商务座、一等座、二等座（价格差异大）
- 时间段：早中晚分布（6:00-22:00）

**建议的验证器**：
1. `BookEarliestTrainValidator` - 预订明天上海到杭州最早的高铁
2. `SearchCheapestTrainSeatValidator` - 搜索后天北京到天津最便宜的车票（对比不同座位类型）

**复杂度保证**：
- 需要理解"最早"概念（时间排序）
- 需要对比不同车次和座位类型
- 需要考虑价格差异（商务座可能是二等座的3倍）

---

### 4. 🎫 跟团游模块 (Tour Groups) - 待规划

**数据包状态**: ✅ 已有 `tour_group_products.rb`
**优先级**: 中（高客单价业务）

**数据包评估**：
- 需要检查现有数据包是否包含价格、天数、目的地等信息
- 可能需要补充不同价格段的产品

**建议的验证器**：
1. `BookTourPackageValidator` - 预订价格合适的三亚5天4晚跟团游（2人）
2. `SearchBudgetTourValidator` - 搜索预算5000元以内的云南旅游产品

---

### 5. 🚗 租车模块 (Cars) - 待规划

**数据包状态**: ✅ 已有 `cars.rb`
**优先级**: 中

**建议的验证器**：
1. `BookEconomyCarValidator` - 租赁后天深圳的经济型轿车（3天，预算≤200元/天）
2. `SearchFamilyCarValidator` - 搜索成都适合家庭的7座SUV

---

### 6. 🚌 汽车票模块 (Bus Tickets) - 待规划

**数据包状态**: ✅ 已有 `bus_tickets.rb`
**优先级**: 中低

**建议的验证器**：
1. `BookMorningBusValidator` - 预订明天上午广州到深圳的大巴票
2. `SearchFastestBusValidator` - 搜索后天杭州到苏州行程时间最短的班次

---

### 7. 🌍 境外票务模块 (Abroad Tickets) - 待规划

**数据包状态**: ✅ 已有 `abroad_tickets.rb`
**优先级**: 中低

**建议的验证器**：
1. `BookAbroadAttractionValidator` - 预订东京迪士尼乐园门票（2张成人票）
2. `SearchCheapestAttractionValidator` - 搜索大阪最便宜的景点门票

---

### 8. 📡 境外上网模块 (Internet Services) - 待规划

**数据包状态**: ✅ 已有 `internet_services.rb`
**优先级**: 低

**建议的验证器**：
1. `BookSimCardValidator` - 购买日本7天无限流量SIM卡
2. `SearchMultiCountryWifiValidator` - 搜索覆盖5国以上的欧洲WiFi设备

---

## 📊 甲方验收标准

### ✅ 合格标准（大模型不能一次性提供）

验证器必须满足以下条件：

#### 1. 多步骤操作（3-5步）
```
搜索 → 筛选 → 对比 → 决策 → 预订
```
- ❌ 单步操作：直接预订指定ID的产品
- ✅ 多步操作：需要先搜索、再筛选、最后决策

#### 2. 需要决策（多个候选项）
- ❌ 唯一选择：只有1个符合条件的结果
- ✅ 多个候选：3-8个符合条件的结果，需要对比决策

#### 3. 需要理解概念
- ❌ 直接匹配：按字段精确查询（如 `price = 500`）
- ✅ 需要理解：理解"经济型"、"性价比"、"高档"、"最早"等概念

#### 4. 需要计算/排序
- ❌ 简单查询：按单一字段排序
- ✅ 综合评估：需要综合多个维度（价格、评分、时间、距离等）

#### 5. 数据量适中
- ❌ 数据过少：≤2个选项（太简单）
- ❌ 数据过多：≥20个选项（信息过载）
- ✅ 适中数量：5-10个选项（需要筛选但不过载）

#### 6. 相对时间理解
- ❌ 固定日期：2026-01-21
- ✅ 相对日期："后天"、"明天"、"下周"

### ❌ 不合格案例

```ruby
# 案例1：太简单（一步到位）
task: "预订ID为123的酒店"
# 问题：直接指定ID，无需搜索和决策

# 案例2：数据太少（无需对比）
task: "预订深圳的酒店"
data: [深圳希尔顿酒店]  # 只有1家
# 问题：没有选择空间

# 案例3：条件太精确（唯一结果）
task: "预订深圳希尔顿酒店5星级大床房"
# 问题：条件过于具体，只有唯一结果

# 案例4：数据过多（信息过载）
task: "预订深圳的酒店"
data: [深圳50家酒店详情...]  # 一次性展示50家
# 问题：大模型无法处理过多信息
```

---

## 📦 数据包设计原则

### 1. 数据量级
- **目标：** 500-1000 条主要数据（接近真实环境，但不过载）
- **原因：**
  - 太少（<100）：大模型可能直接查询出结果
  - 太多（>10000）：文件过大，平台加载异常
  - 适中（500-1000）：需要筛选但不过载

### 2. data_version 机制
- **data_version: 0** - 数据包生成的基线数据（静态）
- **data_version: 1+** - 验证器运行时生成的数据（动态）
- **验证器查询规则：** 只查询 `data_version: 0` 的数据
- **重要：** 甲方一次性加载所有数据包，不能通过 data_version 隔离

### 3. 动态生成逻辑
- **原则：** 数据包可以使用动态逻辑生成数据
- **约束：** 每次重新生成不能破坏验证器的准确性
- **当前动态因素：**
  - `Date.current + 2.days` - 相对日期（后天）
  - `rand()` - 随机价格、评分（在区间内）
- **禁止：** 不能像 flights 那样用时间范围生成几万条

### 4. 数据分布设计
- **城市分布：** 10个主要城市，每城市60家酒店
- **价格区间：** 3个档次（3星/4星/5星），每档有重叠
- **评分分布：** 根据星级设置范围，保证有明显差异
- **特征值：** 确保每个场景有 3-5 个符合条件的选项

### 5. 一个模块一个文件
- **原则：** 每个业务模块只有一个数据包文件
- **禁止：** 不创建 `xxx_simple.rb` 或 `xxx_v2.rb` 等多个版本
- **原因：** 避免管理混乱，甲方一次性加载所有文件

---

## 🔄 实施进度

### 已完成（8/8）
- [x] ✈️ 机票模块 (Flights)
  - 数据包：`flights.rb`
  - 验证器：`book_flight_validator.rb`, `search_cheapest_flight_validator.rb`
- [x] 🏨 酒店模块 (Hotels)
  - 数据包：`hotels.rb`
  - 验证器：`book_budget_hotel_validator.rb`, `search_high_rated_hotel_validator.rb`
- [x] 🚄 火车票模块 (Trains)
  - 数据包：`trains.rb`
  - 验证器：`book_earliest_train_validator.rb`, `search_cheapest_train_seat_validator.rb`
- [x] 🎫 跟团游模块 (Tour Groups)
  - 数据包：`tour_group_products.rb`
  - 验证器：`book_tour_package_validator.rb`, `search_budget_tour_validator.rb`
- [x] 🚗 租车模块 (Cars)
  - 数据包：`cars.rb`
  - 验证器：`book_economy_car_validator.rb`, `search_family_car_validator.rb`
- [x] 🚌 汽车票模块 (Bus Tickets)
  - 数据包：`bus_tickets.rb`
  - 验证器：`book_morning_bus_validator.rb`, `search_fastest_bus_validator.rb`
- [x] 🌍 境外票务模块 (Abroad Tickets)
  - 数据包：`abroad_tickets.rb`
  - 验证器：`book_japan_train_morning_validator.rb`, `search_cheapest_europe_train_validator.rb`
- [x] 📡 境外上网模块 (Internet Services)
  - 数据包：`internet_services.rb`
  - 验证器：`book_japan_sim_card_validator.rb`, `search_multi_country_wifi_validator.rb`

### 待实施（0/8）
⚠️ **所有模块已完成！**

---

## 📝 注意事项

1. **数据包加载**：甲方会一次性加载所有 `v1/` 目录下的数据包
2. **data_version**：所有数据包生成的数据都用 `data_version: 0`
3. **文件唯一性**：每个模块只有一个数据包文件，避免重复
4. **验证器测试**：每个验证器必须通过 simulate → verify 测试，确保100/100分
5. **相对日期**：验证器使用"后天"、"明天"等相对日期，数据包不需要生成日期范围
