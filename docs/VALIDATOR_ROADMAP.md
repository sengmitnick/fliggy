# 验证器实现路线图

## 📋 项目目标

为旅游平台的各个业务模块创建验证器用例，用于训练和验证大模型的操作能力。

**验证器设计原则**：
- ✅ 每个模块创建 **2个验证器用例**
- ✅ 任务复杂度适中：**大模型不能一次性完成**
- ✅ 需要多步操作：搜索 → 筛选 → 对比 → 决策 → 预订
- ✅ 数据量适中：提供足够选择，但不过载

---

## ✅ 已完成模块

### 1. ✈️ 机票模块 (Flights) - 已完成

**数据包**: `app/validators/support/data_packs/v1/flights.rb`
- ✅ 深圳→北京：每天4个航班，最低价¥550（共28个）
- ✅ 上海→深圳：每天2个航班，最低价¥450（共14个）
- ✅ 未来7天数据，共42个航班

**验证器**:
1. ✅ `BookFlightValidator` - 预订后天深圳到北京的低价机票
2. ✅ `SearchCheapestFlightValidator` - 搜索后天上海到深圳的最便宜航班（考虑折扣）

**验证标准**：
- 需要Agent搜索指定日期的航班
- 需要对比多个航班价格
- 需要考虑折扣因素（不是直接看price字段）
- 需要填写乘客信息并完成预订

---

## 🎯 待实现模块（按优先级排序）

### 2. 🏨 酒店模块 (Hotels) - 当前任务

**数据包状态**: ✅ 已完善
- `app/validators/support/data_packs/v1/hotels.rb`
- 50家酒店（3-5星级，价格¥200-¥2000）
- 5家民宿（价格¥150-¥350）
- 覆盖10个城市：深圳、上海、北京、广州、杭州、成都、西安、南京、武汉、重庆

**数据复杂度评估**：
- ✅ 城市维度：10个城市，需要筛选
- ✅ 星级维度：3/4/5星，需要对比
- ✅ 价格维度：¥150-¥2000，需要预算控制
- ✅ 评分维度：4.0-5.0分，需要质量判断
- ✅ 类型维度：酒店 vs 民宿，需要识别
- ⚠️ **问题**：只有单一日期的数据（data_version: 1），无法测试"后天"等日期选择

**数据包优化方案**：
1. **不修改现有hotels.rb**（已经生成50+5个酒店）
2. **创建精简数据包** `hotels_simple.rb`：
   - 只生成验证器需要的城市（深圳、北京）
   - 每个城市3-5家酒店即可（总计8-10家）
   - 包含不同星级和价格段
   - 使用 `data_version: 0`（基线数据）

**建议的验证器**：

#### 验证器 2.1: `BookBudgetHotelValidator` ⭐
- **任务**：预订后天深圳的经济型酒店（预算≤500元）
- **复杂度分析**：
  - ✅ 需要搜索"深圳"城市的酒店（10个城市中筛选）
  - ✅ 需要选择"后天"日期（需要理解相对日期）
  - ✅ 需要对比价格（5-8家深圳酒店，找到≤500元的）
  - ✅ 需要在多个符合条件的酒店中选择性价比最高的
  - ✅ 需要填写入住信息（房型、天数）
  - ❌ **不能一次性提供**：需要先搜索→筛选价格→对比评分→预订
- **评分标准**：
  - 订单已创建 (20分)
  - 城市正确（深圳市）(15分)
  - 入住日期正确（后天）(15分)
  - 价格符合预算（≤500元/晚）(30分)
  - 选择了性价比最高的酒店（综合价格和评分）(20分)

#### 验证器 2.2: `SearchHighRatedHotelValidator` ⭐⭐
- **任务**：搜索后天北京评分最高的高档酒店（4星级及以上）
- **复杂度分析**：
  - ✅ 需要搜索"北京"城市（10个城市中筛选）
  - ✅ 需要筛选星级（≥4星）
  - ✅ 需要对比评分（4.0-5.0分范围）
  - ✅ 需要找到评分最高的（可能有多个4.9分，需要对比价格）
  - ✅ 需要完成预订流程
  - ❌ **不能一次性提供**：需要搜索→筛选星级→对比评分→确认最高分→预订
- **评分标准**：
  - 订单已创建 (20分)
  - 城市正确（北京市）(15分)
  - 星级符合（≥4星）(15分)
  - 选择了评分最高的酒店 (35分)
  - 订单信息准确（入住天数、房型）(15分)

**数据包设计要点**：
```ruby
# 深圳酒店（5家，用于预算筛选测试）
- 深圳希尔顿酒店：5星，¥800/晚，评分4.8
- 深圳喜来登大酒店：4星，¥600/晚，评分4.6
- 深圳如家快捷酒店：3星，¥350/晚，评分4.3  ← 最符合预算且评分最高
- 深圳汉庭酒店：3星，¥280/晚，评分4.1
- 深圳7天连锁酒店：3星，¥220/晚，评分3.9

# 北京酒店（5家，用于评分筛选测试）
- 北京四季酒店：5星，¥1800/晚，评分4.9  ← 评分最高
- 北京丽思卡尔顿酒店：5星，¥1500/晚，评分4.8
- 北京万豪酒店：4星，¥800/晚，评分4.7
- 北京如家快捷酒店：3星，¥350/晚，评分4.2  ← 不符合星级要求
- 北京锦江之星：3星，¥280/晚，评分4.0  ← 不符合星级要求
```

**甲方验收标准检查**：
- ✅ **不能一次性完成**：需要3-5步操作（搜索→筛选→对比→预订）
- ✅ **数据量适中**：每个城市5家酒店，总计10家（不会过载）
- ✅ **需要决策**：多个候选项，需要综合评估（价格 vs 评分 vs 星级）
- ✅ **考验理解能力**：需要理解"经济型"、"高档"、"性价比"等概念
- ✅ **需要计算**：价格对比、评分排序

---

### 3. 🚄 火车票模块 (Trains) - 待规划

**数据包状态**: ❌ 未创建
**优先级**: 高（核心交通业务）

**数据包设计要点**：
- 创建 `trains.rb`
- 路线：上海→杭州（高铁密集），北京→天津（价格区间大）
- 车次：每条线路5-8个车次（G/D/C不同类型）
- 座位类型：商务座、一等座、二等座（价格差异大）
- 时间段：早中晚分布（6:00-22:00）

**建议的验证器**：
1. `BookEarliestTrainValidator` - 预订明天上海到杭州最早的高铁
2. `SearchCheapestTrainSeatValidator` - 搜索后天北京到天津最便宜的车票（对比不同座位类型）

**复杂度保证**：
- 需要理解"最早"概念（时间排序）
- 需要对比不同车次和座位类型
- 需要考虑价格差异（商务座可能是二等座的3倍）

---

### 4. 🎫 跟团游模块 (Tour Groups) - 待规划

**数据包状态**: ✅ 已有 `tour_group_products.rb`
**优先级**: 中（高客单价业务）

**数据包评估**：
- 需要检查现有数据包是否包含价格、天数、目的地等信息
- 可能需要补充不同价格段的产品

**建议的验证器**：
1. `BookTourPackageValidator` - 预订价格合适的三亚5天4晚跟团游（2人）
2. `SearchBudgetTourValidator` - 搜索预算5000元以内的云南旅游产品

---

### 5. 🚗 租车模块 (Cars) - 待规划

**数据包状态**: ✅ 已有 `cars.rb`
**优先级**: 中

**建议的验证器**：
1. `BookEconomyCarValidator` - 租赁后天深圳的经济型轿车（3天，预算≤200元/天）
2. `SearchFamilyCarValidator` - 搜索成都适合家庭的7座SUV

---

### 6. 🚌 汽车票模块 (Bus Tickets) - 待规划

**数据包状态**: ✅ 已有 `bus_tickets.rb`
**优先级**: 中低

**建议的验证器**：
1. `BookMorningBusValidator` - 预订明天上午广州到深圳的大巴票
2. `SearchFastestBusValidator` - 搜索后天杭州到苏州行程时间最短的班次

---

### 7. 🌍 境外票务模块 (Abroad Tickets) - 待规划

**数据包状态**: ✅ 已有 `abroad_tickets.rb`
**优先级**: 中低

**建议的验证器**：
1. `BookAbroadAttractionValidator` - 预订东京迪士尼乐园门票（2张成人票）
2. `SearchCheapestAttractionValidator` - 搜索大阪最便宜的景点门票

---

### 8. 📡 境外上网模块 (Internet Services) - 待规划

**数据包状态**: ✅ 已有 `internet_services.rb`
**优先级**: 低

**建议的验证器**：
1. `BookSimCardValidator` - 购买日本7天无限流量SIM卡
2. `SearchMultiCountryWifiValidator` - 搜索覆盖5国以上的欧洲WiFi设备

---

## 📊 甲方验收标准

### ✅ 合格标准（大模型不能一次性提供）

验证器必须满足以下条件：

#### 1. 多步骤操作（3-5步）
```
搜索 → 筛选 → 对比 → 决策 → 预订
```
- ❌ 单步操作：直接预订指定ID的产品
- ✅ 多步操作：需要先搜索、再筛选、最后决策

#### 2. 需要决策（多个候选项）
- ❌ 唯一选择：只有1个符合条件的结果
- ✅ 多个候选：3-8个符合条件的结果，需要对比决策

#### 3. 需要理解概念
- ❌ 直接匹配：按字段精确查询（如 `price = 500`）
- ✅ 需要理解：理解"经济型"、"性价比"、"高档"、"最早"等概念

#### 4. 需要计算/排序
- ❌ 简单查询：按单一字段排序
- ✅ 综合评估：需要综合多个维度（价格、评分、时间、距离等）

#### 5. 数据量适中
- ❌ 数据过少：≤2个选项（太简单）
- ❌ 数据过多：≥20个选项（信息过载）
- ✅ 适中数量：5-10个选项（需要筛选但不过载）

#### 6. 相对时间理解
- ❌ 固定日期：2026-01-21
- ✅ 相对日期："后天"、"明天"、"下周"

### ❌ 不合格案例

```ruby
# 案例1：太简单（一步到位）
task: "预订ID为123的酒店"
# 问题：直接指定ID，无需搜索和决策

# 案例2：数据太少（无需对比）
task: "预订深圳的酒店"
data: [深圳希尔顿酒店]  # 只有1家
# 问题：没有选择空间

# 案例3：条件太精确（唯一结果）
task: "预订深圳评分4.8分、价格800元的5星级酒店"
# 问题：条件过于精确，只有1个结果
```

### ✅ 合格案例

```ruby
# 案例1：需要预算决策
task: "预订后天深圳的经济型酒店（预算≤500元）"
data: [
  { name: "深圳希尔顿", price: 800 },      # 超预算
  { name: "深圳如家", price: 350, rating: 4.3 },  # 符合预算，评分高 ✓
  { name: "深圳汉庭", price: 280, rating: 4.1 },  # 符合预算，更便宜
  { name: "深圳7天", price: 220, rating: 3.9 }   # 符合预算，最便宜但评分低
]
# 需要：筛选价格 → 对比评分 → 决策最优（综合性价比）

# 案例2：需要综合评估
task: "搜索北京评分最高的高档酒店（4星级及以上）"
data: [
  { name: "北京四季", star: 5, rating: 4.9, price: 1800 },  # 评分最高 ✓
  { name: "北京丽思", star: 5, rating: 4.8, price: 1500 },  # 评分次高
  { name: "北京万豪", star: 4, rating: 4.7, price: 800 },   # 符合星级
  { name: "北京如家", star: 3, rating: 4.2, price: 350 }    # 不符合星级
]
# 需要：筛选星级 → 对比评分 → 找到最高分
```

---

## 📝 数据包设计规范

### 1. 数据量标准
- **每个验证器涉及的数据**：5-10条记录
- **总数据包大小**：20-50条记录（覆盖多个场景）

### 2. 数据分布原则
- **符合条件的**：3-5条（需要对比决策）
- **不符合条件的**：2-3条（干扰项，测试筛选能力）
- **边界情况**：1-2条（测试边界判断）

### 3. 字段完整性
必须包含验证器需要的所有字段：
- 基础信息：名称、城市、价格
- 筛选字段：星级、评分、类型
- 业务字段：日期、库存、座位数等

### 4. 数据真实性
- 价格范围合理（参考真实市场）
- 评分分布自然（4.0-5.0，集中在4.3-4.8）
- 名称真实（使用真实酒店/车型名称）

---

## 🔄 实现流程

### 每个模块的标准流程：

1. **数据包评估** (30分钟)
   - 检查现有数据包
   - 评估是否需要补充
   - 设计数据结构

2. **数据包实现** (1小时)
   - 创建/修改数据包文件
   - 生成测试数据
   - 验证数据完整性

3. **验证器设计** (30分钟)
   - 确定任务描述
   - 设计评分标准
   - 确认复杂度符合要求

4. **验证器实现** (1.5小时)
   - 编写 prepare 方法
   - 编写 verify 方法
   - 编写 simulate 方法

5. **测试验证** (30分钟)
   - 运行数据包加载
   - 运行验证器测试
   - 确认得分100/100

**单个模块总时间**：约4小时

---

## 📅 实施计划

### 阶段1：酒店模块（当前）
- ✅ 规划文档完成
- 🔄 数据包评估和优化
- 🔄 实现两个验证器
- 🔄 测试验证

### 阶段2-8：其他模块
按优先级顺序逐个完成

---

## 📚 相关文档

- [航班数据修复说明](./FLIGHT_DATA_FIX.md) - 机票模块实现经验
- [验证器设计文档](./VALIDATOR_DESIGN.md) - 验证器架构说明
- [完整功能清单](./COMPLETE_FEATURES.md) - 项目所有功能

---

## 🎯 成功标准

每个验证器必须满足：
- ✅ 通过甲方验收标准（不能一次性完成）
- ✅ 测试得分100/100
- ✅ 数据包大小适中（不过载）
- ✅ 任务描述清晰（包含"后天"等相对时间）
- ✅ 评分标准合理（权重分配合理）

---

**文档版本**: v1.0  
**最后更新**: 2026-01-19  
**负责人**: AI Assistant  
**状态**: 🔄 进行中
