# å¤§æ¨¡å‹è§†è§‰è®­ç»ƒä»»åŠ¡ - èˆªç­é¢„è®¢

> ğŸ’¡ **æ¨èä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·**ï¼šæŸ¥çœ‹ [CLI_VALIDATION_GUIDE.md](CLI_VALIDATION_GUIDE.md) äº†è§£å¦‚ä½•åœ¨ç»ˆç«¯ç›´æ¥éªŒè¯ä»»åŠ¡ã€‚

æœ¬æ–‡æ¡£å®šä¹‰äº†ç”¨äºè®­ç»ƒå¤§æ¨¡å‹è§†è§‰ç†è§£å’Œæ“ä½œèƒ½åŠ›çš„èˆªç­é¢„è®¢ä»»åŠ¡ã€‚å¤§æ¨¡å‹éœ€è¦åƒäººç±»ä¸€æ ·ï¼Œé€šè¿‡è§‚å¯Ÿå±å¹•ã€ç†è§£ç•Œé¢å…ƒç´ ã€ç‚¹å‡»æŒ‰é’®æ¥å®Œæˆé¢„è®¢ä»»åŠ¡ã€‚

---

## ä»»åŠ¡ç›®æ ‡

è®­ç»ƒå¤§æ¨¡å‹å…·å¤‡ä»¥ä¸‹èƒ½åŠ›ï¼š
1. **è§†è§‰ç†è§£**ï¼šè¯†åˆ«ç½‘é¡µä¸Šçš„è¡¨å•ã€æŒ‰é’®ã€å¼¹çª—ç­‰UIå…ƒç´ 
2. **ä»»åŠ¡è§„åˆ’**ï¼šç†è§£ç”¨æˆ·éœ€æ±‚ï¼Œè§„åˆ’å®Œæˆä»»åŠ¡çš„æ­¥éª¤
3. **äº¤äº’æ“ä½œ**ï¼šæ¨¡æ‹Ÿé¼ æ ‡ç‚¹å‡»ã€é”®ç›˜è¾“å…¥ç­‰æ“ä½œ
4. **ç»“æœéªŒè¯**ï¼šç¡®è®¤ä»»åŠ¡æ˜¯å¦æˆåŠŸå®Œæˆ

---

## æ ¸å¿ƒä»»åŠ¡å®šä¹‰

### ä»»åŠ¡ï¼šé¢„è®¢èˆªç­æœºç¥¨

**ç”¨æˆ·æŒ‡ä»¤ç¤ºä¾‹**ï¼š
```
å¸®æˆ‘è®¢ä¸€å¼ ä»æ·±åœ³åˆ°æ­¦æ±‰çš„æœºç¥¨ï¼Œ1æœˆ15æ—¥å‡ºå‘
```

**ä»»åŠ¡è¦æ±‚**ï¼š
å¤§æ¨¡å‹éœ€è¦ï¼š
1. ç†è§£ç”¨æˆ·æ„å›¾ï¼ˆé¢„è®¢æœºç¥¨ã€å‡ºå‘åŸå¸‚ã€åˆ°è¾¾åŸå¸‚ã€æ—¥æœŸï¼‰
2. åœ¨ç½‘é¡µä¸Šæ‰¾åˆ°æœç´¢æ¡†å¹¶è¾“å…¥ä¿¡æ¯
3. ç‚¹å‡»æœç´¢æŒ‰é’®æŸ¥æ‰¾èˆªç­
4. ä»æœç´¢ç»“æœä¸­é€‰æ‹©åˆé€‚çš„èˆªç­
5. å¡«å†™ä¹˜å®¢ä¿¡æ¯è¡¨å•
6. å¤„ç†ä¿é™©æ¨èå¼¹çª—
7. å¤„ç†ä¼šå‘˜æ³¨å†Œå¼¹çª—
8. å®Œæˆæ”¯ä»˜æµç¨‹
9. ç¡®è®¤é¢„è®¢æˆåŠŸ

**æˆåŠŸæ ‡å‡†**ï¼š
```ruby
# æ•°æ®åº“ä¸­æ–°å¢ä¸€æ¡é¢„è®¢è®°å½•
booking = Booking.where(user_id: user_id).order(created_at: :desc).first

# éªŒè¯èˆªç­è·¯çº¿
booking.flight.departure_city == "æ·±åœ³" &&
booking.flight.arrival_city == "æ­¦æ±‰" &&
booking.flight.departure_time.to_date == Date.parse("2025-01-15")

# éªŒè¯é¢„è®¢çŠ¶æ€
booking.status == "paid"  # å·²å®Œæˆæ”¯ä»˜
```

---

## ä»»åŠ¡å˜ä½“

### å˜ä½“ 1ï¼šåŸºç¡€é¢„è®¢ï¼ˆæŒ‡å®šè·¯çº¿å’Œæ—¥æœŸï¼‰

**ç”¨æˆ·æŒ‡ä»¤**ï¼š
```
å¸®æˆ‘è®¢1æœˆ15å·ä»åŒ—äº¬åˆ°ä¸Šæµ·çš„æœºç¥¨
```

**ä»»åŠ¡å‚æ•°**ï¼š
```ruby
{
  departure_city: "åŒ—äº¬",
  arrival_city: "ä¸Šæµ·",
  departure_date: "2025-01-15",  # å¿…å¡«
  should_complete_payment: true
}
```

**æˆåŠŸè¯„ä¼°ä»£ç **ï¼š
```ruby
validator = FlightBookingTaskValidator.new(task_params)
validator.record_initial_state  # è®°å½•åˆå§‹çŠ¶æ€

# å¤§æ¨¡å‹æ‰§è¡Œæ“ä½œ...

result = validator.result
# result[:valid] => true/false
# result[:errors] => ["é”™è¯¯ä¿¡æ¯1", "é”™è¯¯ä¿¡æ¯2", ...]
```

---

### å˜ä½“ 2ï¼šæŒ‡å®šä¹˜å®¢ä¿¡æ¯

**ç”¨æˆ·æŒ‡ä»¤**ï¼š
```
å¸®æˆ‘è®¢1æœˆ20å·ä»ä¸Šæµ·åˆ°åŒ—äº¬çš„æœºç¥¨ï¼Œä¹˜å®¢å§“åå¼ ä¸‰ï¼Œæ‰‹æœºå·13800138000
```

**ä»»åŠ¡å‚æ•°**ï¼š
```ruby
{
  departure_city: "ä¸Šæµ·",
  arrival_city: "åŒ—äº¬",
  departure_date: "2025-01-20",
  passenger_name: "å¼ ä¸‰",
  contact_phone: "13800138000",
  should_complete_payment: true
}
```

---

### å˜ä½“ 3ï¼šæŒ‡å®šä¿é™©éœ€æ±‚

**ç”¨æˆ·æŒ‡ä»¤**ï¼š
```
å¸®æˆ‘è®¢1æœˆ25å·ä»æ·±åœ³åˆ°æ­¦æ±‰çš„æœºç¥¨ï¼Œè¦ä¹°ä¿é™©
```

**ä»»åŠ¡å‚æ•°**ï¼š
```ruby
{
  departure_city: "æ·±åœ³",
  arrival_city: "æ­¦æ±‰",
  departure_date: "2025-01-25",
  insurance_required: true,
  should_complete_payment: true
}
```

---

### å˜ä½“ 4ï¼šåªå¡«è¡¨å•ï¼Œä¸æ”¯ä»˜

**ç”¨æˆ·æŒ‡ä»¤**ï¼š
```
å¸®æˆ‘å¡«å†™1æœˆ30å·ä»æ­å·åˆ°æˆéƒ½çš„æœºç¥¨é¢„è®¢è¡¨å•ï¼Œä¸ç”¨æ”¯ä»˜
```

**ä»»åŠ¡å‚æ•°**ï¼š
```ruby
{
  departure_city: "æ­å·",
  arrival_city: "æˆéƒ½",
  departure_date: "2025-01-30",
  should_complete_payment: false
}
```

**æˆåŠŸæ ‡å‡†**ï¼š
```ruby
booking.status == "pending"  # å¾…æ”¯ä»˜çŠ¶æ€å³å¯
```

---

## ä»»åŠ¡éªŒè¯æµç¨‹

### 1. è®°å½•åˆå§‹çŠ¶æ€

```ruby
validator = FlightBookingTaskValidator.new(
  user_id: 1,
  departure_city: "æ·±åœ³",
  arrival_city: "æ­¦æ±‰",
  departure_date: "2025-01-15",
  should_complete_payment: true
)

# è®°å½•ä»»åŠ¡å¼€å§‹å‰çš„é¢„è®¢æ•°é‡
validator.record_initial_state
```

### 2. å¤§æ¨¡å‹æ‰§è¡Œä»»åŠ¡

å¤§æ¨¡å‹é€šè¿‡è§†è§‰è¯†åˆ«å’Œæ“ä½œå®Œæˆé¢„è®¢æµç¨‹ï¼š
- è§‚å¯Ÿå±å¹•ï¼Œè¯†åˆ«æœç´¢æ¡†
- è¾“å…¥"æ·±åœ³"ã€"æ­¦æ±‰"ã€"2025-01-15"
- ç‚¹å‡»æœç´¢æŒ‰é’®
- è¯†åˆ«èˆªç­åˆ—è¡¨ï¼Œé€‰æ‹©èˆªç­
- å¡«å†™ä¹˜å®¢ä¿¡æ¯è¡¨å•
- å¤„ç†å„ç§å¼¹çª—ï¼ˆä¿é™©ã€ä¼šå‘˜ï¼‰
- å®Œæˆæ”¯ä»˜æµç¨‹

### 3. éªŒè¯ä»»åŠ¡ç»“æœ

```ruby
result = validator.result

if result[:valid]
  puts "âœ… ä»»åŠ¡å®Œæˆï¼šå¤§æ¨¡å‹æˆåŠŸé¢„è®¢äº†ä»æ·±åœ³åˆ°æ­¦æ±‰çš„æœºç¥¨"
else
  puts "âŒ ä»»åŠ¡å¤±è´¥ï¼š"
  result[:errors].each { |error| puts "  - #{error}" }
end
```

---

## éªŒè¯è§„åˆ™è¯´æ˜

### è§„åˆ™ 1ï¼šæ–°é¢„è®¢è®°å½•

éªŒè¯æ˜¯å¦åˆ›å»ºäº†æ–°çš„é¢„è®¢è®°å½•ï¼š
```ruby
# å½“å‰é¢„è®¢æ•°é‡ > åˆå§‹é¢„è®¢æ•°é‡
Booking.where(user_id: user_id).count > initial_count
```

### è§„åˆ™ 2ï¼šèˆªç­è·¯çº¿åŒ¹é…

éªŒè¯é¢„è®¢çš„èˆªç­æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼š
```ruby
booking.flight.departure_city == task_params[:departure_city] &&
booking.flight.arrival_city == task_params[:arrival_city]
```

### è§„åˆ™ 3ï¼šæ—¥æœŸåŒ¹é…ï¼ˆå¿…å¡«ï¼‰

```ruby
# æ—¥æœŸæ˜¯å¿…å¡«å‚æ•°
task_params[:departure_date].present? &&
booking.flight.departure_time.to_date == Date.parse(task_params[:departure_date])
```

### è§„åˆ™ 4ï¼šä¹˜å®¢ä¿¡æ¯åŒ¹é…ï¼ˆå¦‚æœæŒ‡å®šï¼‰

```ruby
if task_params[:passenger_name]
  booking.passenger_name == task_params[:passenger_name]
end

if task_params[:contact_phone]
  booking.contact_phone == task_params[:contact_phone]
end
```

### è§„åˆ™ 5ï¼šä¿é™©é€‰æ‹©åŒ¹é…ï¼ˆå¦‚æœæŒ‡å®šï¼‰

```ruby
if task_params[:insurance_required] == true
  booking.insurance_type != "æ— ä¿éšœ"  # å¿…é¡»è´­ä¹°ä¿é™©
elsif task_params[:insurance_required] == false
  booking.insurance_type == "æ— ä¿éšœ"  # ä¸èƒ½è´­ä¹°ä¿é™©
end
```

### è§„åˆ™ 6ï¼šæ”¯ä»˜çŠ¶æ€åŒ¹é…

```ruby
if task_params[:should_complete_payment] == true
  booking.status == "paid"  # å¿…é¡»å®Œæˆæ”¯ä»˜
else
  booking.status == "pending"  # å¯ä»¥ä¸æ”¯ä»˜
end
```

---

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šå®Œæ•´é¢„è®¢æµç¨‹

```ruby
# å®šä¹‰ä»»åŠ¡
task = {
  user_id: 1,
  departure_city: "æ·±åœ³",
  arrival_city: "æ­¦æ±‰",
  departure_date: "2025-01-15",
  passenger_name: "å¼ ä¸‰",
  contact_phone: "13800138000",
  insurance_required: true,
  should_complete_payment: true
}

# åˆ›å»ºéªŒè¯å™¨å¹¶è®°å½•åˆå§‹çŠ¶æ€
validator = FlightBookingTaskValidator.new(task)
validator.record_initial_state

# === å¤§æ¨¡å‹åœ¨æ­¤æ‰§è¡Œä»»åŠ¡ ===
# 1. è§†è§‰è¯†åˆ«é¡µé¢å…ƒç´ 
# 2. å¡«å†™æœç´¢è¡¨å•
# 3. é€‰æ‹©èˆªç­
# 4. å¡«å†™ä¹˜å®¢ä¿¡æ¯
# 5. è´­ä¹°ä¿é™©
# 6. å®Œæˆæ”¯ä»˜

# éªŒè¯ç»“æœ
result = validator.result

puts "ä»»åŠ¡éªŒè¯ç»“æœï¼š"
puts "é€šè¿‡ï¼š#{result[:valid]}"
if result[:errors].any?
  puts "é”™è¯¯ï¼š"
  result[:errors].each { |error| puts "  - #{error}" }
end
```

### ç¤ºä¾‹ 2ï¼šæ‰¹é‡ä»»åŠ¡æµ‹è¯•

```ruby
# å®šä¹‰å¤šä¸ªæµ‹è¯•ä»»åŠ¡
tasks = [
  {
    name: "æ·±åœ³åˆ°æ­¦æ±‰",
    params: { departure_city: "æ·±åœ³", arrival_city: "æ­¦æ±‰" }
  },
  {
    name: "åŒ—äº¬åˆ°ä¸Šæµ·ï¼ˆæŒ‡å®šæ—¥æœŸï¼‰",
    params: { departure_city: "åŒ—äº¬", arrival_city: "ä¸Šæµ·", departure_date: "2025-01-20" }
  },
  {
    name: "å¹¿å·åˆ°æ·±åœ³ï¼ˆéœ€è¦ä¿é™©ï¼‰",
    params: { departure_city: "å¹¿å·", arrival_city: "æ·±åœ³", insurance_required: true }
  }
]

# ä¾æ¬¡æ‰§è¡Œå¹¶éªŒè¯
results = []
tasks.each do |task|
  validator = FlightBookingTaskValidator.new(task[:params].merge(user_id: 1, should_complete_payment: true))
  validator.record_initial_state
  
  # å¤§æ¨¡å‹æ‰§è¡Œ...
  
  result = validator.result
  results << {
    task_name: task[:name],
    valid: result[:valid],
    errors: result[:errors]
  }
end

# æ‰“å°æ±‡æ€»
puts "\nä»»åŠ¡å®Œæˆç»Ÿè®¡ï¼š"
puts "æ€»ä»»åŠ¡æ•°ï¼š#{results.count}"
puts "æˆåŠŸï¼š#{results.count { |r| r[:valid] }}"
puts "å¤±è´¥ï¼š#{results.count { |r| !r[:valid] }}"
```

---

## ä¸ AndroidWorld çš„å¯¹æ¯”

| ç‰¹æ€§ | AndroidWorld | æœ¬é¡¹ç›®ï¼ˆèˆªç­é¢„è®¢ï¼‰ |
|------|-------------|-------------------|
| **ç›®æ ‡** | è®­ç»ƒæ¨¡å‹æ“ä½œ Android åº”ç”¨ | è®­ç»ƒæ¨¡å‹æ“ä½œ Web åº”ç”¨ |
| **äº¤äº’æ–¹å¼** | è§¦æ‘¸ã€æ»‘åŠ¨ã€è¾“å…¥æ–‡å­— | é¼ æ ‡ç‚¹å‡»ã€é”®ç›˜è¾“å…¥ |
| **ä»»åŠ¡ç²’åº¦** | å•ä¸ªæ“ä½œï¼ˆå¦‚åˆ›å»ºæ’­æ”¾åˆ—è¡¨ï¼‰ | å®Œæ•´ä¸šåŠ¡æµç¨‹ï¼ˆé¢„è®¢æœºç¥¨ï¼‰ |
| **éªŒè¯æ–¹å¼** | æ£€æŸ¥åº”ç”¨å†…çŠ¶æ€ | æ£€æŸ¥æ•°æ®åº“è®°å½• |
| **å™ªéŸ³æ•°æ®** | æ— å…³æ–‡ä»¶ã€è”ç³»äººç­‰ | å…¶ä»–ç”¨æˆ·çš„é¢„è®¢è®°å½• |

---

## å™ªéŸ³æ•°æ®è®¾è®¡

ä¸ºäº†æµ‹è¯•æ¨¡å‹çš„é²æ£’æ€§ï¼Œåº”åœ¨æ•°æ®åº“ä¸­æ·»åŠ "å™ªéŸ³"æ•°æ®ï¼š

```ruby
# æ·»åŠ å…¶ä»–è·¯çº¿çš„èˆªç­ï¼ˆä¸åº”è¢«é€‰æ‹©ï¼‰
Flight.create!(
  departure_city: "åŒ—äº¬",
  arrival_city: "ä¸Šæµ·",
  departure_time: "2025-01-15 10:00",
  price: 500
)

# æ·»åŠ å…¶ä»–ç”¨æˆ·çš„é¢„è®¢ï¼ˆä¸åº”å½±å“éªŒè¯ï¼‰
Booking.create!(
  user_id: 999,  # ä¸åŒçš„ç”¨æˆ·
  flight_id: some_flight.id,
  passenger_name: "æå››",
  status: :paid
)

# æ·»åŠ å½“å‰ç”¨æˆ·çš„å†å²é¢„è®¢ï¼ˆä¸åº”è¢«è®¡å…¥æ–°é¢„è®¢ï¼‰
Booking.create!(
  user_id: 1,  # å½“å‰ç”¨æˆ·
  flight_id: another_flight.id,
  created_at: 1.day.ago,  # æ—©äºä»»åŠ¡å¼€å§‹æ—¶é—´
  status: :completed
)
```

éªŒè¯å™¨åªä¼šæ£€æŸ¥**ä»»åŠ¡å¼€å§‹åæ–°åˆ›å»ºçš„**ã€**å±äºæŒ‡å®šç”¨æˆ·çš„**é¢„è®¢è®°å½•ã€‚

---

## æ‰©å±•æ–¹å‘

1. **å¤šæ­¥éª¤ä»»åŠ¡**ï¼šå…ˆæœç´¢ã€å†é¢„è®¢ã€æœ€åä¿®æ”¹è®¢å•
2. **å¼‚å¸¸å¤„ç†**ï¼šèˆªç­å·²æ»¡ã€æ”¯ä»˜å¤±è´¥ç­‰åœºæ™¯
3. **å¤šç”¨æˆ·åœºæ™¯**ï¼šåŒæ—¶ä¸ºå¤šä¸ªç”¨æˆ·é¢„è®¢
4. **æ—¶é—´çº¦æŸ**ï¼šé™å®šå®Œæˆä»»åŠ¡çš„æ—¶é—´
5. **å¤æ‚æ¡ä»¶**ï¼šç»æµèˆ±ã€ä¸­è½¬ã€ç‰¹å®šæ—¶é—´æ®µç­‰

---

## æ€»ç»“

æœ¬éªŒè¯æ¡†æ¶çš„æ ¸å¿ƒæ€æƒ³ï¼š

1. âœ… **ä»»åŠ¡å¯¼å‘**ï¼šç»™å¤§æ¨¡å‹ä¸€ä¸ªæ˜ç¡®çš„ä»»åŠ¡ç›®æ ‡
2. âœ… **ç»“æœéªŒè¯**ï¼šåªæ£€æŸ¥æœ€ç»ˆæ•°æ®åº“çŠ¶æ€ï¼Œä¸å…³å¿ƒä¸­é—´æ­¥éª¤
3. âœ… **ç®€å•æ˜äº†**ï¼šä¸€ä¸ªä»»åŠ¡ = ä¸€ä¸ªç›®æ ‡ = ä¸€ä¸ªéªŒè¯è§„åˆ™
4. âœ… **å¯æ‰©å±•**ï¼šè½»æ¾æ·»åŠ æ–°çš„ä»»åŠ¡å˜ä½“å’ŒéªŒè¯è§„åˆ™

å¤§æ¨¡å‹éœ€è¦è‡ªå·±ç†è§£UIã€è§„åˆ’æ­¥éª¤ã€å¤„ç†å¼‚å¸¸ï¼Œæœ€ç»ˆåªè¦æ•°æ®åº“é‡Œæœ‰æ­£ç¡®çš„é¢„è®¢è®°å½•ï¼Œå°±ç®—ä»»åŠ¡æˆåŠŸã€‚
