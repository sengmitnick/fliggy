# 🔄 正确使用流程说明

## ⚠️ 重要：理解验证时机

验证工具的目的是**在任务执行前后对比**，检查是否创建了新的预订记录。

---

## ✅ 正确流程

### 场景 A：先启动验证，再执行任务

```bash
# 1. 启动验证（记录初始状态）
rake vision:validate \
  departure_city=郑州 \
  arrival_city=广州 \
  departure_date=2025-12-29

# 2. 看到提示后，执行任务
# ⏸️  现在可以执行任务（手动操作或运行大模型）
# 按 Enter 键继续验证...

# 3. 此时去浏览器完成预订流程：
#    - 搜索航班
#    - 选择航班
#    - 填写表单
#    - 支付

# 4. 完成后回到终端，按 Enter

# 5. 查看验证结果
# ✅ 验证通过！（如果创建了新记录）
```

**为什么这样做**：
- 验证器在步骤1记录了初始状态（例如：17条预订记录）
- 步骤3创建了新记录（变成18条）
- 步骤4验证时发现新增了1条，验证通过 ✅

---

### 场景 B：任务已完成，现在验证（会失败）

```bash
# 情况：你已经完成了预订，现在想验证

# 1. 启动验证
rake vision:validate \
  departure_city=郑州 \
  arrival_city=广州 \
  departure_date=2025-12-29

# 2. 验证器记录初始状态（18条记录，包括你刚才创建的）
# 📊 正在记录初始状态...

# 3. 按 Enter 验证
# （没有执行新的预订）

# 4. 结果：失败 ❌
# 错误：未创建新的预订记录
```

**为什么失败**：
- 记录初始状态时，预订已经存在（18条）
- 验证时还是18条，没有新增
- 验证器认为任务未完成 ❌

---

## 🎯 针对你的截图场景

### 你的情况分析

根据你提供的截图：
- ✅ 支付成功
- ✅ 航班：郑州 → 广州
- ✅ 日期：12月29日
- ✅ 状态：已成功出票

**数据库中已有记录**：
```
ID: 18
Flight: 郑州 -> 广州
Date: 2025-12-29
Status: paid
```

### 解决方案：使用"回顾验证"模式

如果你想验证已完成的预订，有两种方法：

#### 方法 1：手动检查数据库

```bash
# 查看最新预订
rails runner "b = Booking.last; puts \"ID: #{b.id}\"; puts \"Flight: #{b.flight.departure_city} -> #{b.flight.destination_city}\"; puts \"Date: #{b.flight.departure_time.to_date}\"; puts \"Status: #{b.status}\""
```

**输出**：
```
ID: 18
Flight: 郑州 -> 广州
Date: 2025-12-29
Status: paid
```

#### 方法 2：删除记录后重新验证（仅用于测试）

```bash
# ⚠️ 警告：这会删除记录，仅用于测试！

# 1. 删除最后一条预订
rails runner "Booking.last.destroy"

# 2. 现在启动验证
rake vision:validate departure_city=郑州 arrival_city=广州 departure_date=2025-12-29

# 3. 重新完成预订流程

# 4. 按 Enter 验证
# ✅ 验证通过
```

---

## 📊 使用场景对比

### ✅ 适合使用验证工具的场景

| 场景 | 说明 | 流程 |
|------|------|------|
| **训练大模型** | 让模型自动完成预订 | 启动验证 → 模型执行 → 验证结果 |
| **测试新功能** | 测试预订流程是否正常 | 启动验证 → 手动操作 → 验证结果 |
| **回归测试** | 批量测试多个路线 | 脚本循环：启动验证 → 执行 → 验证 |
| **开发调试** | 验证代码修改是否正确 | 启动验证 → 触发操作 → 验证 |

### ❌ 不适合的场景

| 场景 | 原因 | 替代方案 |
|------|------|----------|
| **验证历史记录** | 记录已存在，无法检测"新增" | 使用 `rails runner` 查询数据库 |
| **只想看预订详情** | 验证工具用于检查完成情况 | 直接查询数据库或查看页面 |
| **预订已完成再验证** | 验证器会认为没有新增记录 | 删除记录后重新测试 |

---

## 🎬 完整演示：正确流程

### 演示任务：订12月30号从深圳到武汉的机票

```bash
# ============================================
# 步骤 1：检查当前状态（可选）
# ============================================
rails runner "puts 'Current bookings: ' + Booking.where(user_id: 1).count.to_s"
# 输出：Current bookings: 18

# ============================================
# 步骤 2：启动验证
# ============================================
rake vision:validate \
  departure_city=深圳 \
  arrival_city=武汉 \
  departure_date=2025-12-30

# 输出：
# 📋 机票预订任务验证
# 🗣️  用户指令："帮我订12月30号从深圳到武汉的机票"
# 📊 正在记录初始状态...
# ✅ 初始状态已记录（18条记录）
# ⏸️  现在可以执行任务（手动操作或运行大模型）
# 按 Enter 键继续验证...

# ============================================
# 步骤 3：执行任务
# ============================================
# 此时去浏览器：
# 1. 访问 http://localhost:3000
# 2. 搜索：深圳 → 武汉，12月30日
# 3. 选择航班
# 4. 填写表单
# 5. 完成支付
# 6. 看到"支付成功"页面

# ============================================
# 步骤 4：回到终端，按 Enter
# ============================================
# [按 Enter 键]

# ============================================
# 步骤 5：查看结果
# ============================================
# 🔍 正在验证任务结果...
#
# ✅ 验证通过！任务成功完成
#
# 📦 预订详情：
#    预订ID: 19
#    航班号: CZ3456
#    路线: 深圳 → 武汉
#    日期: 2025年12月30日
#    乘客: 张三
#    状态: 已支付
```

---

## 🚨 常见错误和解决方法

### 错误 1："未创建新的预订记录"

**原因**：
- 在启动验证前就已经完成了预订
- 或者没有成功创建新记录

**解决方法**：
```bash
# 方法 A：重新测试（删除后重做）
rails runner "Booking.last.destroy"
# 然后重新运行验证流程

# 方法 B：检查是否真的创建了记录
rails runner "puts Booking.last.inspect"
```

### 错误 2："出发城市不匹配"

**原因**：
- 数据库存储的城市名称与参数不同
- 例如："郑州机场" vs "郑州"

**解决方法**：
```bash
# 查看实际的城市名称
rails runner "puts Flight.last.departure_city"

# 使用实际名称
rake vision:validate departure_city=实际名称 ...
```

### 错误 3："日期不匹配"

**原因**：
- 选择了错误的日期
- 或者日期格式不对

**解决方法**：
```bash
# 确保日期格式正确：YYYY-MM-DD
rake vision:validate ... departure_date=2025-12-30

# 检查数据库中的日期
rails runner "puts Booking.last.flight.departure_time.to_date"
```

---

## 💡 最佳实践

### 1. 开发测试时

```bash
# 每次测试前清理
rails runner "Booking.where(user_id: 1).destroy_all"

# 运行验证
rake vision:validate ...

# 执行操作

# 验证结果
```

### 2. 训练大模型时

```bash
# 创建测试脚本
#!/bin/bash
for i in {1..10}; do
  echo "=== Test $i ==="
  
  # 启动验证
  rake vision:validate departure_city=深圳 arrival_city=武汉 departure_date=2025-12-30
  
  # 模型执行
  python run_vision_model.py "帮我订12月30号从深圳到武汉的机票"
  
  # 等待完成
  sleep 5
  
  # 验证（自动按 Enter）
  echo "" | rake vision:validate ...
done
```

### 3. 批量测试时

```bash
# 测试多个路线
tasks=(
  "departure_city=深圳 arrival_city=武汉 departure_date=2025-12-30"
  "departure_city=北京 arrival_city=上海 departure_date=2025-12-31"
  "departure_city=广州 arrival_city=深圳 departure_date=2026-01-01"
)

for task in "${tasks[@]}"; do
  echo "Testing: $task"
  rake vision:validate $task
  # ... 执行操作 ...
done
```

---

## 📚 相关文档

- [快速开始示例](QUICK_START_EXAMPLE.md) - 真实场景演示
- [命令行工具指南](CLI_VALIDATION_GUIDE.md) - 完整参数说明
- [故障排除](QUICK_START_EXAMPLE.md#故障排除) - 常见问题解决

---

## 🎯 总结

**关键要点**：

1. ✅ **验证工具检查的是"新增"记录**，不是"已存在"的记录
2. ✅ **正确流程**：启动验证 → 执行任务 → 按Enter验证
3. ✅ **已完成的预订**：无法用验证工具验证，直接查询数据库
4. ✅ **测试时**：每次测试前清理或删除旧记录

**快速检查清单**：

- [ ] 是否在执行任务前启动验证？
- [ ] 是否看到"初始状态已记录"提示？
- [ ] 是否完成了完整的预订流程？
- [ ] 是否看到"支付成功"页面？
- [ ] 是否在完成后才按 Enter 验证？

---

**现在你明白了吗？** 

下次使用时，记得：
1. **先**启动验证
2. **再**执行预订
3. **最后**按 Enter 验证

这样就能看到 ✅ 验证通过了！🎉
