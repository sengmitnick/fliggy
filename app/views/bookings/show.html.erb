<div class="min-h-screen bg-gray-100 pb-20" data-controller="payment">
  <!-- Header -->
  <div class="bg-white border-b">
    <div class="container mx-auto px-4 py-4 flex items-center">
      <%= link_to flights_path, class: "text-2xl mr-4" do %>
        â†
      <% end %>
      <div class="flex-1 flex items-center space-x-4">
        <span class="text-gray-400">å¡«è®¢å•</span>
        <span class="text-gray-400">â€”</span>
        <span class="text-lg font-bold">é€‰æœåŠ¡</span>
        <span class="text-gray-400">â€”</span>
        <span class="text-gray-400">å»æ”¯ä»˜</span>
      </div>
    </div>
  </div>

  <!-- Order Info Summary -->
  <div class="container mx-auto px-4 py-3">
    <div class="flex items-center justify-between text-sm">
      <span class="text-gray-600">å•ç¨‹ | <%= @flight.departure_city %> â†’ <%= @flight.destination_city %> Â· <%= @flight.departure_time.strftime('%-mæœˆ%-dæ—¥') %></span>
      <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
      </svg>
    </div>
  </div>

  <!-- Insurance Selection (å®‰å¿ƒæ—…é€”æ¨è) -->
  <div class="bg-white mb-4">
    <div class="container mx-auto px-4 py-4">
      <h3 class="text-lg font-bold mb-2">å®‰å¿ƒæ—…é€”æ¨è</h3>
      <div class="text-sm text-blue-600 mb-4">
        æ·»åŠ ä¿éšœ <span class="text-gray-900 font-medium">å‡ºè¡Œæœ‰å¤‡æ— æ‚£</span>
      </div>

      <!-- Insurance Options -->
      <div class="grid grid-cols-3 gap-3">
        <!-- ä¸æ¨è - æ™®é€šå‡ºè¡Œ -->
        <div class="border-2 rounded-lg p-3 text-center">
          <div class="text-xs text-gray-500 mb-1">ä¸æ¨è</div>
          <div class="font-bold mb-2">æ™®é€šå‡ºè¡Œ</div>
          <div class="text-red-500 text-xl mb-2">Ã—</div>
          <div class="text-xs text-gray-500">ä¸å«æœºé…’åˆ¸</div>
          <div class="text-red-500 text-xl">Ã—</div>
          <div class="text-xs text-gray-500 mb-2">æ— å‡ºè¡Œä¿é™©</div>
        </div>

        <!-- æ€§ä»·æ¯”ä¼˜é€‰ - çœå¿ƒå‡ºè¡Œ -->
        <div class="border-2 border-purple-400 bg-purple-50 rounded-lg p-3 text-center relative">
          <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 bg-purple-400 text-white text-xs px-3 py-0.5 rounded-full">
            æ€§ä»·æ¯”ä¼˜é€‰
          </div>
          <div class="font-bold mt-2 mb-2">çœå¿ƒå‡ºè¡Œ</div>
          <div class="text-green-500 text-xl mb-1">âœ“</div>
          <div class="text-xs text-gray-600 mb-1">ä½æƒç›Š</div>
          <div class="text-yellow-500 text-xl mb-1">âš¡</div>
          <div class="text-xs text-gray-600 mb-2">3ç¤¼é‡</div>
          <div class="flex items-center justify-center gap-1">
            <span class="text-xs text-gray-400 line-through">Â¥82</span>
            <span class="text-red-500 font-bold">Â¥42</span>
          </div>
        </div>

        <!-- çƒ­å–æ¨è - å¿«ä¹å‡ºè¡Œ -->
        <div class="border-2 border-orange-400 bg-orange-50 rounded-lg p-3 text-center relative">
          <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 bg-orange-400 text-white text-xs px-3 py-0.5 rounded-full">
            çƒ­å–æ¨è
          </div>
          <div class="font-bold mt-2 mb-2">å¿«ä¹å‡ºè¡Œ</div>
          <div class="text-green-500 text-xl mb-1">âœ“</div>
          <div class="text-xs text-gray-600 mb-1">è§†é¢‘ä¼šå‘˜6...</div>
          <div class="text-green-500 text-xl mb-1">âœ“</div>
          <div class="text-xs text-gray-600 mb-2">èµ é£ä¹ˆä¹ˆå¹²</div>
          <div class="flex items-center justify-center gap-1">
            <span class="text-xs text-gray-400 line-through">Â¥94</span>
            <span class="text-red-500 font-bold">Â¥46</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Selected Passengers -->
  <div class="container mx-auto px-4 mb-4">
    <div class="bg-white rounded-lg shadow p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-bold">å·²é€‰æ‹©: 1æˆäºº</h3>
        <%= link_to 'é‚€è¯·å¥½å‹å¡«å†™', '#', class: "text-blue-500 text-sm" %>
      </div>
    </div>
  </div>

  <!-- Booking Order -->
  <div class="container mx-auto px-4 mb-20">
    <div class="bg-white rounded-lg shadow p-4">
      <h3 class="font-bold mb-3">é¢„è®¢è®¢å•</h3>
      
      <!-- Passenger -->
      <div class="flex items-center justify-between py-2 border-b">
        <span class="text-gray-600">ä¹˜æœºäºº</span>
        <span class="font-bold"><%= @booking.passenger_name %></span>
      </div>

      <!-- Ticket Price -->
      <div class="flex items-center justify-between py-2 border-b">
        <span class="text-gray-600">æœºç¥¨</span>
        <span>Â¥<%= (@booking.total_price).to_i %></span>
      </div>

      <!-- Insurance -->
      <% if @booking.insurance_type.present? && @booking.insurance_type != 'none' %>
        <div class="flex items-center justify-between py-2 border-b">
          <span class="text-gray-600">ä¿é™©</span>
          <span>Â¥<%= @booking.insurance_price.to_i %></span>
        </div>
      <% end %>

      <!-- Total -->
      <div class="flex items-center justify-between py-3 font-bold text-lg">
        <span>æ€»è®¡</span>
        <span class="text-red-500">Â¥<%= (@booking.total_price + (@booking.insurance_price || 0)).to_i %></span>
      </div>
    </div>
  </div>

  <!-- Bottom Payment Button -->
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div>
        <div class="text-xs text-gray-500">æ€»è®¡</div>
        <div class="text-xl font-bold text-red-500">Â¥<%= (@booking.total_price + (@booking.insurance_price || 0)).to_i %></div>
      </div>
      <button type="button" 
              data-action="click->payment#showPaymentModal" 
              data-amount="<%= (@booking.total_price + (@booking.insurance_price || 0)).to_i %>"
              data-booking-id="<%= @booking.id %>"
              class="bg-blue-500 text-white px-8 py-3 rounded-lg text-lg font-bold">
        å»æ”¯ä»˜
      </button>
    </div>
  </div>

  <!-- Payment Modal -->
  <div class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-end" data-payment-target="paymentModal">
    <div class="bg-white w-full rounded-t-3xl animate-slide-up" data-payment-target="paymentContent">
      <!-- Close Button -->
      <div class="flex items-center justify-between p-4 border-b">
        <button type="button" data-action="click->payment#closePaymentModal" class="text-gray-400 text-2xl">â†</button>
        <div class="text-sm text-blue-500">ä½¿ç”¨å¯†ç </div>
      </div>

      <!-- Amount -->
      <div class="text-center py-6">
        <div class="text-5xl font-bold">Â¥<span data-payment-target="amount"></span></div>
      </div>

      <!-- Account -->
      <div class="px-4 py-3 border-b">
        <div class="flex items-center justify-between">
          <span class="text-gray-600">è´¦å·</span>
          <span class="text-gray-900"><%= current_user.email %></span>
        </div>
      </div>

      <!-- Payment Method -->
      <div class="px-4 py-3 border-b">
        <div class="flex items-center justify-between">
          <span class="text-gray-600">ä»˜æ¬¾æ–¹å¼</span>
          <div class="flex items-center">
            <span class="text-blue-500 text-xl mr-2">ğŸ’³</span>
            <span class="text-gray-900">èŠ±å‘—</span>
          </div>
        </div>
      </div>

      <!-- Payment Options (Credit/Huabei) -->
      <div class="px-4 py-3 border-b">
        <div class="text-gray-600 mb-2">ä¿¡è´·</div>
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <span class="text-blue-500 text-xl mr-2">ğŸ’³</span>
            <span class="text-gray-900">èŠ±å‘—</span>
          </div>
          <svg class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
          </svg>
        </div>
      </div>

      <!-- View All -->
      <div class="px-4 py-3 text-center">
        <button type="button" class="text-gray-500 text-sm">
          æŸ¥çœ‹å…¨éƒ¨ <span class="ml-1">âˆ¨</span>
        </button>
      </div>

      <!-- Confirm Payment Button -->
      <div class="px-4 pb-6">
        <button type="button" 
                data-action="click->payment#confirmPayment"
                class="w-full bg-blue-500 text-white py-4 rounded-lg text-lg font-bold flex items-center justify-center">
          <span class="animate-spin mr-2 hidden" data-payment-target="spinner">âŸ³</span>
          <span data-payment-target="buttonText">ç¡®è®¤ä»˜æ¬¾</span>
        </button>
        <div class="text-xs text-gray-400 text-center mt-2">
          æœ¬æœåŠ¡ç”±æ”¯ä»˜å®(æ­å·)æ•°å­—æœåŠ¡æŠ€æœ¯æœ‰é™å…¬å¸æä¾›
        </div>
      </div>
    </div>
  </div>

  <!-- Processing Modal (æ­£åœ¨æ ¡éªŒæŒ‡çº¹...) -->
  <div class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-end" data-payment-target="processingModal">
    <div class="bg-white w-full rounded-t-3xl p-6 animate-slide-up">
      <button type="button" data-action="click->payment#closeProcessingModal" class="text-gray-400 text-2xl mb-4">â†</button>
      
      <!-- Amount -->
      <div class="text-center py-6">
        <div class="text-5xl font-bold mb-8">Â¥<span data-payment-target="processingAmount"></span></div>
      </div>

      <!-- Account -->
      <div class="py-3 border-b">
        <div class="flex items-center justify-between">
          <span class="text-gray-600">è´¦å·</span>
          <span class="text-gray-900"><%= current_user.email %></span>
        </div>
      </div>

      <!-- Payment Method -->
      <div class="py-3 mb-8">
        <div class="flex items-center justify-between">
          <span class="text-gray-600">ä»˜æ¬¾æ–¹å¼</span>
          <div class="flex items-center">
            <span class="text-blue-500 text-xl mr-2">ğŸ’³</span>
            <span class="text-gray-900">èŠ±å‘—</span>
          </div>
        </div>
      </div>

      <!-- Verifying Fingerprint -->
      <div class="text-center py-8">
        <div class="text-gray-600 mb-4">è¯·éªŒè¯æŒ‡çº¹</div>
        <div class="inline-block mb-6">
          <svg class="w-20 h-20 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 1C8.676 1 6 3.676 6 7c0 2.515 1.513 4.67 3.676 5.598A8.007 8.007 0 0 0 4 20h2c0-3.309 2.691-6 6-6s6 2.691 6 6h2a8.007 8.007 0 0 0-5.676-7.402C16.487 11.67 18 9.515 18 7c0-3.324-2.676-6-6-6zm0 2c2.243 0 4 1.757 4 4s-1.757 4-4 4-4-1.757-4-4 1.757-4 4-4z"/>
          </svg>
        </div>
        <div class="text-blue-500 text-sm">
          <button type="button" data-action="click->payment#switchToPasswordPay" class="underline">ä½¿ç”¨å¯†ç </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Password Payment Modal (å¯†ç æ”¯ä»˜) -->
  <div class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-end" data-payment-target="passwordModal">
    <div class="bg-white w-full rounded-t-3xl animate-slide-up">
      <div class="flex items-center justify-between p-4 border-b">
        <button type="button" data-action="click->payment#closePasswordModal" class="text-gray-400 text-2xl">Ã—</button>
        <div class="text-lg font-medium">è¯·è¾“å…¥æ”¯ä»˜å¯†ç </div>
        <div class="w-8"></div>
      </div>
      
      <!-- Amount Display -->
      <div class="text-center py-6">
        <div class="text-4xl font-bold">Â¥<span data-payment-target="passwordAmount"></span></div>
      </div>

      <!-- Password Dots Display -->
      <div class="flex justify-center gap-3 py-6">
        <div class="w-4 h-4 rounded-full border-2 border-gray-300" data-payment-target="dot1"></div>
        <div class="w-4 h-4 rounded-full border-2 border-gray-300" data-payment-target="dot2"></div>
        <div class="w-4 h-4 rounded-full border-2 border-gray-300" data-payment-target="dot3"></div>
        <div class="w-4 h-4 rounded-full border-2 border-gray-300" data-payment-target="dot4"></div>
        <div class="w-4 h-4 rounded-full border-2 border-gray-300" data-payment-target="dot5"></div>
        <div class="w-4 h-4 rounded-full border-2 border-gray-300" data-payment-target="dot6"></div>
      </div>

      <!-- Numeric Keypad (3x4 Grid) -->
      <div class="px-6 pb-6">
        <div class="grid grid-cols-3 gap-4">
          <!-- Row 1: 1, 2, 3 -->
          <button type="button" data-action="click->payment#inputPassword" data-digit="1" 
                  class="h-16 text-2xl font-medium text-gray-800 bg-gray-100 rounded-lg active:bg-gray-200">1</button>
          <button type="button" data-action="click->payment#inputPassword" data-digit="2" 
                  class="h-16 text-2xl font-medium text-gray-800 bg-gray-100 rounded-lg active:bg-gray-200">2</button>
          <button type="button" data-action="click->payment#inputPassword" data-digit="3" 
                  class="h-16 text-2xl font-medium text-gray-800 bg-gray-100 rounded-lg active:bg-gray-200">3</button>
          
          <!-- Row 2: 4, 5, 6 -->
          <button type="button" data-action="click->payment#inputPassword" data-digit="4" 
                  class="h-16 text-2xl font-medium text-gray-800 bg-gray-100 rounded-lg active:bg-gray-200">4</button>
          <button type="button" data-action="click->payment#inputPassword" data-digit="5" 
                  class="h-16 text-2xl font-medium text-gray-800 bg-gray-100 rounded-lg active:bg-gray-200">5</button>
          <button type="button" data-action="click->payment#inputPassword" data-digit="6" 
                  class="h-16 text-2xl font-medium text-gray-800 bg-gray-100 rounded-lg active:bg-gray-200">6</button>
          
          <!-- Row 3: 7, 8, 9 -->
          <button type="button" data-action="click->payment#inputPassword" data-digit="7" 
                  class="h-16 text-2xl font-medium text-gray-800 bg-gray-100 rounded-lg active:bg-gray-200">7</button>
          <button type="button" data-action="click->payment#inputPassword" data-digit="8" 
                  class="h-16 text-2xl font-medium text-gray-800 bg-gray-100 rounded-lg active:bg-gray-200">8</button>
          <button type="button" data-action="click->payment#inputPassword" data-digit="9" 
                  class="h-16 text-2xl font-medium text-gray-800 bg-gray-100 rounded-lg active:bg-gray-200">9</button>
          
          <!-- Row 4: Empty, 0, Delete -->
          <div class="h-16"></div>
          <button type="button" data-action="click->payment#inputPassword" data-digit="0" 
                  class="h-16 text-2xl font-medium text-gray-800 bg-gray-100 rounded-lg active:bg-gray-200">0</button>
          <button type="button" data-action="click->payment#deletePassword" 
                  class="h-16 text-2xl font-medium text-gray-800 bg-gray-100 rounded-lg active:bg-gray-200 flex items-center justify-center">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 001.414.586H19a2 2 0 002-2V7a2 2 0 00-2-2h-8.172a2 2 0 00-1.414.586L3 12z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Status Modal (æ­£åœ¨ä»˜æ¬¾ / ä»˜æ¬¾æˆåŠŸ) -->
  <div class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-end" data-payment-target="statusModal">
    <div class="bg-white w-full rounded-t-3xl p-6 animate-slide-up">
      <button type="button" data-action="click->payment#closeStatusModal" class="text-gray-400 text-2xl mb-4">â†</button>
      
      <!-- Amount -->
      <div class="text-center py-6">
        <div class="text-5xl font-bold mb-8">Â¥<span data-payment-target="statusAmount"></span></div>
      </div>

      <!-- Account -->
      <div class="py-3 border-b">
        <div class="flex items-center justify-between">
          <span class="text-gray-600">è´¦å·</span>
          <span class="text-gray-900"><%= current_user.email %></span>
        </div>
      </div>

      <!-- Payment Method -->
      <div class="py-3 mb-8">
        <div class="flex items-center justify-between">
          <span class="text-gray-600">ä»˜æ¬¾æ–¹å¼</span>
          <div class="flex items-center">
            <span class="text-blue-500 text-xl mr-2">ğŸ’³</span>
            <span class="text-gray-900">èŠ±å‘—</span>
          </div>
        </div>
      </div>

      <!-- Status -->
      <div class="text-center py-8">
        <div class="inline-block w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
          <span class="text-5xl" data-payment-target="statusIcon">ğŸ’³</span>
        </div>
        <div class="text-xl font-medium" data-payment-target="statusText">æ­£åœ¨ä»˜æ¬¾</div>
        <div class="mt-2" data-payment-target="statusDots">
          <span class="inline-block w-2 h-2 bg-gray-400 rounded-full mx-1 animate-pulse"></span>
          <span class="inline-block w-2 h-2 bg-gray-400 rounded-full mx-1 animate-pulse" style="animation-delay: 0.2s"></span>
          <span class="inline-block w-2 h-2 bg-gray-400 rounded-full mx-1 animate-pulse" style="animation-delay: 0.4s"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
@keyframes slide-up {
  from {
    transform: translateY(100%);
  }
  to {
    transform: translateY(0);
  }
}

.animate-slide-up {
  animation: slide-up 0.3s ease-out;
}

@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

.animate-spin {
  animation: spin 1s linear infinite;
}
</style>
