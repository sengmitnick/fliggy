<div class="min-h-screen bg-gray-100 pb-20" data-controller="payment-confirmation"
     data-payment-confirmation-amount-value="<%= (@booking.total_price + (@booking.insurance_price || 0)).to_i %>"
     data-payment-confirmation-user-email-value="<%= current_user.email %>"
     data-payment-confirmation-payment-url-value="/bookings/<%= @booking.id %>/pay"
     data-payment-confirmation-success-url-value="/bookings/<%= @booking.id %>/success">
  <!-- Header -->
  <div class="bg-white border-b">
    <div class="container mx-auto px-4 py-4 flex items-center">
      <%= link_to flights_path, class: "text-2xl mr-4" do %>
        ←
      <% end %>
      <div class="flex-1 flex items-center space-x-4">
        <span class="text-gray-400">填订单</span>
        <span class="text-gray-400">—</span>
        <span class="text-lg font-bold">选服务</span>
        <span class="text-gray-400">—</span>
        <span class="text-gray-400">去支付</span>
      </div>
    </div>
  </div>

  <!-- Order Info Summary -->
  <div class="container mx-auto px-4 py-3">
    <div class="flex items-center justify-between text-sm">
      <% if @booking.trip_type == 'multi_city' %>
        <span class="text-gray-600">多程 | <%= @booking.multi_city_flight_objects.map { |f| f.departure_city }.first %> → ... → <%= @booking.multi_city_flight_objects.map { |f| f.destination_city }.last %> · <%= @flight.departure_time.strftime('%-m月%-d日') %></span>
      <% elsif @booking.trip_type == 'round_trip' %>
        <span class="text-gray-600">往返 | <%= @flight.departure_city %> ⇄ <%= @flight.destination_city %> · <%= @flight.departure_time.strftime('%-m月%-d日') %> - <%= @booking.return_flight.departure_time.strftime('%-m月%-d日') %></span>
      <% else %>
        <span class="text-gray-600">单程 | <%= @flight.departure_city %> → <%= @flight.destination_city %> · <%= @flight.departure_time.strftime('%-m月%-d日') %></span>
      <% end %>
      <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
      </svg>
    </div>
  </div>

  <!-- Insurance Selection (安心旅途推荐) -->
  <div class="bg-white mb-4">
    <div class="container mx-auto px-4 py-4">
      <h3 class="text-lg font-bold mb-2">安心旅途推荐</h3>
      <div class="text-sm text-blue-600 mb-4">
        添加保障 <span class="text-gray-900 font-medium">出行有备无患</span>
      </div>

      <!-- Insurance Options -->
      <div class="grid grid-cols-3 gap-3">
        <!-- 不推荐 - 普通出行 -->
        <div class="border-2 rounded-lg p-3 text-center">
          <div class="text-xs text-gray-500 mb-1">不推荐</div>
          <div class="font-bold mb-2">普通出行</div>
          <div class="text-red-500 text-xl mb-2">×</div>
          <div class="text-xs text-gray-500">不含机酒券</div>
          <div class="text-red-500 text-xl">×</div>
          <div class="text-xs text-gray-500 mb-2">无出行保险</div>
        </div>

        <!-- 性价比优选 - 省心出行 -->
        <div class="border-2 border-purple-400 bg-purple-50 rounded-lg p-3 text-center relative">
          <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 bg-purple-400 text-white text-xs px-3 py-0.5 rounded-full">
            性价比优选
          </div>
          <div class="font-bold mt-2 mb-2">省心出行</div>
          <div class="text-green-500 text-xl mb-1">✓</div>
          <div class="text-xs text-gray-600 mb-1">位权益</div>
          <div class="text-yellow-500 text-xl mb-1">⚡</div>
          <div class="text-xs text-gray-600 mb-2">3礼遇</div>
          <div class="flex items-center justify-center gap-1">
            <span class="text-xs text-gray-400 line-through">¥82</span>
            <span class="text-red-500 font-bold">¥42</span>
          </div>
        </div>

        <!-- 热卖推荐 - 快乐出行 -->
        <div class="border-2 border-orange-400 bg-orange-50 rounded-lg p-3 text-center relative">
          <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 bg-orange-400 text-white text-xs px-3 py-0.5 rounded-full">
            热卖推荐
          </div>
          <div class="font-bold mt-2 mb-2">快乐出行</div>
          <div class="text-green-500 text-xl mb-1">✓</div>
          <div class="text-xs text-gray-600 mb-1">视频会员6...</div>
          <div class="text-green-500 text-xl mb-1">✓</div>
          <div class="text-xs text-gray-600 mb-2">赠飞么么干</div>
          <div class="flex items-center justify-center gap-1">
            <span class="text-xs text-gray-400 line-through">¥94</span>
            <span class="text-red-500 font-bold">¥46</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Selected Passengers -->
  <div class="container mx-auto px-4 mb-4">
    <div class="bg-white rounded-lg shadow p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-bold">已选择: 1成人</h3>
        <%= link_to '邀请好友填写', '#', class: "text-blue-500 text-sm" %>
      </div>
    </div>
  </div>

  <!-- Booking Order -->
  <div class="container mx-auto px-4 mb-20">
    <div class="bg-white rounded-lg shadow p-4">
      <h3 class="font-bold mb-3">预订订单</h3>
      
      <!-- Passenger -->
      <div class="flex items-center justify-between py-2 border-b">
        <span class="text-gray-600">乘机人</span>
        <span class="font-bold"><%= @booking.passenger_name %></span>
      </div>

      <% if @booking.trip_type == 'multi_city' && @booking.multi_city_flights.present? %>
        <!-- Multi-city Flight Prices -->
        <% @booking.multi_city_flight_objects.each_with_index do |flight, index| %>
          <% next unless flight %>
          <div class="flex items-center justify-between py-2 border-b">
            <span class="text-gray-600">第<%= index + 1 %>程机票 (<%= flight.departure_city %> → <%= flight.destination_city %>)</span>
            <span>¥<%= flight.price.to_i %></span>
          </div>
        <% end %>
      <% else %>
        <!-- Outbound Ticket Price -->
        <div class="flex items-center justify-between py-2 border-b">
          <span class="text-gray-600"><%= @booking.trip_type == 'round_trip' ? '去程机票' : '机票' %></span>
          <span>¥<%= (@booking.flight.price).to_i %></span>
        </div>

        <!-- Return Ticket Price (if round trip) -->
        <% if @booking.trip_type == 'round_trip' && @booking.return_flight %>
          <div class="flex items-center justify-between py-2 border-b">
            <span class="text-gray-600">返程机票</span>
            <span>¥<%= (@booking.return_flight.price).to_i %></span>
          </div>
        <% end %>
      <% end %>

      <!-- Insurance -->
      <% if @booking.insurance_type.present? && @booking.insurance_type != 'none' %>
        <div class="flex items-center justify-between py-2 border-b">
          <span class="text-gray-600">保险<%= @booking.trip_type == 'round_trip' ? '（往返×2）' : (@booking.trip_type == 'multi_city' ? "（×#{@booking.multi_city_flight_objects.length}）" : '') %></span>
          <span>¥<%= @booking.insurance_price.to_i %></span>
        </div>
      <% end %>

      <!-- Total -->
      <div class="flex items-center justify-between py-3 font-bold text-lg">
        <span>总计</span>
        <span class="text-red-500">¥<%= (@booking.total_price + (@booking.insurance_price || 0)).to_i %></span>
      </div>
    </div>
  </div>

  <!-- Bottom Payment Button -->
  <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t shadow-lg">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div>
        <div class="text-xs text-gray-500">总计</div>
        <div class="text-xl font-bold text-red-500">¥<%= (@booking.total_price + (@booking.insurance_price || 0)).to_i %></div>
      </div>
      <button type="button" 
              data-action="click->payment-confirmation#showPasswordModal" 
              class="bg-blue-500 text-white px-8 py-3 rounded-lg text-lg font-bold">
        去支付
      </button>
    </div>
  </div>

  <!-- Payment Confirmation Modals -->
  <%= render 'shared/payment_confirmation_modals' %>
</div>
