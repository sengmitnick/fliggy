<div class="min-h-screen bg-gray-100" data-controller="special-flights date-picker city-selector">
  <!-- Header with Banner -->
  <div class="relative pb-8">
    <%= render 'shared/transport_header', background_image: '活动.png', return_path: root_path %>

    <!-- Tabs Container with Gray Background -->
    <div class="relative mx-4 -mt-3 overflow-hidden z-50">
      <%= render 'shared/transport_tabs', active_tab: :special_flight %>
  
      <!-- White Card Container with Form -->
      <div class="bg-white rounded-b-[24px] shadow-sm">
        <div class="px-4 py-4">
          <!-- Banner Section -->
          <div class="mb-4 p-4 rounded-xl" style="background: linear-gradient(135deg, #FFD93D 0%, #FFB347 100%);">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xl font-bold text-gray-900 mb-1">特价机票进群领</div>
                <div class="flex items-center gap-2">
                  <span class="px-2 py-0.5 bg-red-500 text-white text-xs rounded-full font-bold">特价机票</span>
                  <span class="text-xs text-gray-700">随心飞 特价机票 不错过</span>
                </div>
              </div>
              <%= image_tag "home/特价机票.png", class: "w-16 h-16", alt: "特价机票" %>
            </div>
          </div>

          <!-- Search Form -->
          <%= form_with url: search_special_flights_path, method: :get, data: { turbo: false }, class: "space-y-3" do |f| %>
            
            <!-- Departure City -->
            <div class="flex items-center justify-between py-3 border-b border-gray-100">
              <div class="text-sm text-gray-500">出发</div>
              <div class="flex items-center gap-2">
                <button type="button" 
                        data-action="click->city-selector#openDeparture"
                        class="text-lg font-bold text-gray-900">
                  <span data-city-selector-target="departure"><%= @departure_city %></span>
                </button>
                <%= f.hidden_field :departure_city, value: @departure_city, data: { city_selector_target: "departureCityInput" } %>
                <%= f.hidden_field :destination_city, value: @destination_cities&.first || '杭州', data: { city_selector_target: "destinationCityInput" }, style: "display:none;" %>
              </div>
            </div>

            <!-- Destination Cities (Multi-select) -->
            <div class="flex items-center justify-between py-3 border-b border-gray-100">
              <div class="text-sm text-gray-500">目的地</div>
              <div class="flex items-center gap-2">
                <button type="button" 
                        data-action="click->special-flights#openCitySelector"
                        class="text-lg font-bold text-gray-900 flex items-center gap-1">
                  <span data-special-flights-target="destinationCitiesDisplay"><%= @destination_cities.join(',') %></span>
                  <svg class="w-5 h-5 text-primary" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                  </svg>
                </button>
                <%= f.hidden_field :destination_cities, value: @destination_cities.join(','), data: { special_flights_target: "destinationCitiesInput" } %>
              </div>
            </div>

            <!-- Date Selection -->
            <div class="flex items-center justify-between py-3 border-b border-gray-100">
              <div class="text-sm text-gray-500">出发时间</div>
              <div class="flex items-center gap-2">
                <button type="button" 
                        data-action="click->date-picker#openModal"
                        class="text-base font-medium text-gray-900">
                  <span data-date-picker-target="selectedDate">
                    未来1个月 <span class="text-sm text-gray-600">出发</span>
                  </span>
                </button>
                <%= f.hidden_field :date, value: "", data: { date_picker_target: "dateInput" } %>
              </div>
            </div>

            <!-- Search Button -->
            <div class="pt-2">
              <%= f.submit "搜索特价机票", class: "w-full py-4 rounded-full text-lg font-bold text-black", style: "background: #FFD700;" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Special Offers Section -->
  <div class="px-4 py-6">
    <h2 class="text-lg font-bold text-gray-900 mb-4">精选特价推荐</h2>
    
    <div class="space-y-3">
      <%
        sample_offers = [
          { from: '深圳', to: '武汉', date: '02.25 周三', price: 320, discount: '超低1.6折' },
          { from: '深圳', to: '杭州', date: '01.06 周二', price: 247, discount: '超低1.3折' },
          { from: '深圳', to: '新加坡', date: '02.03 周二', price: 606, discount: '特价' },
          { from: '深圳', to: '曼谷', date: '02.25 周三', price: 414, discount: '特价' }
        ]
      %>
      
      <% sample_offers.each do |offer| %>
        <div class="bg-white rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <%= image_tag "home/机票.png", class: "w-12 h-12 rounded", alt: "机票" %>
              <div>
                <div class="text-base font-bold text-gray-900">
                  <%= offer[:from] %> → <%= offer[:to] %>
                </div>
                <div class="text-xs text-gray-500"><%= offer[:date] %></div>
              </div>
            </div>
            <div class="text-right">
              <div class="text-sm text-red-500 font-bold mb-1"><%= offer[:discount] %></div>
              <div class="text-xl font-bold text-red-500">¥<%= offer[:price] %></div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Multi-City Selector Modal -->
  <div data-special-flights-target="cityModal" class="hidden fixed inset-0 z-50 overflow-hidden">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black bg-opacity-50" data-action="click->special-flights#closeCityModal"></div>
    
    <!-- Modal Content -->
    <div class="absolute inset-0 flex items-end justify-center">
      <div class="bg-white w-full max-w-md mx-auto h-[85vh] rounded-t-3xl flex flex-col overflow-hidden">
        
        <!-- Header -->
        <div class="px-4 pt-4 pb-2 bg-white z-20 shrink-0 border-b border-gray-100">
          <div class="flex justify-between items-center mb-4">
            <div class="text-lg font-bold text-gray-900">多选目的地</div>
            <button 
              data-action="click->special-flights#closeCityModal"
              class="p-1">
              <svg class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          <!-- Search Box -->
          <div class="bg-gray-100 rounded-xl px-3 py-2.5 flex items-center mb-4">
            <svg class="h-5 w-5 text-gray-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input 
              type="text"
              data-special-flights-target="searchInput"
              data-action="input->special-flights#search"
              placeholder="搜索城市"
              class="flex-1 bg-transparent text-sm text-gray-900 placeholder-gray-400 focus:outline-none">
          </div>

          <!-- Selected Cities Display -->
          <div class="mb-3">
            <div class="text-xs text-gray-500 mb-2">已选择目的地</div>
            <div data-special-flights-target="selectedCitiesContainer" class="flex flex-wrap gap-2">
              <span class="text-gray-500">未选择目的地</span>
            </div>
          </div>
        </div>

        <!-- City List -->
        <div data-special-flights-target="cityList" class="flex-1 overflow-y-auto px-4 py-4">
          <div class="mb-4">
            <div class="text-sm font-medium text-gray-900 mb-3">热门城市</div>
            <div class="grid grid-cols-4 gap-3">
              <% if defined?(@hot_cities) && @hot_cities.present? %>
                <% @hot_cities.each do |city| %>
                  <button 
                    type="button"
                    data-action="click->special-flights#toggleCity"
                    data-city-name="<%= city.name %>"
                    data-city-pinyin="<%= city.pinyin %>"
                    class="py-2 text-center text-sm rounded bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors <%= @destination_cities.include?(city.name) ? 'bg-primary text-white' : '' %>">
                    <%= city.name %>
                  </button>
                <% end %>
              <% else %>
                <% [{name: "北京", pinyin: "beijing"}, {name: "上海", pinyin: "shanghai"}, {name: "广州", pinyin: "guangzhou"}, {name: "杭州", pinyin: "hangzhou"}, {name: "成都", pinyin: "chengdu"}, {name: "深圳", pinyin: "shenzhen"}, {name: "重庆", pinyin: "chongqing"}, {name: "西安", pinyin: "xian"}, {name: "武汉", pinyin: "wuhan"}, {name: "郑州", pinyin: "zhengzhou"}, {name: "昆明", pinyin: "kunming"}, {name: "哈尔滨", pinyin: "haerbin"}].each do |city| %>
                  <button 
                    type="button"
                    data-action="click->special-flights#toggleCity"
                    data-city-name="<%= city[:name] %>"
                    data-city-pinyin="<%= city[:pinyin] %>"
                    class="py-2 text-center text-sm rounded bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors <%= @destination_cities.include?(city[:name]) ? 'bg-primary text-white' : '' %>">
                    <%= city[:name] %>
                  </button>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Footer Actions -->
        <div class="px-4 py-3 bg-white border-t border-gray-100 flex gap-3">
          <button 
            type="button"
            data-action="click->special-flights#clearAllCities"
            class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">
            清空
          </button>
          <button 
            type="button"
            data-action="click->special-flights#confirmCitySelection"
            class="flex-[2] py-3 bg-primary text-white rounded-lg font-bold hover:bg-opacity-90">
            确定
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Date Picker Modal (Fuzzy Date Version for Special Flights) -->
  <%= render 'shared/special_flights_date_picker_modal' %>

  <!-- City Selector Modal for Departure -->
  <%= render 'shared/city_selector_modal' %>
</div>
