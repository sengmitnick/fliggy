<div class="min-h-screen bg-surface">
  <!-- 顶部搜索和返回栏 -->
  <div class="bg-white border-b border-border sticky top-0 z-50">
    <div class="flex items-center gap-3 px-4 py-3">
      <%= link_to root_path, class: "p-2" do %>
        <svg class="w-6 h-6 text-text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      <% end %>
      
      <div class="flex-1">
        <div class="bg-surface-elevated rounded-full px-4 py-2 flex items-center gap-2">
          <svg class="w-5 h-5 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <span class="text-sm text-text-secondary">搜索签证服务</span>
        </div>
      </div>

      <button class="p-2">
        <svg class="w-6 h-6 text-text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
        </svg>
      </button>
    </div>

    <!-- 顶部Tab导航 -->
    <div class="flex overflow-x-auto no-scrollbar border-b border-border-light">
      <% tabs = [
        { id: '综合', label: '综合', icon: '🏠', service_type: nil },
        { id: '跟团游', label: '跟团游', icon: '✈️', service_type: '全国送签' },
        { id: '独立成团', label: '独立成团', icon: '🚢', service_type: '武汉送签' },
        { id: '自由出行', label: '自由出行', icon: '🚗', service_type: '北京送签' },
        { id: '出境必备', label: '出境必备', icon: '🌍', service_type: '全国送签' }
      ] %>
      
      <% tabs.each do |tab| %>
        <% is_active = (@service_type == tab[:service_type]) || (tab[:id] == '出境必备' && @service_type == '全国送签') %>
        <%= link_to visa_services_path(service_type: tab[:service_type]), 
            class: "flex flex-col items-center space-y-1 px-6 py-3 whitespace-nowrap #{is_active ? 'border-b-2 border-primary' : ''}" do %>
          <div class="flex items-center gap-1">
            <span class="text-xl"><%= tab[:icon] %></span>
          </div>
          <span class="text-sm <%= is_active ? 'text-text-primary font-bold' : 'text-text-secondary' %>">
            <%= tab[:label] %>
          </span>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- 筛选栏 -->
  <div class="bg-white px-4 py-3 flex items-center gap-3 overflow-x-auto no-scrollbar">
    <div class="flex gap-2">
      <!-- 全部分类下拉 -->
      <div class="relative" data-controller="filter-dropdown">
        <button data-action="click->filter-dropdown#toggle" data-filter-dropdown-target="button" 
                class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-surface-elevated text-sm whitespace-nowrap">
          <span class="text-text-secondary">全部分类</span>
          <svg class="w-4 h-4 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        
        <div data-filter-dropdown-target="dropdown" class="hidden absolute top-full left-0 mt-2 bg-white rounded-lg shadow-lg border border-border p-2 min-w-[150px] z-50">
          <%= link_to visa_services_path(service_type: @service_type, country: nil), 
              class: "block px-3 py-2 text-sm text-text-secondary hover:bg-surface-elevated rounded" do %>
            全部国家
          <% end %>
          <%= link_to visa_services_path(service_type: @service_type, country: '韩国'), 
              class: "block px-3 py-2 text-sm text-text-secondary hover:bg-surface-elevated rounded" do %>
            韩国签证
          <% end %>
          <%= link_to visa_services_path(service_type: @service_type, country: '日本'), 
              class: "block px-3 py-2 text-sm text-text-secondary hover:bg-surface-elevated rounded" do %>
            日本签证
          <% end %>
        </div>
        
        <div data-filter-dropdown-target="overlay" data-action="click->filter-dropdown#closeAll" 
             class="hidden fixed inset-0 z-40"></div>
      </div>

      <!-- 智能排序下拉 -->
      <div class="relative" data-controller="filter-dropdown">
        <button data-action="click->filter-dropdown#toggle" data-filter-dropdown-target="button" 
                class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-surface-elevated text-sm whitespace-nowrap">
          <span class="text-text-secondary">智能排序</span>
          <svg class="w-4 h-4 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        
        <div data-filter-dropdown-target="dropdown" class="hidden absolute top-full left-0 mt-2 bg-white rounded-lg shadow-lg border border-border p-2 min-w-[150px] z-50">
          <%= link_to visa_services_path(service_type: @service_type, country: @country, sort_by: 'smart'), 
              class: "block px-3 py-2 text-sm text-text-secondary hover:bg-surface-elevated rounded" do %>
            智能排序
          <% end %>
          <%= link_to visa_services_path(service_type: @service_type, country: @country, sort_by: 'sales'), 
              class: "block px-3 py-2 text-sm text-text-secondary hover:bg-surface-elevated rounded" do %>
            销量优先
          <% end %>
          <%= link_to visa_services_path(service_type: @service_type, country: @country, sort_by: 'price_asc'), 
              class: "block px-3 py-2 text-sm text-text-secondary hover:bg-surface-elevated rounded" do %>
            价格从低到高
          <% end %>
          <%= link_to visa_services_path(service_type: @service_type, country: @country, sort_by: 'price_desc'), 
              class: "block px-3 py-2 text-sm text-text-secondary hover:bg-surface-elevated rounded" do %>
            价格从高到低
          <% end %>
        </div>
        
        <div data-filter-dropdown-target="overlay" data-action="click->filter-dropdown#closeAll" 
             class="hidden fixed inset-0 z-40"></div>
      </div>

      <!-- 筛选标签 -->
      <div class="relative" data-controller="filter-dropdown">
        <button data-action="click->filter-dropdown#toggle" data-filter-dropdown-target="button" 
                class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-surface-elevated text-sm whitespace-nowrap">
          <span class="text-text-secondary">筛选</span>
          <svg class="w-4 h-4 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        
        <div data-filter-dropdown-target="dropdown" class="hidden absolute top-full left-0 mt-2 bg-white rounded-lg shadow-lg border border-border p-3 min-w-[200px] z-50">
          <div class="space-y-3">
            <div>
              <h4 class="text-xs font-bold text-text-primary mb-2">签证类型</h4>
              <div class="space-y-1">
                <%= link_to visa_services_path(service_type: '全国送签'), 
                    class: "block px-2 py-1 text-sm text-text-secondary hover:bg-surface-elevated rounded" do %>
                  全国送签
                <% end %>
                <%= link_to visa_services_path(service_type: '武汉送签'), 
                    class: "block px-2 py-1 text-sm text-text-secondary hover:bg-surface-elevated rounded" do %>
                  武汉送签
                <% end %>
                <%= link_to visa_services_path(service_type: '北京送签'), 
                    class: "block px-2 py-1 text-sm text-text-secondary hover:bg-surface-elevated rounded" do %>
                  北京送签
                <% end %>
              </div>
            </div>
          </div>
        </div>
        
        <div data-filter-dropdown-target="overlay" data-action="click->filter-dropdown#closeAll" 
             class="hidden fixed inset-0 z-40"></div>
      </div>
    </div>

    <!-- 加急办理标签 -->
    <%= link_to visa_services_path(service_type: @service_type, country: @country, urgent_processing: !@urgent_only), 
        class: "px-3 py-1.5 rounded-full text-sm whitespace-nowrap #{@urgent_only ? 'bg-primary text-text-primary font-bold' : 'bg-surface-elevated text-text-secondary'}" do %>
      加急办理
    <% end %>
  </div>

  <!-- 签证服务列表 -->
  <div class="p-4 space-y-3">
    <% if @visa_services.any? %>
      <% @visa_services.each do |service| %>
        <%= link_to '#', class: "block bg-white rounded-2xl overflow-hidden shadow-sm border border-border-light hover:shadow-md transition-shadow" do %>
          <div class="flex gap-3 p-3">
            <!-- 商品图片 -->
            <div class="relative flex-shrink-0">
              <% if service.image_url.present? %>
                <img src="<%= service.image_url %>" alt="<%= service.title %>" class="w-24 h-24 object-cover rounded-xl">
              <% else %>
                <div class="w-24 h-24 bg-surface-elevated rounded-xl flex items-center justify-center">
                  <span class="text-4xl">🌏</span>
                </div>
              <% end %>
              
              <!-- 促销标签 -->
              <% if service.urgent_processing %>
                <span class="absolute top-0 left-0 bg-danger text-white text-xs px-2 py-0.5 rounded-tl-xl rounded-br-xl font-bold">
                  急送
                </span>
              <% end %>
            </div>

            <!-- 商品信息 -->
            <div class="flex-1 min-w-0">
              <!-- 服务类型标签 -->
              <div class="flex items-center gap-1 mb-1">
                <span class="inline-block px-2 py-0.5 bg-surface-elevated text-text-muted text-xs rounded">
                  <%= service.service_type %>
                </span>
              </div>

              <!-- 标题 -->
              <h3 class="font-bold text-sm leading-snug line-clamp-2 text-text-primary mb-1">
                <%= service.title %>
              </h3>

              <!-- 出签信息 -->
              <p class="text-xs text-text-secondary mb-2">
                出签率<%= service.success_rate %>%·预计<%= service.processing_days %>个工作日反馈
              </p>

              <!-- 商家信息 -->
              <div class="flex items-center gap-1 mb-2">
                <span class="text-xs text-text-muted"><%= service.merchant_name %></span>
                <% if service.merchant_name.include?('官方') %>
                  <span class="inline-flex items-center px-1.5 py-0.5 bg-primary/10 text-primary text-xs rounded">
                    品牌官方
                  </span>
                <% end %>
              </div>

              <!-- 销量和价格 -->
              <div class="flex items-end justify-between">
                <div class="text-xs text-text-muted">
                  已售<%= service.sales_count %>+
                </div>
                <div class="flex items-baseline gap-1">
                  <% if service.original_price.present? && service.original_price > service.price %>
                    <span class="text-xs text-text-muted line-through">¥<%= service.original_price %></span>
                  <% end %>
                  <span class="text-lg font-bold text-danger">¥<%= service.price %></span>
                  <span class="text-xs text-text-muted">起</span>
                </div>
              </div>

              <!-- 优惠券信息 -->
              <% if service.original_price.present? && service.original_price > service.price %>
                <div class="mt-1 flex items-center gap-1 text-xs text-warning">
                  <span>商品优惠券 1张券·优惠5元</span>
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                  </svg>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    <% else %>
      <div class="text-center py-20">
        <div class="text-6xl mb-4">🔍</div>
        <p class="text-text-muted">暂无签证服务</p>
      </div>
    <% end %>
  </div>
</div>
