<div class="bg-background min-h-screen pb-24" 
     data-controller="deep-booking"
     data-deep-booking-guide-id-value="<%= @guide.id %>"
     data-deep-booking-selected-date-value="<%= Date.today.to_s %>"
     data-deep-booking-adult-count-value="1"
     data-deep-booking-child-count-value="0"
     data-deep-booking-price-per-person-value="<%= @selected_product&.price || 192 %>">
  <!-- 顶部深色背景区域 (Profile Section) -->
  <div class="bg-[#48413d] text-white pb-6">
    <!-- 顶部导航栏 -->
    <div class="flex justify-between items-center px-4 py-3 sticky top-0 z-50 bg-[#48413d]">
      <%= link_to deep_travels_path, class: "p-1" do %>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      <% end %>
      <span class="text-lg font-medium"><%= @guide.name %></span>
      <button class="p-1">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="5" cy="12" r="2" fill="white"/>
          <circle cx="12" cy="12" r="2" fill="white"/>
          <circle cx="19" cy="12" r="2" fill="white"/>
        </svg>
      </button>
    </div>

    <!-- 个人信息卡片 -->
    <div class="px-4 mt-2">
      <div class="flex items-start gap-4">
        <!-- 头像 -->
        <div class="relative shrink-0">
          <div class="w-20 h-20 rounded-full border-2 border-[#8c7865] overflow-hidden bg-gray-300">
            <% if @guide.avatar.attached? %>
              <%= image_tag @guide.avatar.variant(resize_to_fill: [80, 80]), 
                           class: "w-full h-full object-cover",
                           alt: @guide.name %>
            <% else %>
              <svg class="w-full h-full text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                <path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
            <% end %>
          </div>
          <% if @guide.rank.present? %>
            <div class="absolute -bottom-1 -right-1 bg-red-600 text-[10px] text-white px-1 rounded">
              <%= @guide.rank %>
            </div>
          <% end %>
        </div>

        <!-- 名字和数据 -->
        <div class="flex-1">
          <h1 class="text-2xl font-bold mb-1"><%= @guide.name %></h1>
          <div class="flex items-center gap-3 text-xs text-gray-300 mb-2">
            <span>粉丝<%= number_to_human(@guide.follower_count, precision: 0, significant: false, format: '%n%u', units: {thousand: '千', million: '万', billion: '亿'}) %>+</span>
            <span>已服务<%= number_to_human(@guide.served_count, precision: 0, significant: false, format: '%n%u', units: {thousand: '千', million: '万', billion: '亿'}) %>+人</span>
          </div>
        </div>
      </div>

      <!-- 简介引用 -->
      <% if @guide.description.present? %>
        <div class="mt-4 text-sm text-gray-300 leading-relaxed relative pl-2">
          <span class="absolute left-0 top-0">"</span>
          <%= @guide.description %>
          <span class="absolute">"</span>
        </div>
      <% end %>

      <!-- 所属团队 -->
      <% if @guide.title.present? %>
        <div class="mt-4 flex items-center">
          <div class="bg-[#5a524e] rounded-full px-3 py-1 flex items-center gap-1 text-xs text-gray-300">
            <span class="w-4 h-4 bg-red-100 rounded-full flex items-center justify-center text-red-500 text-[10px]">异</span>
            <%= @guide.title %>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 18L15 12L9 6" />
            </svg>
          </div>
        </div>
      <% end %>
    </div>

    <!-- 视频讲解片段 -->
    <% if @guide.video.attached? %>
      <div class="mt-6 pl-4">
        <h3 class="text-white text-base font-medium mb-3">我在「 故宫博物院 」的讲解片段</h3>
        <div class="flex gap-3 overflow-x-auto no-scrollbar pr-4">
          <!-- Video Card -->
          <div class="shrink-0 w-40 h-56 rounded-lg bg-gray-600 relative overflow-hidden">
            <video class="w-full h-full object-cover" controls>
              <%= video_tag url_for(@guide.video), class: "w-full h-full" %>
            </video>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- 白色内容区域 -->
  <div class="bg-background rounded-t-xl -mt-2 relative z-10">
    
    <!-- Tabs -->
    <div class="flex bg-white">
      <div class="flex-1 py-4 flex justify-center bg-gradient-to-b from-[#fffbf0] to-white">
        <span class="font-bold text-lg text-gray-900 border-b-2 border-transparent relative">
          可订套餐
        </span>
      </div>
      <div class="flex-1 py-4 flex justify-center bg-white">
        <span class="font-medium text-lg text-gray-500">用户评价</span>
      </div>
    </div>

    <!-- 可约日期 -->
    <div class="px-4 py-3 bg-white">
      <h3 class="font-bold text-base mb-3">可约日期</h3>
      <div class="relative">
        <div class="flex gap-2 overflow-x-auto no-scrollbar items-center pr-14">
        
        <% today = Date.today %>
        <% 5.times do |i| %>
          <% date = today + i.days %>
          <% is_first = i == 0 %>
          <% is_available = (i != 2 && i != 3) %>
          
          <% if is_available %>
            <button class="shrink-0 w-[72px] h-[72px] <%= is_first ? 'bg-[#ffeeb8] border-[#ffeeb8]' : 'bg-[#f5f7fa]' %> rounded-lg flex flex-col justify-center items-center border relative hover:bg-[#ffeeb8] transition-colors"
                    data-action="click->deep-booking#selectDate"
                    data-date="<%= date.to_s %>">
              <% if is_first %>
                <div class="absolute -top-1.5 -left-1.5 bg-[#ff9e56] text-white text-[10px] px-1.5 py-0.5 rounded-br-lg rounded-tl-lg scale-90">最早可约</div>
              <% end %>
              <span class="text-xs <%= is_first ? 'text-gray-800' : 'text-gray-500' %> font-medium <%= is_first ? 'mt-1' : '' %>">周<%= %w[日 一 二 三 四 五 六][date.wday] %></span>
              <span class="text-sm font-bold <%= is_first ? 'text-gray-900' : 'text-gray-800' %>"><%= date.strftime('%m-%d') %></span>
              <span class="text-xs text-gray-800">¥<%= @selected_product&.price || 192 %>起</span>
            </button>
          <% else %>
            <div class="shrink-0 w-[72px] h-[72px] bg-[#f5f7fa] rounded-lg flex flex-col justify-center items-center opacity-60">
              <span class="text-xs text-gray-400">周<%= %w[日 一 二 三 四 五 六][date.wday] %></span>
              <span class="text-sm font-medium text-gray-400"><%= date.strftime('%m-%d') %></span>
              <span class="text-xs text-gray-400">不可约</span>
            </div>
          <% end %>
        <% end %>

        </div>
        
        <!-- Calendar More - Fixed to Right -->
        <div class="absolute right-0 top-0 h-[72px] flex items-center">
          <div class="absolute right-0 top-0 bottom-0 w-12 bg-gradient-to-r from-transparent to-white pointer-events-none"></div>
          <button class="relative z-10 w-[40px] h-[72px] flex items-center justify-center bg-white"
                  data-action="click->deep-booking#openCalendar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
              <polygon points="12 14 16 18 8 18" fill="#666" stroke="none"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- 讲解套餐 Cards -->
    <div class="px-4 mt-4 mb-2">
      <h3 class="font-bold text-base mb-3">讲解套餐</h3>
      
      <% @products.each_with_index do |product, index| %>
        <div class="bg-[#fffbf0] p-4 rounded-lg relative border <%= index == 0 ? 'border-[#fadd54]' : 'border-yellow-50' %> <%= 'mt-3' if index > 0 %> cursor-pointer hover:border-[#fadd54] transition-colors"
             data-deep-booking-target="productCard"
             data-product-id="<%= product.id %>"
             data-product-price="<%= product.price %>"
             data-action="click->deep-booking#selectProduct">
          <div class="flex justify-between items-start">
            <h4 class="font-bold text-gray-900 text-lg"><%= product.title %></h4>
            <div class="text-right">
              <span class="text-xs text-gray-500 block mb-0.5">不含门票</span>
              <div class="flex items-baseline justify-end gap-0.5">
                <span class="text-xs text-[#ff5336]">¥</span>
                <span class="text-xl font-bold text-[#ff5336]"><%= product.price %></span>
                <span class="text-xs text-[#ff5336]">/人</span>
              </div>
              <% if 0 && 0 > 0 %>
                <span class="text-[10px] text-[#ff5336] bg-[#ffece8] px-1 rounded">已优惠¥<%= 0 %> ></span>
              <% end %>
            </div>
          </div>
          
          <div class="text-xs text-gray-500 mt-2 space-y-1">
            <p>每团最多<%= 10 %>人 | <%= "7日内可退改" %></p>
          </div>
          
          <% if nil.present? %>
            <div class="mt-3 flex items-center text-gray-400 text-xs cursor-pointer hover:text-gray-600">
              <span>须知</span>
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18L15 12L9 6"/>
              </svg>
            </div>
          <% end %>
          
          <!-- Checkmark icon bottom right -->
          <div class="absolute bottom-0 right-0 <%= 'hidden' unless index == 0 %>">
            <div class="w-6 h-4 bg-[#fadd54] rounded-tl-lg flex items-center justify-center">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                <path d="M20 6L9 17l-5-5"/>
              </svg>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- 推荐部分 -->
    <div class="px-4 mt-6 pb-4 bg-white pt-4">
      <h3 class="font-bold text-base mb-3 flex items-center gap-1">
        为你推荐其他热门讲解商品
      </h3>
      
      <div class="flex gap-3 overflow-x-auto no-scrollbar">
        <% DeepTravelProduct.includes(:deep_travel_guide, images_attachments: :blob)
                            .where.not(deep_travel_guide_id: @guide.id)
                            .order(sales_count: :desc)
                            .limit(5).each do |rec_product| %>
          <div class="shrink-0 w-64 bg-gray-50 rounded-lg overflow-hidden flex border border-gray-100">
            <div class="w-24 h-24 bg-gray-300 shrink-0 relative">
              <% if rec_product.images.attached? && rec_product.images.first %>
                <%= image_tag rec_product.images.first.variant(resize_to_fill: [96, 96]),
                             class: "w-full h-full object-cover",
                             alt: rec_product.title %>
              <% else %>
                <svg class="w-full h-full text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                  <rect width="24" height="24" fill="#ddd"/>
                </svg>
              <% end %>
              <div class="absolute bottom-0 left-0 w-full bg-black/50 text-white text-[10px] px-1 text-center">
                已售<%= rec_product.sales_count %>+
              </div>
            </div>
            <div class="p-2 flex flex-col justify-between flex-1">
              <h4 class="text-sm font-bold leading-tight line-clamp-2"><%= rec_product.title %></h4>
              <div class="flex gap-1 mt-1">
                <span class="text-[10px] text-gray-500 border border-gray-200 px-1 rounded">无购物</span>
                <span class="text-[10px] text-gray-500 border border-gray-200 px-1 rounded">无自费</span>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- 用户评价 -->
    <div class="px-4 mt-2 bg-white pt-4 pb-20">
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-bold text-base flex items-center gap-1">
          用户对 <span class="text-[#566aff]"><%= @guide.name %></span> 的评价
        </h3>
        <div class="flex items-center text-xs text-gray-500">
          0条评价
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18L15 12L9 6"/>
          </svg>
        </div>
      </div>

      <!-- Score Banner -->
      <div class="bg-[#f2f4fe] p-3 rounded-lg flex items-center gap-3 mb-6">
        <div class="bg-[#566aff] text-white text-xl font-bold px-2 py-1 rounded w-14 text-center">5.0</div>
        <div>
          <div class="text-[#566aff] font-bold text-sm">超棒</div>
          <div class="text-xs text-gray-500">高于100%的讲师</div>
        </div>
      </div>

      <!-- Comment Placeholder -->
      <div class="text-center text-gray-400 text-sm py-8">
        暂无评价
      </div>
    </div>

  </div>

  <!-- 底部固定栏 -->
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 px-4 py-2 flex items-center z-50 max-w-[414px] mx-auto">
    <!-- 联系客服 -->
    <div class="flex flex-col items-center justify-center mr-4">
      <div class="w-6 h-6 rounded-full overflow-hidden bg-gray-200">
        <svg class="w-full h-full text-gray-500" fill="currentColor" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="12"/>
        </svg>
      </div>
      <span class="text-[10px] text-[#b38a60] mt-0.5">联系客服</span>
    </div>

    <div class="flex-1 flex justify-end items-center gap-3">
      <div class="text-right">
        <span class="text-[#ff5336] text-sm">¥</span>
        <span class="text-[#ff5336] text-2xl font-bold" data-deep-booking-target="displayPrice">
          <%= @selected_product&.price || 192 %>
        </span>
        <span class="text-[#ff5336] text-sm">/人</span>
      </div>
      <button class="bg-gradient-to-r from-[#ff8d3f] to-[#ff4737] text-white font-bold text-base px-8 py-2.5 rounded-full shadow-md"
              data-action="click->deep-booking#openCountModal">
        去预约
      </button>
    </div>
  </div>
</div>

<style>
/* 隐藏横向滚动条但保留功能 */
.no-scrollbar::-webkit-scrollbar {
  display: none;
}
.no-scrollbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}
</style>
