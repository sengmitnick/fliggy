<div class="min-h-screen bg-gray-100" data-controller="city-selector" data-city-selector-departure-city-value="<%= @city %>">  <!-- Hidden input for form submission -->
  <input type="hidden" name="city" data-city-selector-target="cityInput" value="<%= @city %>">
  <!-- 顶部导航栏 -->
  <div class="sticky top-0 z-50 bg-white px-4 py-2 flex items-center space-x-3">
    <%= link_to root_path do %>
      <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
    <% end %>
    
    <div class="flex-1 relative" data-controller="filter-dropdown">
      <button type="button" 
              data-action="filter-dropdown#toggle" 
              data-dropdown-id="city"
              class="w-full bg-gray-100 rounded-full flex items-center px-4 py-1.5 border border-yellow-400">
        <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        <span class="flex-1 text-gray-700 text-sm text-left"><%= @city %></span>
        <svg class="w-3 h-3 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
          <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
        </svg>
      </button>
      
      <!-- 城市下拉菜单 -->
      <div data-filter-dropdown-target="dropdown" 
           data-dropdown-id="city"
           class="hidden absolute top-full left-0 right-0 mt-2 bg-white rounded-lg shadow-lg border z-50 max-h-96 overflow-y-auto">
        <div class="py-2">
          <div class="px-3 py-2 text-gray-500 text-xs font-bold">选择城市</div>
          <div class="grid grid-cols-2 gap-1 px-2">
            <% @cities.each do |city| %>
              <%= link_to city, tickets_path(city: city), 
                  class: "block px-3 py-2 text-center rounded hover:bg-gray-50 transition-colors text-sm #{@city == city ? 'bg-primary/10 text-primary font-bold' : 'text-gray-700'}",
                  data: { action: 'filter-dropdown#selectOption' } %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    
    <svg class="w-6 h-6 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
      <path d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"/>
    </svg>
  </div>

  <!-- 城市标题（可点击打开城市选择器） -->
  <div class="bg-gray-100 px-4 pt-3 pb-2">
    <button 
      type="button"
      data-action="click->city-selector#openDeparture"
      class="flex items-center gap-2 text-left">
      <h1 class="text-2xl font-bold" data-city-selector-target="departure"><%= @city %></h1>
      <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
      </svg>
    </button>
  </div>

  <!-- Tab导航 -->
  <div class="bg-gray-100 px-4">
    <div class="flex space-x-6 text-sm overflow-x-auto hide-scrollbar">
      <% 
        tabs = [
          { label: '全部景点', value: nil },
          { label: '景酒套餐', value: 'hotel_package' },
          { label: '当地体验', value: 'experience' },
          { label: '一日游', value: 'day_tour' },
          { label: '包车游', value: 'charter' }
        ]
      %>
      <% tabs.each do |tab| %>
        <% is_active = params[:tab] == tab[:value] || (params[:tab].nil? && tab[:value].nil?) %>
        <%= link_to tickets_path(city: @city, tab: tab[:value], sort_by: @sort_by, tag: @selected_tag),
            class: "relative pb-2 whitespace-nowrap #{is_active ? 'font-bold text-black' : 'text-gray-600'}" do %>
          <span><%= tab[:label] %></span>
          <% if is_active %>
            <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-6 h-0.5 bg-black"></div>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- 筛选栏 -->
  <div class="bg-white px-4 py-2 border-b border-t" data-controller="filter-dropdown">
    <div class="flex justify-between text-xs">
      <!-- 智能排序 -->
      <div class="relative">
        <button type="button" 
                data-action="filter-dropdown#toggle" 
                data-dropdown-id="sort"
                class="flex items-center <%= @sort_by != 'smart' ? 'text-[#FF7043]' : 'text-gray-700' %> hover:text-[#FF5722] transition-colors relative">
          <span><%= @sort_by == 'smart' ? '智能排序' : @sort_by == 'sales' ? '销量优先' : '好评优先' %></span>
          <% if @sort_by != 'smart' %>
            <span class="absolute -top-1 -right-1 bg-[#FF5722] text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center font-bold">1</span>
          <% end %>
          <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
          </svg>
        </button>
        
        <!-- 排序下拉菜单 -->
        <div data-filter-dropdown-target="dropdown" 
             data-dropdown-id="sort"
             class="hidden absolute top-full left-0 mt-2 w-32 bg-white rounded-lg shadow-lg border z-50">
          <div class="py-2">
            <%= link_to '智能排序', tickets_path(city: @city, sort_by: 'smart', tag: @selected_tag), 
                class: "block px-4 py-2 hover:bg-gray-50 transition-colors #{@sort_by == 'smart' ? 'text-primary font-bold' : 'text-gray-700'}",
                data: { action: 'filter-dropdown#selectOption' } %>
            <%= link_to '销量优先', tickets_path(city: @city, sort_by: 'sales', tag: @selected_tag), 
                class: "block px-4 py-2 hover:bg-gray-50 transition-colors #{@sort_by == 'sales' ? 'text-primary font-bold' : 'text-gray-700'}",
                data: { action: 'filter-dropdown#selectOption' } %>
            <%= link_to '好评优先', tickets_path(city: @city, sort_by: 'rating', tag: @selected_tag), 
                class: "block px-4 py-2 hover:bg-gray-50 transition-colors #{@sort_by == 'rating' ? 'text-primary font-bold' : 'text-gray-700'}",
                data: { action: 'filter-dropdown#selectOption' } %>
          </div>
        </div>
      </div>
      
      <!-- 景点类型 -->
      <div class="relative">
        <button type="button" 
                data-action="filter-dropdown#toggle" 
                data-dropdown-id="type"
                class="flex items-center text-gray-700 hover:text-[#FF5722] transition-colors">
          <span>景点类型</span>
          <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
          </svg>
        </button>
        
        <!-- 景点类型下拉菜单 -->
        <div data-filter-dropdown-target="dropdown" 
             data-dropdown-id="type"
             class="hidden absolute top-full left-1/2 -translate-x-1/2 mt-2 w-32 bg-white rounded-lg shadow-lg border z-50">
          <div class="py-2">
            <div class="px-3 py-2 text-gray-500 text-xs font-bold">选择类型</div>
            <%= link_to '全部', tickets_path(city: @city, sort_by: @sort_by), 
                class: "block px-4 py-2 hover:bg-gray-50 transition-colors text-gray-700",
                data: { action: 'filter-dropdown#selectOption' } %>
            <%= link_to '主题乐园', tickets_path(city: @city, sort_by: @sort_by, tag: '主题乐园'), 
                class: "block px-4 py-2 hover:bg-gray-50 transition-colors text-gray-700",
                data: { action: 'filter-dropdown#selectOption' } %>
            <%= link_to '自然风光', tickets_path(city: @city, sort_by: @sort_by, tag: '自然风光'), 
                class: "block px-4 py-2 hover:bg-gray-50 transition-colors text-gray-700",
                data: { action: 'filter-dropdown#selectOption' } %>
          </div>
        </div>
      </div>
      
      <!-- 景点等级 -->
      <button class="flex items-center text-gray-700">
        <span>景点等级</span>
        <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
          <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
        </svg>
      </button>
      
      <!-- 筛选 -->
      <button class="flex items-center text-gray-700">
        <span>筛选</span>
        <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
          <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- 城市选择器模态框 -->
  <%= render 'shared/city_selector_modal' %>

  <!-- 门票列表 -->
  <div class="bg-white px-4 py-3">
    <% if @tickets.empty? %>
      <!-- 空状态 -->
      <div class="text-center py-12">
        <div class="text-gray-400 text-sm mb-2">暂无门票数据</div>
        <div class="text-gray-300 text-xs">请尝试切换其他城市</div>
      </div>
    <% else %>
      <% @tickets.each do |ticket| %>
        <%= link_to ticket_path(ticket[:id]), class: "block mb-3" do %>
          <!-- 门票卡片 -->
          <div class="flex space-x-3">
            <!-- 左侧图片 -->
            <div class="relative w-32 h-24 shrink-0">
              <%= image_tag ticket[:image], class: "w-full h-full object-cover rounded-lg", alt: ticket[:title] %>
              <% if ticket[:badge].present? %>
                <span class="absolute top-1 left-1 bg-[#FF5722] text-white text-[10px] px-2 py-0.5 rounded"><%= ticket[:badge] %></span>
              <% end %>
            </div>
            
            <!-- 右侧信息 -->
            <div class="flex-1 flex flex-col justify-between py-1">
              <!-- 标题 -->
              <div>
                <h3 class="text-sm font-bold text-gray-900 line-clamp-2 mb-1"><%= ticket[:title] %></h3>
                
                <!-- 评分 -->
                <% if ticket[:rating].present? %>
                  <div class="flex items-center space-x-1 mb-1">
                    <span class="bg-[#FF7043] text-white text-xs px-1.5 py-0.5 rounded font-bold"><%= ticket[:rating] %></span>
                    <span class="text-xs text-gray-500"><%= ticket[:rating_desc] %></span>
                  </div>
                <% end %>
                
                <!-- 标签 -->
                <% if ticket[:tags].present? %>
                  <div class="flex flex-wrap gap-1 mb-1">
                    <% ticket[:tags].first(3).each do |tag| %>
                      <span class="text-[10px] text-gray-600 bg-gray-100 px-1.5 py-0.5 rounded"><%= tag %></span>
                    <% end %>
                  </div>
                <% end %>
              </div>
              
              <!-- 底部：价格和销量 -->
              <div class="flex items-end justify-between">
                <div>
                  <span class="text-xs text-gray-500"><%= ticket[:provider] %></span>
                  <% if ticket[:sales].present? %>
                    <span class="text-xs text-gray-400 ml-1"><%= ticket[:sales] %></span>
                  <% end %>
                </div>
                <div class="text-right">
                  <span class="text-[#FF5722] font-bold">
                    <span class="text-xs">¥</span><span class="text-lg"><%= ticket[:price] %></span><span class="text-xs"><%= ticket[:price_suffix] %></span>
                  </span>
                </div>
              </div>
            </div>
          </div>
        <% end %>
        
        <!-- 分割线 -->
        <% unless ticket == @tickets.last %>
          <div class="border-b border-gray-100 my-3"></div>
        <% end %>
      <% end %>
    <% end %>
  </div>
</div>
