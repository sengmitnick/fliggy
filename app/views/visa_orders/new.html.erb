<div class="bg-bg-gray min-h-screen pb-24"
     data-controller="visa-order payment-confirmation"
     data-payment-confirmation-amount-value="<%= @total_price %>"
     data-payment-confirmation-user-email-value="<%= current_user.email %>"
     data-payment-confirmation-payment-url-value=""
     data-payment-confirmation-success-url-value="">
  <!-- 顶部导航栏 -->
  <header class="relative z-10 px-4 pt-12 pb-4 flex items-center justify-between">
    <%= link_to visa_path(@country), class: "p-1" do %>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M15 18L9 12L15 6" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <% end %>
    <h1 class="text-lg font-bold">填写订单</h1>
    <div class="w-6"></div>
  </header>

  <!-- 主内容滚动区域 -->
  <main class="relative z-10 px-3 space-y-3">

    <!-- 1. 商品详情卡片 -->
    <div class="bg-white rounded-xl p-4 shadow-card">
      <h2 class="font-bold text-base leading-snug mb-2"><%= @country.name %> · <%= @visa_product.name %></h2>
      
      <div class="flex items-center justify-between text-xs text-text-gray mb-3 bg-gray-50 p-2 rounded">
        <span class="flex-1 truncate"><span class="text-text-light mr-2">套餐说明</span>需要<%= @visa_product.material_count %>项材料，<%= @visa_product.processing_days %>个工作日</span>
        <div class="flex items-center text-text-dark font-medium whitespace-nowrap">
          详情 
          <svg class="w-3 h-3 ml-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>
      </div>

      <div class="flex items-center justify-between text-xs mb-3">
        <div class="flex items-center text-blue-500">
          <svg class="w-3 h-3 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>
          未办理全额退
        </div>
        <div class="flex items-center text-text-dark">
          详情 
          <svg class="w-3 h-3 ml-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>
      </div>

      <div class="flex items-center justify-between pt-3 border-t border-gray-100">
        <div class="flex items-center text-xs text-text-dark font-medium">
          <svg class="w-4 h-4 mr-1 text-text-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
          <%= @visa_product.merchant_name || '专业签证服务商' %> 为你服务
        </div>
        <div class="flex items-center text-xs text-text-gray">
          咨询 
          <svg class="w-3 h-3 ml-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>
      </div>
    </div>

    <!-- 2. 办签人数卡片 -->
    <div class="bg-white rounded-xl p-4 shadow-card">
      <div class="flex justify-between items-center mb-1">
        <span class="font-bold text-base">办签人数</span>
        <span class="font-bold text-base">¥ <%= @unit_price.to_i %><span class="text-sm font-normal">/人</span></span>
      </div>
      
      <div class="flex justify-between items-center mb-4">
        <div class="flex items-center text-xs text-text-light">
          人群及材料详情 
          <svg class="w-3 h-3 ml-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>
        <div class="flex items-center space-x-3" data-controller="passenger-selector">
          <button type="button" class="w-6 h-6 rounded-full border border-gray-300 flex items-center justify-center text-gray-300" data-action="click->passenger-selector#decrease">
            <svg width="12" height="2" viewBox="0 0 12 2"><rect width="12" height="2" fill="currentColor"/></svg>
          </button>
          <span class="font-bold text-lg w-4 text-center" data-passenger-selector-target="count"><%= @traveler_count %></span>
          <button type="button" class="w-6 h-6 rounded-full border border-primary-orange text-primary-orange flex items-center justify-center" data-action="click->passenger-selector#increase">
            <svg width="12" height="12" viewBox="0 0 12 12"><path d="M5 0H7V5H12V7H7V12H5V7H0V5H5V0Z" fill="currentColor"/></svg>
          </button>
        </div>
      </div>

      <% if @visa_product.supports_family %>
      <div class="bg-blue-50 rounded-lg p-3 flex justify-between items-center">
        <div>
          <div class="text-blue-600 font-bold text-sm">家庭办签</div>
          <div class="text-blue-500 text-xs mt-0.5">材料共享 价格更优</div>
        </div>
        <div class="w-12 h-7 bg-gray-200 rounded-full p-1 cursor-pointer transition-colors duration-200 ease-in-out relative">
          <div class="bg-white w-5 h-5 rounded-full shadow-sm transform transition-transform duration-200 ease-in-out translate-x-0"></div>
        </div>
      </div>
      <% end %>
    </div>

    <!-- 3. 流程时长 -->
    <div class="bg-white rounded-xl p-4 shadow-card">
      <h3 class="font-bold text-base mb-2">流程时长 <span class="text-xs font-normal text-text-light ml-1">商家收齐材料后次日起 预计<%= @visa_product.processing_days %>个工作日签证寄出</span></h3>
      
      <!-- 时间轴可视化 -->
      <div class="relative flex justify-between items-start mb-2 px-2">
        <div class="absolute top-3 left-4 right-4 h-[1px] bg-gray-200 -z-10"></div>

        <div class="flex flex-col items-center">
          <div class="w-6 h-6 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center z-10 mb-2">
            <span class="text-xs">¥</span>
          </div>
          <span class="text-xs text-text-dark font-medium">预订支付</span>
          <span class="text-[10px] text-text-light mt-0.5">现在</span>
        </div>

        <div class="flex flex-col items-center">
          <div class="w-6 h-6 rounded-full bg-blue-50 text-blue-400 flex items-center justify-center z-10 mb-2 border border-blue-100">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 10H2"/></svg>
          </div>
          <span class="text-xs text-text-dark">邮寄材料</span>
          <span class="text-[10px] text-text-light mt-0.5">自行安排</span>
        </div>

        <div class="flex flex-col items-center">
          <div class="w-6 h-6 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center z-10 mb-2">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
          </div>
          <span class="text-xs text-text-dark">商家审核</span>
          <span class="text-[10px] text-text-light mt-0.5">3工作日</span>
        </div>

        <div class="flex flex-col items-center">
          <div class="w-6 h-6 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center z-10 mb-2">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"/></svg>
          </div>
          <span class="text-xs text-text-dark">使领馆…</span>
          <span class="text-[10px] text-text-light mt-0.5">6工作日</span>
        </div>

        <div class="flex flex-col items-center">
          <div class="w-6 h-6 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center z-10 mb-2">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          </div>
          <span class="text-xs text-text-dark">寄回签证</span>
          <span class="text-[10px] text-text-light mt-0.5">0工作日</span>
        </div>
      </div>

      <div class="bg-gray-50 rounded p-3 mt-4 text-xs text-text-gray leading-relaxed">
        支付后按照指定地址邮寄纸质材料。最终以实际办理完成时间为准。
      </div>
    </div>

    <!-- 4. 材料返还 -->
    <div class="bg-white rounded-xl overflow-hidden shadow-card">
      <div class="p-4 pb-2">
        <h3 class="font-bold text-base">材料返还</h3>
      </div>
      
      <div class="bg-red-50 px-4 py-2 mx-4 rounded text-xs text-price-red mb-2">
        签证办理成功后，若涉及护照寄回，将按此地址寄送
      </div>

      <div class="px-4 py-3 flex justify-between items-center border-b border-gray-50">
        <span class="text-text-light text-sm w-20">获取方式</span>
        <div class="flex-1 text-sm font-medium flex justify-between items-center">
          <span>快递 免邮</span>
          <svg class="w-4 h-4 text-gray-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>
      </div>

      <div class="px-4 py-3 flex justify-between items-start">
        <span class="text-text-light text-sm w-20 pt-1">邮寄地址</span>
        <div class="flex-1 text-sm flex justify-between items-center">
          <div>
            <div class="font-bold mb-1"><%= @contact_name %> <%= @contact_phone %></div>
            <div class="text-text-dark leading-tight pr-4"><%= @delivery_address || '请填写邮寄地址' %></div>
          </div>
          <svg class="w-4 h-4 text-gray-300 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>
      </div>
    </div>

    <!-- 5. 留言备注 -->
    <div class="bg-white rounded-xl p-4 shadow-card flex items-center">
      <span class="font-bold text-base w-20">留言备注</span>
      <span class="text-gray-300 text-sm">选填，请先和商家协商一致</span>
    </div>

    <!-- 6. 联系人 -->
    <div class="bg-white rounded-xl p-4 shadow-card">
      <h3 class="font-bold text-base mb-4">联系人</h3>
      
      <div class="flex items-center justify-between border-b border-gray-50 pb-4 mb-4">
        <span class="text-text-light text-sm w-20">姓名</span>
        <div class="flex-1 flex justify-between items-center">
          <span class="text-text-dark text-sm font-medium"><%= @contact_name || '请填写姓名' %></span>
          <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
        </div>
      </div>

      <div class="flex items-center">
        <span class="text-text-light text-sm w-20">手机号</span>
        <span class="text-text-dark text-sm font-medium"><%= @contact_phone || '请填写手机号' %></span>
      </div>
    </div>

    <!-- 7. 保险 -->
    <div class="bg-white rounded-xl overflow-hidden shadow-card">
      <div class="p-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-bold text-base">保险</h3>
          <span class="text-xs text-gray-400">保险由华泰保险承保</span>
        </div>

        <div class="space-y-3">
          <label class="flex items-start p-3 border-2 <%= @insurance_type == 'none' ? 'border-primary' : 'border-gray-200' %> rounded-lg cursor-pointer">
            <input type="radio" name="insurance" value="none" class="mt-1 mr-3" <%= 'checked' if @insurance_type == 'none' %>>
            <div class="flex-1">
              <div class="font-bold text-sm mb-1">不购买保险</div>
            </div>
          </label>

          <label class="flex items-start p-3 border-2 <%= @insurance_type == 'basic' ? 'border-primary' : 'border-gray-200' %> rounded-lg cursor-pointer">
            <input type="radio" name="insurance" value="basic" class="mt-1 mr-3" <%= 'checked' if @insurance_type == 'basic' %>>
            <div class="flex-1">
              <div class="flex justify-between items-center mb-1">
                <div class="font-bold text-sm">基础保障</div>
                <div class="text-primary font-bold">¥50</div>
              </div>
              <div class="text-xs text-gray-500">意外伤害20万，医疗费用5万</div>
            </div>
          </label>

          <label class="flex items-start p-3 border-2 <%= @insurance_type == 'premium' ? 'border-primary' : 'border-gray-200' %> rounded-lg cursor-pointer">
            <input type="radio" name="insurance" value="premium" class="mt-1 mr-3" <%= 'checked' if @insurance_type == 'premium' %>>
            <div class="flex-1">
              <div class="flex justify-between items-center mb-1">
                <div class="font-bold text-sm">尊享保障</div>
                <div class="text-primary font-bold">¥100</div>
              </div>
              <div class="text-xs text-gray-500">意外伤害50万，医疗费用20万，财产保障</div>
            </div>
          </label>
        </div>
      </div>
    </div>

  </main>

  <!-- 底部支付栏 -->
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-footer">
    <div class="flex items-center justify-between mb-3">
      <div class="text-sm text-gray-600">
        实付金额: <span class="text-2xl font-bold text-primary" data-visa-order-target="totalPrice">¥<%= @total_price.to_i %></span>
      </div>
    </div>
    <button type="button" 
            class="w-full bg-primary text-gray-900 font-bold py-3 rounded-full"
            data-action="click->visa-order#submitOrder"
            data-visa-product-id="<%= @visa_product.id %>"
            data-traveler-count="<%= @traveler_count %>"
            data-total-price="<%= @total_price %>"
            data-unit-price="<%= @unit_price %>"
            data-insurance-type="<%= @insurance_type %>"
            data-insurance-price="<%= @insurance_price %>"
            data-contact-name="<%= @contact_name %>"
            data-contact-phone="<%= @contact_phone %>"
            data-delivery-address="<%= @delivery_address %>">
      立刻支付
    </button>
  </div>
</div>

<%= render 'shared/payment_confirmation_modals' %>

<style>
.bg-bg-gray { background-color: #F4F5F7; }
.text-text-dark { color: #111111; }
.text-text-gray { color: #666666; }
.text-text-light { color: #999999; }
.text-price-red { color: #FF4A00; }
.shadow-card { box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
.shadow-footer { box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
</style>
