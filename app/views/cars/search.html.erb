<div class="max-w-md mx-auto bg-white min-h-screen flex flex-col" data-controller="car-search-edit">
  <!-- 顶部导航 & 搜索栏 -->
  <div class="px-4 py-2 sticky top-0 bg-white z-10">
    <div class="flex items-center space-x-3">
      <%= link_to cars_path, class: "flex items-center" do %>
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      <% end %>
      <button 
        type="button"
        data-action="click->car-search-edit#openLocationEditor"
        class="flex-1 bg-gray-100 rounded-lg p-2 flex items-center justify-between hover:bg-gray-200 transition-colors">
        <div class="text-center flex-1">
          <div class="text-xs font-bold" data-car-search-edit-target="cityDisplay">
            <% if params[:city].present? && params[:pickup_location].present? %>
              <%= params[:city] %> <%= params[:pickup_location] %>
            <% elsif params[:city].present? %>
              <%= params[:city] %>
            <% elsif params[:pickup_location].present? %>
              <%= params[:pickup_location] %>
            <% else %>
              全部地点
            <% end %>
          </div>
          <div class="text-[10px] text-gray-500">
            <% if params[:pickup_date].present? && params[:return_date].present? %>
              <%= params[:pickup_date] %> — <%= params[:return_date] %>
            <% else %>
              请选择日期
            <% end %>
          </div>
        </div>
        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
        </svg>
      </button>
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"/>
      </svg>
    </div>

    <!-- 筛选标签 -->
    <div class="flex items-center justify-between mt-4 text-sm text-gray-700" data-controller="car-filter">
      <!-- 推荐排序 -->
      <div class="relative">
        <button 
          type="button"
          data-car-filter-target="sortButton"
          data-action="click->car-filter#toggleSortDropdown"
          class="flex items-center space-x-1 font-medium">
          <span>推荐排序</span>
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
          </svg>
        </button>
        <!-- 下拉列表 -->
        <div 
          data-car-filter-target="sortDropdown"
          class="hidden absolute top-full left-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-100 py-2 w-36 z-20">
          <div data-value="recommend" data-action="click->car-filter#selectSortOption" class="px-4 py-2 hover:bg-gray-50 cursor-pointer text-blue-600 font-bold">推荐排序</div>
          <div data-value="price-low" data-action="click->car-filter#selectSortOption" class="px-4 py-2 hover:bg-gray-50 cursor-pointer text-gray-700">价格从低到高</div>
          <div data-value="price-high" data-action="click->car-filter#selectSortOption" class="px-4 py-2 hover:bg-gray-50 cursor-pointer text-gray-700">价格从高到低</div>
          <div data-value="sales" data-action="click->car-filter#selectSortOption" class="px-4 py-2 hover:bg-gray-50 cursor-pointer text-gray-700">销量优先</div>
        </div>
      </div>

      <!-- 快速选车 -->
      <div class="relative">
        <button 
          type="button"
          data-car-filter-target="quickSelectButton"
          data-action="click->car-filter#toggleQuickSelectDropdown"
          class="flex items-center space-x-1">
          <span>快速选车</span>
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
          </svg>
        </button>
        <!-- 下拉列表 -->
        <div 
          data-car-filter-target="quickSelectDropdown"
          class="hidden absolute top-full left-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-100 py-2 w-40 z-20">
          <div data-value="new-energy" data-action="click->car-filter#selectQuickOption" class="px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center justify-between">
            <span>新能源车</span>
            <input type="checkbox" class="pointer-events-none">
          </div>
          <div data-value="luxury" data-action="click->car-filter#selectQuickOption" class="px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center justify-between">
            <span>豪华车</span>
            <input type="checkbox" class="pointer-events-none">
          </div>
          <div data-value="suv" data-action="click->car-filter#selectQuickOption" class="px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center justify-between">
            <span>SUV</span>
            <input type="checkbox" class="pointer-events-none">
          </div>
          <div data-value="mpv" data-action="click->car-filter#selectQuickOption" class="px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center justify-between">
            <span>MPV</span>
            <input type="checkbox" class="pointer-events-none">
          </div>
        </div>
      </div>

      <!-- 价格服务 -->
      <div class="relative">
        <button 
          type="button"
          data-car-filter-target="priceServiceButton"
          data-action="click->car-filter#togglePriceServiceDropdown"
          class="flex items-center space-x-1">
          <span>价格服务</span>
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
          </svg>
        </button>
        <!-- 下拉列表 -->
        <div 
          data-car-filter-target="priceServiceDropdown"
          class="hidden absolute top-full right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-100 py-2 w-40 z-20">
          <div data-value="free-cancel" data-action="click->car-filter#selectPriceOption" class="px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center justify-between">
            <span>免费取消</span>
            <input type="checkbox" class="pointer-events-none">
          </div>
          <div data-value="no-deposit" data-action="click->car-filter#selectPriceOption" class="px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center justify-between">
            <span>免押金</span>
            <input type="checkbox" class="pointer-events-none">
          </div>
          <div data-value="insurance" data-action="click->car-filter#selectPriceOption" class="px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center justify-between">
            <span>小伤免赔</span>
            <input type="checkbox" class="pointer-events-none">
          </div>
          <div data-value="discount" data-action="click->car-filter#selectPriceOption" class="px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center justify-between">
            <span>特惠优惠</span>
            <input type="checkbox" class="pointer-events-none">
          </div>
        </div>
      </div>

      <div class="bg-gray-100 rounded-full px-3 py-1 flex items-center space-x-1">
        <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <span class="text-xs text-gray-400">搜车型</span>
      </div>
    </div>

    <!-- 横向滑动快捷选项 -->
    <div class="flex space-x-2 mt-4 overflow-x-auto no-scrollbar pb-1 text-xs">
      <span class="bg-gray-100 px-3 py-1.5 rounded flex-shrink-0">今日特价</span>
      <span class="bg-gray-100 px-3 py-1.5 rounded flex-shrink-0">神州特惠</span>
      <span class="bg-gray-100 px-3 py-1.5 rounded flex-shrink-0">一嗨特惠</span>
      <span class="bg-gray-100 px-3 py-1.5 rounded flex-shrink-0">新能源车</span>
      <span class="bg-gray-100 px-3 py-1.5 rounded flex-shrink-0">小伤免赔</span>
    </div>
  </div>

  <!-- 主体内容：侧边栏 + 车辆列表 -->
  <div class="flex flex-1 overflow-hidden">
    <!-- 左侧分类 -->
    <div class="w-20 bg-gray-50 flex flex-col text-xs text-gray-500 overflow-y-auto no-scrollbar">
      <%= link_to search_cars_path(city: params[:city], pickup_location: params[:pickup_location], return_location: params[:return_location], pickup_date: params[:pickup_date], return_date: params[:return_date]), class: "bg-white py-4 px-2 border-l-4 border-white font-bold text-gray-900 leading-tight" do %>
        全部车型<br><span class="text-[10px] font-normal">¥<%= @cars.minimum(:price_per_day) || 0 %>起</span>
      <% end %>
      
      <% @categories.each do |category, count| %>
        <%= link_to search_cars_path(category: category, city: params[:city], pickup_location: params[:pickup_location], return_location: params[:return_location], pickup_date: params[:pickup_date], return_date: params[:return_date]), class: "py-4 px-2 leading-tight #{params[:category] == category ? 'bg-white font-bold text-gray-900' : ''}" do %>
          <%= category %><br>
          <span class="text-[10px]">
            ¥<%= Car.where(category: category, is_available: true).minimum(:price_per_day) || 0 %>起
          </span>
        <% end %>
      <% end %>
    </div>

    <!-- 右侧列表 -->
    <div class="flex-1 bg-gray-100 p-2 overflow-y-auto space-y-3">
      <% @cars.each do |car| %>
        <%= link_to car_path(car, city: params[:city], pickup_location: params[:pickup_location], return_location: params[:return_location], pickup_date: params[:pickup_date], return_date: params[:return_date], sort: params[:sort], quick_select: params[:quick_select], price_service: params[:price_service]), class: "block" do %>
          <div class="bg-white rounded-xl p-3 relative shadow-sm">
            <!-- 标签 -->
            <% if car.tags.present? && car.tags.include?('销量第一') %>
              <div class="absolute top-0 left-0 bg-orange-100 text-orange-600 text-[10px] px-2 py-0.5 rounded-br-lg rounded-tl-xl">销量第一</div>
            <% elsif car.tags.present? && car.tags.include?('总价最低') %>
              <div class="absolute top-0 left-0 bg-red-50 text-red-500 text-[10px] px-2 py-0.5 rounded-br-lg rounded-tl-xl">总价最低</div>
            <% end %>

            <div class="flex items-start">
              <div class="w-32 h-20 bg-gray-50 rounded overflow-hidden relative">
                <% if car.image_url.present? %>
                  <%= image_tag car.image_url, alt: "#{car.brand} #{car.car_model}", class: "w-full h-full object-cover" %>
                <% else %>
                  <!-- 汽车占位图 -->
                  <div class="flex items-center justify-center h-full text-gray-300">
                    <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 10l1.5-4.5h11L19 10H5z"/>
                    </svg>
                  </div>
                <% end %>
                <% if car.tags.present? && car.tags.include?('VR看车') %>
                  <div class="absolute bottom-1 right-1 bg-black/20 text-white text-[8px] px-1 rounded-full italic">VR</div>
                <% end %>
              </div>
              <div class="ml-3 flex-1">
                <div class="text-sm font-bold"><%= car.brand %><%= car.car_model %></div>
                <div class="text-[10px] text-gray-400 mt-1"><%= car.features %></div>
              </div>
            </div>

            <div class="mt-4 flex flex-col items-end">
              <div class="text-red-500 font-bold">
                <span class="text-xs">¥</span>
                <span class="text-lg"><%= car.price_per_day.to_i %></span>
                <span class="text-xs text-gray-400 font-normal">/天</span>
              </div>
              <div class="flex items-center space-x-1 mt-1">
                <% if car.tags.present? && car.tags.include?('机车特惠') %>
                  <span class="text-[10px] text-orange-500 border border-orange-200 px-1 rounded">机车特惠</span>
                <% end %>
                <% if car.discount_amount > 0 %>
                  <span class="text-[10px] text-orange-500">已优惠 ¥<%= car.discount_amount.to_i %></span>
                <% end %>
                <span class="text-[10px] text-gray-400 ml-1">总价¥<%= car.total_price.to_i %>起</span>
                <svg class="w-3 h-3 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                </svg>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
  
  <!-- Car Search Form Modal -->
  <%= render 'shared/car_search_form_modal' %>
</div>

<style>
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>

<!-- Location Selector Modal -->
<div data-controller="location-selector" data-location-selector-api-endpoint-value="/cars/locations">
  <%= render 'shared/location_selector_modal' %>
</div>

<!-- City Selector Modal -->
<div data-controller="city-selector" data-city-selector-enable-multi-select-value="false">
  <%= render 'shared/city_selector_modal' %>
</div>

<!-- Datetime Picker Modal -->
<div data-controller="car-datetime-picker">
  <%= render 'shared/car_datetime_picker_modal' %>
</div>
