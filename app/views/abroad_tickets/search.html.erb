<div class="w-full max-w-[430px] mx-auto bg-surface min-h-screen relative shadow-2xl flex flex-col" data-controller="abroad-date-picker abroad-ticket-search" data-abroad-ticket-search-current-date-value="<%= @date.to_s %>" data-abroad-date-picker-current-date-value="<%= @date.to_s %>">
  
  <!-- App 头部导航 -->
  <div class="bg-white px-4 py-3 flex items-center justify-between sticky top-0 z-20">
    <%= link_to abroad_tickets_path, class: "p-1" do %>
      <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
    <% end %>
    <div class="flex items-center gap-2 font-bold text-lg text-gray-900 cursor-pointer" data-action="click->abroad-ticket-search#openRouteEditor">
      <span><%= @origin %></span>
      <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
      </svg>
      <span><%= @destination %></span>
      <svg class="w-3 h-3 text-gray-800 fill-current" viewBox="0 0 20 20">
        <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
      </svg>
    </div>
    <button class="p-1">
      <svg class="w-6 h-6 text-gray-800" fill="currentColor" viewBox="0 0 24 24">
        <circle cx="5" cy="12" r="2" />
        <circle cx="12" cy="12" r="2" />
        <circle cx="19" cy="12" r="2" />
      </svg>
    </button>
  </div>

  <!-- 日期选择栏 -->
  <div class="bg-white pb-2 flex border-b border-gray-100">
    <div class="flex-1 flex overflow-x-auto hide-scrollbar pl-2 pr-2 items-center" data-abroad-date-picker-target="dateScroll">
      <% @date_range.each do |date| %>
        <% 
          is_selected = date == @date 
          is_past = date < Date.today
        %>
        <% if is_past %>
          <!-- 过去的日期：不可点击，显示为灰色 -->
          <div class="flex-shrink-0 flex flex-col items-center justify-center w-[4.5rem] py-2 cursor-not-allowed">
            <span class="text-xs text-gray-400 line-through">
              <%= date.strftime('%m-%d') %>
            </span>
            <span class="text-sm font-medium text-gray-400">
              <%= ['周日', '周一', '周二', '周三', '周四', '周五', '周六'][date.wday] %>
            </span>
          </div>
        <% else %>
          <!-- 今天及未来的日期：可点击 -->
          <%= link_to search_abroad_tickets_path(region: @region, origin: @origin, destination: @destination, date: date.strftime('%Y-%m-%d')), 
                      class: "flex-shrink-0 flex flex-col items-center justify-center w-[4.5rem] py-2 #{is_selected ? 'bg-[#FFD900] rounded-lg shadow-sm' : ''}",
                      data: { abroad_date_picker_target: is_selected ? 'selectedDate' : '' } do %>
            <span class="text-xs <%= is_selected ? 'text-gray-900 font-semibold' : 'text-gray-400' %>">
              <%= date.strftime('%m-%d') %>
            </span>
            <span class="text-sm font-medium <%= is_selected ? 'text-gray-900 font-bold' : 'text-gray-400' %>">
              <%= ['周日', '周一', '周二', '周三', '周四', '周五', '周六'][date.wday] %>
            </span>
          <% end %>
        <% end %>
      <% end %>
    </div>
    <!-- 日历按钮 -->
    <div class="flex-shrink-0 w-12 flex items-center justify-center border-l border-gray-100 bg-white sticky right-0 shadow-[-10px_0_10px_white] z-10 cursor-pointer"
         data-action="click->abroad-date-picker#openCalendar">
      <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        <circle cx="12" cy="15" r="1" fill="currentColor"/>
      </svg>
    </div>
  </div>

  <!-- 日期选择器 Modal -->
  <%= render 'abroad_tickets/date_picker_modal' %>

  <!-- 路线选择 Modal (完整UI组件) -->
  <div class="fixed inset-0 bg-black/50 z-50 hidden" data-abroad-ticket-search-target="routeModal">
    <div class="absolute inset-0" data-action="click->abroad-ticket-search#closeRouteModal"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl max-h-[85vh] flex flex-col animate-slide-up">
      <!-- Modal Header -->
      <div class="flex items-center justify-between px-4 py-4 border-b border-gray-100 flex-shrink-0">
        <h2 class="text-lg font-bold text-gray-900">修改行程</h2>
        <button type="button" 
                class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100"
                data-action="click->abroad-ticket-search#closeRouteModal">
          <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <!-- 完整路线选择UI -->
      <div class="flex-1 overflow-y-auto px-3 pt-4 pb-6">
        <!-- 白色内容主体 -->
        <div class="bg-white rounded-2xl p-4 pb-6">
          <!-- 车站选择 -->
          <div class="flex justify-between items-center mb-8 px-1">
            <!-- 出发站 -->
            <div class="flex flex-col items-start w-1/3 cursor-pointer" 
                 data-action="click->abroad-ticket-search#selectOrigin">
              <span class="text-[22px] font-bold text-gray-900 leading-tight" data-abroad-ticket-search-target="originText">
                <%= @origin %>
              </span>
              <span class="text-xs text-gray-400 mt-1 font-light">
                <%= @region == 'japan' ? 'Tokyo Station' : 'Paris Nord' %>
              </span>
            </div>

            <!-- 交换图标 -->
            <div class="flex justify-center w-1/3">
              <div class="relative cursor-pointer" data-action="click->abroad-ticket-search#swapStations">
                <!-- 浅绿背景 -->
                <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
                  <circle cx="18" cy="18" r="18" fill="#E8F5E9" opacity="0.6"/>
                </svg>
                <!-- 绿色箭头 -->
                <svg class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 16v-2.38C4 11.5 9.16 8 13.62 8a7 7 0 0 1 2.38.45L13 6"/> 
                  <path d="M15 6l4 4-4 4"/>
                  <path d="M20 8v2.38C20 12.5 14.84 16 10.38 16a7 7 0 0 1-2.38-.45L11 18"/>
                  <path d="M9 18l-4-4 4-4"/>
                </svg>
              </div>
            </div>

            <!-- 到达站 -->
            <div class="flex flex-col items-end w-1/3 cursor-pointer"
                 data-action="click->abroad-ticket-search#selectDestination">
              <span class="text-[22px] font-bold text-gray-900 leading-tight" data-abroad-ticket-search-target="destinationText">
                <%= @destination %>
              </span>
              <span class="text-xs text-gray-400 mt-1 font-light text-right">
                <%= @region == 'japan' ? 'Shin-Osaka Station' : 'Amsterdam Centraal' %>
              </span>
            </div>
          </div>

          <!-- 日期选择 -->
          <div class="flex justify-between items-center py-4 border-b border-gray-100 mb-6 cursor-pointer"
               data-action="click->abroad-ticket-search#openDatePicker">
            <div class="flex items-baseline gap-2">
              <span class="text-2xl font-bold text-gray-900" data-abroad-ticket-search-target="dateText">
                <%= @date.strftime('%-m月%-d日') %>
              </span>
              <span class="text-sm text-gray-500 font-medium">
                <%= ['周日', '周一', '周二', '周三', '周四', '周五', '周六'][@date.wday] %>
              </span>
            </div>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#D1D5DB" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 18l6-6-6-6"/>
            </svg>
          </div>

          <!-- 搜索按钮 -->
          <button type="button" 
                  class="w-full bg-[#FFDD33] text-gray-900 font-bold text-lg py-3.5 rounded-full shadow-[0_2px_10px_rgba(255,221,51,0.3)] hover:bg-[#ffc107] transition-colors tracking-wide cursor-pointer"
                  data-action="click->abroad-ticket-search#submitRouteChange">
            搜索
          </button>
        </div>
      </div>
    </div>
    
    <!-- Station Selection Modal (嵌套在路线选择Modal内) -->
    <div class="fixed inset-0 bg-black/50 z-50 hidden" data-abroad-ticket-search-target="stationModal">
      <div class="absolute inset-0" data-action="click->abroad-ticket-search#closeStationModal"></div>
      <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl max-h-[80vh] flex flex-col animate-slide-up">
        <!-- Modal Header -->
        <div class="flex items-center justify-between px-4 py-4 border-b border-gray-100 flex-shrink-0">
          <h2 class="text-lg font-bold text-gray-900">站点选择</h2>
          <button type="button" 
                  class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100"
                  data-action="click->abroad-ticket-search#closeStationModal">
            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <!-- Search Input -->
        <div class="px-4 py-3 border-b border-gray-100 flex-shrink-0">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
            </div>
            <input type="text" 
                   placeholder="城市中文/英语/拼音"
                   class="w-full pl-10 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-yellow-400"
                   data-abroad-ticket-search-target="searchInput"
                   data-action="input->abroad-ticket-search#searchStations">
          </div>
        </div>

        <!-- Station List -->
        <div class="flex-1 overflow-y-auto" data-abroad-ticket-search-target="stationList">
          <!-- Content will be dynamically rendered by controller -->
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden form inputs for route editing -->
  <input type="hidden" value="<%= @region %>" data-abroad-ticket-search-target="regionInput">
  <input type="hidden" value="<%= @origin %>" data-abroad-ticket-search-target="originInput">
  <input type="hidden" value="<%= @destination %>" data-abroad-ticket-search-target="destinationInput">
  <input type="hidden" value="<%= @date.strftime('%Y-%m-%d') %>" data-abroad-ticket-search-target="dateInput">

  <!-- 内容区域 -->
  <div class="flex-1 overflow-y-auto pb-20">
    
    <!-- 提示语 -->
    <div class="flex justify-between items-end px-4 py-3">
      <h2 class="text-lg font-bold text-gray-900">选择当地<span class="text-primary">意向出发时间段</span></h2>
      <span class="text-[10px] text-gray-400">实际时间以票面为准</span>
    </div>

    <!-- 卡片列表容器 -->
    <div class="px-3 space-y-3">
      <% if @tickets.any? %>
        <% @tickets.each do |ticket| %>
          <%= link_to abroad_ticket_path(ticket, origin: @origin, destination: @destination, date: @date.strftime('%Y-%m-%d')), class: "block" do %>
            <div class="bg-white rounded-xl p-4 relative shadow-sm hover:shadow-md transition">
              <!-- 电子票标签 -->
              <div class="absolute top-4 right-4 border border-gray-300 rounded text-[10px] px-1 text-gray-500">
                电子票
              </div>
              
              <div class="text-sm text-gray-900 mb-1">出发时间段(当地时间)</div>
              
              <div class="flex justify-between items-baseline mt-1">
                <!-- 左侧时间 -->
                <div class="flex items-baseline">
                  <span class="text-[28px] font-bold text-gray-900 font-sans tracking-tight"><%= ticket.time_slot_start %></span>
                  <span class="mx-2 text-sm font-medium text-gray-900">至</span>
                  <span class="text-[28px] font-bold text-gray-900 font-sans tracking-tight"><%= ticket.time_slot_end %></span>
                  <span class="ml-2 text-sm text-gray-900">之间出发</span>
                </div>
                <!-- 右侧价格 -->
                <div class="text-accent font-bold">
                  <span class="text-sm">¥</span>
                  <span class="text-xl"><%= ticket.price.to_i %></span>
                  <span class="text-sm">.<%= sprintf('%02d', (ticket.price % 1 * 100).to_i) %>起</span>
                </div>
              </div>

              <!-- 车站信息 -->
              <div class="flex justify-between items-start mt-1 pr-24">
                <div class="flex flex-col">
                  <span class="text-sm text-gray-800"><%= ticket.origin %></span>
                  <span class="text-[10px] text-gray-400"><%= ticket.origin_en %></span>
                </div>
                
                <!-- 装饰线 -->
                <div class="flex-1 mx-4 h-[1px] bg-gray-200 mt-2.5 relative"></div>

                <div class="flex flex-col text-right">
                  <span class="text-sm text-gray-800"><%= ticket.destination %></span>
                  <span class="text-[10px] text-gray-400"><%= ticket.destination_en %></span>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
      <% else %>
        <div class="bg-white rounded-xl p-8 text-center">
          <div class="text-gray-400 mb-2">
            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
          <p class="text-gray-500">暂无可用班次</p>
          <p class="text-sm text-gray-400 mt-1">请尝试其他日期或路线</p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<style>
  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
