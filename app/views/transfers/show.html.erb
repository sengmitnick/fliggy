<div class="bg-[#F5F5F5] min-h-screen pb-24" data-controller="payment-confirmation"
     data-payment-confirmation-amount-value="<%= @transfer.actual_price.to_i %>"
     data-payment-confirmation-user-email-value="<%= current_user.email %>"
     data-payment-confirmation-payment-url-value="<%= pay_transfer_path(@transfer) %>"
     data-payment-confirmation-success-url-value="<%= success_transfer_path(@transfer) %>">
  <!-- Top Yellow Background Area -->
  <div class="bg-gradient-to-b from-[#FFD821] to-[#FFE366] pb-16">
    
    <!-- Navigation Bar -->
    <div class="flex justify-between items-center px-4 py-2">
      <button onclick="history.back()" class="text-[#111]">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      
      <div class="flex items-center space-x-4">
        <button class="text-[#111]">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
          </svg>
        </button>
        <button class="text-[#111]">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <circle cx="5" cy="12" r="2" />
            <circle cx="12" cy="12" r="2" />
            <circle cx="19" cy="12" r="2" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Title Area -->
    <div class="px-4 mt-2">
      <h1 class="text-2xl font-bold text-[#111] mb-1"><%= @transfer.driver_status_text %></h1>
      <p class="text-sm text-[#333] opacity-80">
        <%= @transfer.driver_accepted? ? '司机将按时为您提供服务，用车前1小时可查看司机位置或状态' : '司机正在确认订单，请耐心等待' %>
      </p>
    </div>
  </div>

  <!-- Main Content Area (Card Stack) -->
  <div class="px-3 -mt-10 space-y-3 relative z-10">

    <!-- Flight/Train Info Card -->
    <% if @transfer.flight_number.present? %>
      <div class="bg-surface rounded-xl p-4 shadow-sm">
        <div class="flex items-center text-sm">
          <span class="bg-[#41AD65] text-white text-xs px-1.5 py-0.5 rounded mr-2">航班正常</span>
          <span class="font-bold text-text-primary text-base mr-1"><%= @transfer.flight_number %></span>
          <span class="text-text-secondary">预计<%= @transfer.pickup_datetime&.strftime('%m月%d日%H:%M') %>出发</span>
        </div>
        <div class="mt-2 text-xs text-text-muted">
          司机将准时为您服务
        </div>
      </div>
    <% elsif @transfer.train_number.present? %>
      <div class="bg-surface rounded-xl p-4 shadow-sm">
        <div class="flex items-center text-sm">
          <span class="bg-[#41AD65] text-white text-xs px-1.5 py-0.5 rounded mr-2">正常运行</span>
          <span class="font-bold text-text-primary text-base mr-1"><%= @transfer.train_number %></span>
          <span class="text-text-secondary">预计<%= @transfer.pickup_datetime&.strftime('%m月%d日%H:%M') %>出发</span>
        </div>
        <div class="mt-2 text-xs text-text-muted">
          司机将准时为您服务
        </div>
      </div>
    <% end %>

    <!-- Vehicle and Driver Info Card -->
    <div class="bg-surface rounded-xl shadow-sm overflow-hidden">
      <!-- Top Green Tip Bar -->
      <% if @transfer.paid? %>
        <div class="bg-[#E7F7F0] px-4 py-2.5 flex justify-between items-center">
          <span class="text-[#00B578] text-xs font-medium">
            <%= (@transfer.pickup_datetime - 1.hour).strftime('%Y年%m月%d日 %H:%M') %>前可以免费取消
          </span>
          <div class="flex items-center text-text-muted text-xs">
            取消规则 
            <svg class="w-3 h-3 ml-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        </div>
      <% end %>

      <div class="p-4 relative">
        <!-- Vehicle Info -->
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <div class="flex items-baseline space-x-2 mb-1">
              <h2 class="text-xl font-bold text-[#111]">
                <%= @transfer.license_plate || '粤BAE8055' %> · <%= @transfer.vehicle_type || '白色' %>
              </h2>
            </div>
            <div class="text-sm text-text-primary font-medium mb-1">
              <%= @transfer.driver_name || '张师傅' %>
            </div>
            <div class="text-xs text-text-muted flex items-center mb-3">
              <%= @transfer.transfer_package&.category_name || '经济5座' %> · 
              <%= @transfer.transfer_package&.recommended_seats || 4 %>乘客(含儿童) · 
              <%= @transfer.transfer_package&.recommended_luggage || 2 %>行李 
              <svg class="w-3 h-3 ml-1 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <!-- Tags -->
            <% @transfer.transfer_package&.features_list&.each do |feature| %>
              <div class="inline-block border border-blue-200 text-blue-500 text-[10px] px-1 py-0.5 rounded bg-blue-50 mr-1">
                <%= feature %>
              </div>
            <% end %>
          </div>
          
          <!-- Vehicle Image Placeholder -->
          <div class="w-24 flex flex-col items-end">
            <div class="w-24 h-12 relative mb-1">
              <svg viewBox="0 0 100 50" class="w-full h-full drop-shadow-sm">
                <path d="M10,35 Q10,20 25,18 L35,10 L65,10 L75,18 Q90,20 90,35 H10 Z" fill="#F0F0F0" stroke="#DDD"/>
                <circle cx="25" cy="35" r="5" fill="#555" />
                <circle cx="75" cy="35" r="5" fill="#555" />
                <path d="M36,12 L64,12 L72,18 L28,18 Z" fill="#333" opacity="0.2"/>
              </svg>
            </div>
            <div class="flex items-center bg-white border border-border shadow-sm rounded px-1 py-0.5">
              <span class="bg-[#FF6600] text-white text-[10px] font-bold px-0.5 rounded-sm mr-1">
                <%= @transfer.provider_name&.first(2) || '阳光' %>
              </span>
              <span class="text-[10px] text-text-secondary"><%= @transfer.provider_name || '阳光出行' %></span>
            </div>
          </div>
        </div>

        <!-- Divider -->
        <div class="h-px w-full bg-border my-4"></div>

        <!-- Action Buttons Grid -->
        <div class="grid grid-cols-4 gap-2">
          <div class="flex flex-col items-center justify-center space-y-1" onclick="window.showToast('精彩即将上线，敬请期待')">
            <svg class="w-6 h-6 text-text-primary" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
            </svg>
            <span class="text-xs text-text-primary">联系司机</span>
          </div>
          <div class="flex flex-col items-center justify-center space-y-1" onclick="window.showToast('精彩即将上线，敬请期待')">
            <svg class="w-6 h-6 text-text-primary" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <span class="text-xs text-text-primary">修改订单</span>
          </div>
          <%= button_to cancel_transfer_path(@transfer), method: :patch, class: "flex flex-col items-center justify-center space-y-1", form: { data: { turbo_confirm: '确认取消订单？' } } do %>
            <svg class="w-6 h-6 text-text-primary" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span class="text-xs text-text-primary">取消订单</span>
          <% end %>
          <div class="flex flex-col items-center justify-center space-y-1" onclick="window.showToast('精彩即将上线，敬请期待')">
            <svg class="w-6 h-6 text-text-primary" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span class="text-xs text-text-primary">我要发票</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Trip Info Card -->
    <div class="bg-surface rounded-xl p-4 shadow-sm">
      <div class="flex items-center mb-4">
        <span class="text-xl font-bold text-[#111] mr-2">
          <%= @transfer.pickup_datetime&.strftime('%m月%d日%H:%M') %>
        </span>
        <span class="text-base text-[#111]"><%= @transfer.service_name %></span>
      </div>
      
      <div class="relative pl-4 space-y-6">
        <div class="absolute left-[5px] top-2 bottom-3 w-0.5 bg-border"></div>

        <!-- Start Point -->
        <div class="relative">
          <div class="absolute -left-4 top-1.5 w-2.5 h-2.5 rounded-full bg-[#6D81F6] border-2 border-white shadow-sm"></div>
          <div class="text-text-primary text-[15px]"><%= @transfer.location_from %></div>
        </div>

        <!-- End Point -->
        <div class="relative">
          <div class="absolute -left-4 top-1.5 w-2.5 h-2.5 rounded-full bg-[#FF9343] border-2 border-white shadow-sm"></div>
          <div class="text-text-primary text-[15px] font-medium"><%= @transfer.location_to %></div>
        </div>
      </div>
    </div>

    <!-- Price Card -->
    <div class="bg-surface rounded-xl p-4 shadow-sm flex justify-between items-center">
      <div class="flex items-baseline">
        <span class="text-base font-bold text-text-primary mr-1">总额</span>
        <span class="text-xl font-bold text-[#FF5000]">¥<%= @transfer.actual_price.to_i %></span>
      </div>
      <div class="flex items-center text-xs text-text-muted" onclick="window.showToast('精彩即将上线，敬请期待')">
        明细 
        <svg class="w-3 h-3 ml-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </div>
    </div>

    <!-- Payment Button (if pending) -->
    <% if @transfer.pending? %>
      <div class="bg-surface rounded-xl p-4 shadow-sm">
        <button type="button" 
                class="w-full bg-gradient-to-r from-[#FF9B00] to-[#FF5000] text-white font-bold text-lg py-3 rounded-full shadow-lg"
                data-action="click->payment-confirmation#showPasswordModal">
          立即支付
        </button>
      </div>
    <% end %>

    <!-- Passenger Info Card -->
    <div class="bg-surface rounded-xl p-4 shadow-sm">
      <h3 class="font-bold text-[#111] text-base mb-4">乘客信息</h3>
      <div class="space-y-3">
        <div class="flex">
          <span class="w-24 text-text-muted text-sm">乘车人</span>
          <span class="text-[#111] text-sm"><%= @transfer.passenger_name %></span>
        </div>
        <div class="flex items-center">
          <span class="w-24 text-text-muted text-sm">乘车人手机号</span>
          <span class="text-[#111] text-sm mr-2"><%= @transfer.passenger_phone %></span>
          <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
          </svg>
        </div>
      </div>
    </div>

    <!-- Order Info Card -->
    <div class="bg-surface rounded-xl p-4 shadow-sm">
      <h3 class="font-bold text-[#111] text-base mb-3">订单信息</h3>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-text-muted">订单号</span>
          <span class="text-text-primary"><%= @transfer.id %></span>
        </div>
        <div class="flex justify-between">
          <span class="text-text-muted">下单时间</span>
          <span class="text-text-primary"><%= @transfer.created_at.strftime('%Y-%m-%d %H:%M') %></span>
        </div>
        <div class="flex justify-between">
          <span class="text-text-muted">订单状态</span>
          <span class="text-[#00B578] font-medium"><%= @transfer.status_text %></span>
        </div>
        <% if @transfer.paid? || @transfer.completed? %>
          <div class="flex justify-between">
            <span class="text-text-muted">司机状态</span>
            <span class="<%= @transfer.driver_status == 'accepted' ? 'text-[#00B578]' : 'text-[#FF9B00]' %> font-medium">
              <%= @transfer.driver_status_text %>
            </span>
          </div>
        <% end %>
      </div>
    </div>

  </div>

  <!-- Bottom Fixed Bar -->
  <div class="fixed bottom-0 left-0 right-0 bg-surface border-t border-border flex items-center justify-between px-4 py-3 z-50 text-sm">
    <button class="flex items-center justify-center space-x-2 flex-1 border-r border-border" onclick="window.showToast('精彩即将上线，敬请期待')">
      <span class="w-6 h-6 rounded-full border border-orange-300 flex items-center justify-center text-orange-400">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
        </svg>
      </span>
      <span class="text-[#111] font-medium">联系客服</span>
    </button>
    <button class="flex items-center justify-center space-x-2 flex-1" onclick="window.showToast('精彩即将上线，敬请期待')">
      <svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414"></path>
      </svg>
      <span class="text-[#111] font-medium">联系商家</span>
    </button>
  </div>

  <!-- Payment Modal -->
  <%= render 'shared/payment_confirmation_modals', payable: @transfer, payable_type: 'transfer' %>
</div>

<% if params[:pay_now] == 'true' %>
  <script>
    document.addEventListener('turbo:load', function autoTriggerPayment() {
      // Poll for controller readiness with exponential backoff
      let attempts = 0;
      const maxAttempts = 20; // Max 2 seconds (20 * 100ms)
      
      const tryTriggerPayment = () => {
        attempts++;
        
        // Get the payment controller element
        const paymentElement = document.querySelector('[data-controller*="payment-confirmation"]');
        if (!paymentElement) {
          if (attempts < maxAttempts) {
            setTimeout(tryTriggerPayment, 100);
            return;
          }
          console.error('Payment confirmation controller element not found after ' + attempts + ' attempts');
          return;
        }
        
        // Get Stimulus app and controller instance
        const app = window.Stimulus;
        if (!app) {
          if (attempts < maxAttempts) {
            setTimeout(tryTriggerPayment, 100);
            return;
          }
          console.error('Stimulus not found after ' + attempts + ' attempts');
          return;
        }
        
        const paymentController = app.getControllerForElementAndIdentifier(paymentElement, 'payment-confirmation');
        
        // Check if controller is ready AND has targets registered
        if (paymentController && 
            typeof paymentController.showPasswordModal === 'function' && 
            paymentController.hasPasswordModalTarget) {
          // Controller is fully ready with all targets - trigger payment
          console.log('Payment modal auto-triggered after ' + attempts + ' attempts (' + (attempts * 100) + 'ms)');
          paymentController.showPasswordModal();
        } else if (attempts < maxAttempts) {
          // Controller not ready yet, try again
          setTimeout(tryTriggerPayment, 100);
          return;
        } else {
          console.error('Payment controller not ready after ' + attempts + ' attempts (' + (attempts * 100) + 'ms)');
          console.error('Controller exists:', !!paymentController);
          console.error('Has showPasswordModal:', typeof paymentController?.showPasswordModal === 'function');
          console.error('Has passwordModalTarget:', paymentController?.hasPasswordModalTarget);
        }
      };
      
      // Start polling after initial delay
      setTimeout(tryTriggerPayment, 200);
      
      // Remove the event listener after first execution to prevent duplicate triggers
      document.removeEventListener('turbo:load', autoTriggerPayment);
    });
  </script>
<% end %>
