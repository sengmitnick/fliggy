<div class="bg-[#f5f6fa] pb-24 text-[#333]" data-controller="abroad-order-form">

  <!-- 顶部导航栏 -->
  <div class="bg-white sticky top-0 z-50 flex items-center justify-between px-4 py-3 border-b border-gray-100">
    <%= link_to :back, class: "text-gray-800" do %>
      <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
      </svg>
    <% end %>
    <h1 class="text-lg font-medium text-gray-900">填写订单</h1>
    <div class="w-6"></div>
  </div>

  <!-- 主要内容区域 -->
  <div class="p-3 space-y-3">

    <!-- 票务信息卡片 -->
    <div class="bg-white rounded-xl p-4 shadow-sm">
      <div class="mb-4">
        <h2 class="text-lg font-bold text-gray-900 leading-tight">
          <%= @ticket.departure_date.strftime('%m月%d日') %> 
          <%= @ticket.time_slot_start %>至<%= @ticket.time_slot_end %>之间 
          <span class="text-base font-normal">(当地时间)</span>
        </h2>
      </div>
      
      <div class="space-y-2 text-[15px]">
        <div class="flex">
          <span class="text-gray-400 w-20 flex-shrink-0">起终站点</span>
          <span class="text-gray-900 font-medium"><%= @ticket.origin %> - <%= @ticket.destination %></span>
        </div>
        <div class="flex">
          <span class="text-gray-400 w-20 flex-shrink-0">座席类型</span>
          <span class="text-gray-900"><%= @order.seat_category %>|普通车厢(二等座)</span>
        </div>
        <div class="flex">
          <span class="text-gray-400 w-20 flex-shrink-0">乘客类型</span>
          <span class="text-gray-900"><%= @order.passenger_type.gsub('adult', '成人').gsub('child', '儿童') %></span>
        </div>
        <div class="flex items-start">
          <span class="text-gray-400 w-20 flex-shrink-0 mt-0.5">车票类型</span>
          <div class="flex-1 flex justify-between items-start">
            <span class="text-gray-900">持出票二维码至指定地点换领实体票</span>
            <div class="flex items-center text-gray-500 text-xs mt-1">
              <span>预订须知</span>
              <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3 ml-0.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4 pt-3 border-t border-dashed border-gray-200">
        <p class="text-primary text-sm">出票后出发日前1天12点前未兑票 可在线退款</p>
      </div>
    </div>

    <!-- 服务流程 -->
    <div class="bg-white rounded-xl p-4 shadow-sm">
      <div class="mb-4">
        <h3 class="font-bold text-gray-900">服务流程</h3>
      </div>
      <div class="relative flex justify-between items-start px-2">
        <!-- 连线背景 -->
        <div class="absolute top-3 left-6 right-6 h-[1px] bg-gray-100 -z-0"></div>

        <!-- 步骤 -->
        <% [
          { icon: '¥', label: '下单付款' },
          { icon: '📄', label: '等待出票' },
          { icon: '✓', label: '获取二维码' },
          { icon: '★', label: '线下取票' }
        ].each_with_index do |step, index| %>
          <div class="flex flex-col items-center z-10 w-1/4">
            <div class="w-6 h-6 rounded-full bg-[#1aa5ba] flex items-center justify-center text-white text-xs mb-2 <%= index == 0 ? '' : 'opacity-60' %>">
              <%= step[:icon] %>
            </div>
            <span class="text-xs text-gray-800"><%= step[:label] %></span>
          </div>
        <% end %>
      </div>
    </div>

    <!-- 留言备注 -->
    <div class="bg-white rounded-xl px-4 py-4 shadow-sm flex items-center">
      <span class="font-bold text-gray-900 w-20 flex-shrink-0">留言备注</span>
      <input type="hidden" id="abroad_ticket_id" value="<%= @ticket.id %>">
      <input type="hidden" id="passenger_type" value="<%= @order.passenger_type %>">
      <input type="hidden" id="seat_category" value="<%= @order.seat_category %>">
      <input type="hidden" id="total_price" value="<%= @total_price %>">
      <input type="text" id="notes" placeholder="选填,请先和商家协商一致" class="flex-1 outline-none text-[15px] placeholder-gray-300">
    </div>

    <!-- 联系人信息 -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
      <div class="px-4 py-4 border-b border-gray-100">
        <h3 class="font-bold text-gray-900">联系人</h3>
      </div>
      
      <div class="pl-4">
        <!-- 姓名 -->
        <div class="flex items-center py-4 border-b border-gray-100 pr-4">
          <span class="text-gray-400 w-16 flex-shrink-0">姓名</span>
          <input type="text" id="passenger_name" placeholder="请输入姓名(如韩梅梅)" class="flex-1 outline-none text-[15px] placeholder-gray-300" data-abroad-order-form-target="nameInput">
          <div class="text-primary cursor-pointer" data-action="click->abroad-order-form#openPassengerSelector">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </div>
        </div>

        <!-- 手机号 -->
        <div class="flex items-center py-4 border-b border-gray-100 pr-4">
          <span class="text-gray-400 w-16 flex-shrink-0">手机号</span>
          <div class="flex items-center mr-3">
            <span class="text-gray-900 font-medium">+86</span>
            <svg viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3 text-gray-300 ml-1">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
            </svg>
          </div>
          <div class="w-[1px] h-4 bg-gray-300 mr-3"></div>
          <input type="text" id="contact_phone" placeholder="用于接收确认短信" class="flex-1 outline-none text-[15px] placeholder-gray-300" data-abroad-order-form-target="phoneInput">
        </div>

        <!-- 邮箱 -->
        <div class="flex items-center py-4 pr-4">
          <span class="text-gray-400 w-16 flex-shrink-0">邮箱</span>
          <input type="text" id="contact_email" placeholder="用于接收确认邮件，请输入常用邮箱" class="flex-1 outline-none text-[15px] placeholder-gray-300" data-abroad-order-form-target="emailInput">
        </div>
      </div>
    </div>

    <!-- 优惠 -->
    <div class="bg-white rounded-xl px-4 py-4 shadow-sm flex justify-between items-center">
      <span class="text-gray-400">优惠</span>
      <span class="text-gray-400">无优惠可用</span>
    </div>
  </div>

  <!-- 底部悬浮栏 -->
  <div class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)] px-4 py-2 flex items-center justify-between z-50">
    <div class="flex flex-col">
      <div class="flex items-baseline text-accent">
        <span class="text-sm font-bold">¥</span>
        <span class="text-2xl font-semibold mx-0.5"><%= @total_price.to_i %></span>
        <span class="text-sm font-bold">.<%= sprintf('%02d', (@total_price % 1 * 100).to_i) %></span>
      </div>
      <div class="flex items-center text-gray-500 text-xs">
        <span>含出票费总价</span>
      </div>
    </div>
    
    <div class="flex items-center space-x-3">
      <div class="flex items-center text-gray-500 text-xs mr-1">
        <span>明细</span>
        <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3 ml-0.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
        </svg>
      </div>
      <%= button_tag "立即预订", type: "button", class: "bg-gradient-to-r from-[#ff8b2e] to-[#ff4e2e] text-white font-bold text-lg px-8 py-2.5 rounded-full shadow-lg shadow-orange-200 active:scale-95 transition-transform cursor-pointer",
          data: { 
            action: "click->abroad-order-form#submitOrder",
            abroad_ticket_id: @ticket.id,
            total_price: @total_price
          } %>
    </div>
  </div>

  <!-- Passenger Selector Modal -->
  <div id="passengerSelectorModal" class="fixed inset-0 bg-black/60 z-50 hidden backdrop-blur-[1px]" data-abroad-order-form-target="modal">
    <div class="absolute bottom-0 left-0 w-full bg-surface-alt rounded-t-2xl transform transition-transform duration-300">
      <div class="relative bg-white rounded-t-2xl px-4 py-4 border-b border-gray-100">
        <h3 class="text-center text-lg font-medium text-black">请选择联系人</h3>
        <button class="absolute right-4 top-4 text-gray-500 hover:text-gray-700" data-action="click->abroad-order-form#closePassengerSelector">
          <svg class="w-6 h-6 border border-gray-800 rounded-full p-1 text-black" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="p-4 h-[400px] bg-white overflow-y-auto">
        <% if @passengers.any? %>
          <% @passengers.each do |passenger| %>
            <div class="flex items-center justify-between bg-surface p-4 rounded-lg mb-2 cursor-pointer hover:bg-gray-100"
                 data-action="click->abroad-order-form#selectPassenger"
                 data-abroad-order-form-name-param="<%= passenger.name %>"
                 data-abroad-order-form-phone-param="<%= passenger.phone %>">
              <div class="flex flex-col">
                <span class="text-base font-bold text-gray-900 mb-1"><%= passenger.name %></span>
                <span class="text-sm text-gray-500"><%= passenger.phone %></span>
              </div>
              <div class="w-6 h-6 rounded-full border border-gray-300"></div>
            </div>
          <% end %>
        <% else %>
          <div class="text-center text-gray-400 py-8">
            <p>暂无常用出行人</p>
            <p class="text-sm mt-2">您可以在常用信息中添加</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

</div>

<!-- Payment Confirmation Controller Wrapper -->
<div data-controller="payment-confirmation"
     data-payment-confirmation-amount-value="<%= @total_price.to_i %>"
     data-payment-confirmation-user-email-value="<%= current_user.email %>"
     data-payment-confirmation-payment-url-value=""
     data-payment-confirmation-success-url-value="">
  <!-- Payment Confirmation Modals -->
  <%= render 'shared/payment_confirmation_modals' %>
</div>
