# éªŒè¯æ•°æ®åŒ…è¯´æ˜

## ğŸ¯ ç»Ÿä¸€æ•°æ®ç®¡ç†ç­–ç•¥

**æ‰€æœ‰æ•°æ®é€šè¿‡ data_packs ç‰ˆæœ¬åŒ–ç®¡ç†ï¼Œprepare é˜¶æ®µè‡ªåŠ¨åŠ è½½æœ€æ–°ç‰ˆæœ¬ä¸‹çš„æ‰€æœ‰æ•°æ®åŒ…**

```
app/validators/support/data_packs/v1/
â”œâ”€â”€ base.rb                    # åŸºç¡€æ•°æ®ï¼ˆCity, Destination, Demoç”¨æˆ·ï¼‰
â”œâ”€â”€ flights.rb                 # èˆªç­æ•°æ®
â”œâ”€â”€ hotels.rb                  # é…’åº—æ•°æ®
â”œâ”€â”€ hotels_seed.rb             # é…’åº—ç§å­æ•°æ®
â”œâ”€â”€ trains.rb                  # ç«è½¦æ•°æ®ï¼ˆå¦‚éœ€è¦å¯åˆ›å»ºï¼‰
â”œâ”€â”€ cars.rb                    # æ±½è½¦ç§Ÿèµæ•°æ®
â”œâ”€â”€ bus_tickets.rb             # å·´å£«ç¥¨æ•°æ®
â”œâ”€â”€ tour_group_products.rb     # è·Ÿå›¢æ¸¸æ•°æ®
â”œâ”€â”€ abroad_tickets.rb          # å¢ƒå¤–ç¥¨åŠ¡æ•°æ®
â”œâ”€â”€ abroad_shopping.rb         # å¢ƒå¤–è´­ç‰©æ•°æ®
â”œâ”€â”€ deep_travel.rb             # æ·±åº¦æ¸¸æ•°æ®
â”œâ”€â”€ hotel_packages.rb          # é…’åº—å¥—é¤æ•°æ®
â””â”€â”€ internet_services.rb       # äº’è”ç½‘æœåŠ¡æ•°æ®

db/seeds.rb                    # ç©ºå…¥å£ï¼Œä»…æä¾›ä½¿ç”¨è¯´æ˜
```

## æ ¸å¿ƒç†å¿µ

### 1. åˆå§‹çŠ¶æ€ï¼šæ•°æ®åº“ä¸ºç©º

é¡¹ç›®å¯åŠ¨åï¼Œæ•°æ®åº“é»˜è®¤ä¸ºç©ºï¼Œæ— ä»»ä½•é¢„ç½®æ•°æ®ã€‚

### 2. è‡ªåŠ¨å…¨é‡åŠ è½½ç­–ç•¥

- **åŸºç¡€æ•°æ®**ï¼ˆCity, Destinationï¼‰ï¼šéªŒè¯å™¨è¿è¡Œæ—¶è‡ªåŠ¨åŠ è½½ï¼ˆ`ensure_checkpoint`ï¼‰
- **ä¸šåŠ¡æ•°æ®**ï¼ˆæ‰€æœ‰å…¶ä»–æ•°æ®åŒ…ï¼‰ï¼šprepare é˜¶æ®µè‡ªåŠ¨åŠ è½½ v1 ç›®å½•ä¸‹çš„æ‰€æœ‰ .rb æ–‡ä»¶
- **ç”¨æˆ·æ•°æ®**ï¼ˆè®¢å•ã€ä¹˜å®¢ç­‰ï¼‰ï¼šéªŒè¯è¿‡ç¨‹ä¸­äº§ç”Ÿï¼ŒéªŒè¯åæ¸…é™¤

### 3. ç‰ˆæœ¬åŒ–ç®¡ç†

å½“å‰ä½¿ç”¨ç‰ˆæœ¬ï¼š`v1`ï¼ˆå®šä¹‰åœ¨ `BaseValidator::DATA_PACK_VERSION`ï¼‰

- æ‰€æœ‰éªŒè¯å™¨å…±äº«ç›¸åŒç‰ˆæœ¬çš„æ•°æ®åŒ…
- éœ€è¦å‡çº§æ—¶ï¼Œåˆ›å»º v2 ç›®å½•ï¼Œä¿®æ”¹å¸¸é‡å³å¯å…¨å±€åˆ‡æ¢
- æ—§ç‰ˆæœ¬æ•°æ®åŒ…ä¿ç•™ï¼Œä¿æŒå‘åå…¼å®¹

### 4. æ•°æ®éš”ç¦»

- **åŸºç¡€æ•°æ®**ï¼ˆCity, Destinationï¼‰ï¼šæ°¸ä¹…ä¿ç•™ï¼Œæ‰€æœ‰éªŒè¯å™¨å…±äº«
- **æµ‹è¯•æ•°æ®**ï¼ˆFlight, Hotel ç­‰ï¼‰ï¼šprepare æ—¶å…¨é‡åŠ è½½ï¼Œverify åæ¸…é™¤
- **è®¢å•æ•°æ®**ï¼ˆBooking, HotelBooking ç­‰ï¼‰ï¼šéªŒè¯è¿‡ç¨‹äº§ç”Ÿï¼ŒéªŒè¯åæ¸…é™¤

## æ ¸å¿ƒæµç¨‹

### æ•°æ®åŠ è½½é¡ºåº

```
1. ensure_checkpoint()
   â†“ æ£€æŸ¥ City è¡¨æ˜¯å¦æœ‰æ•°æ®
   â†“ å¦‚æœä¸ºç©ºï¼ŒåŠ è½½ v1/base.rb
   â†“ ç¡®ä¿åŸºç¡€æ•°æ®å­˜åœ¨ï¼ˆCity, Destination, Demoç”¨æˆ·ï¼‰

2. reset_test_data_only()
   â†“ æ¸…ç©ºæ‰€æœ‰æµ‹è¯•ç›¸å…³çš„è¡¨ï¼ˆFlight, Hotel, Train ç­‰ï¼‰
   â†“ ä¿ç•™åŸºç¡€æ•°æ®ï¼ˆCity, Destinationï¼‰
   â†“ ä¿ç•™è®¢å•æ•°æ®ï¼ˆBooking ç­‰ï¼Œä¼šåœ¨éªŒè¯åæ¸…ç†ï¼‰
   â†“ é‡ç½® ID åºåˆ—

3. load_all_data_packs()
   â†“ æ‰«æ v1 ç›®å½•ä¸‹æ‰€æœ‰ .rb æ–‡ä»¶ï¼ˆæ’é™¤ base.rbï¼‰
   â†“ æŒ‰æ–‡ä»¶åæ’åºåä¾æ¬¡åŠ è½½
   â†“ è¾“å‡ºåŠ è½½æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•
   â†“ æ‰€æœ‰æµ‹è¯•æ•°æ®æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œä¾›ç”¨æˆ·æ“ä½œä½¿ç”¨
```

### execute_prepare() æµç¨‹

```ruby
# 1. ç¡®ä¿åŸºç¡€æ•°æ®å­˜åœ¨ï¼ˆæŒä¹…åŒ–ï¼‰
ensure_checkpoint()          # åŠ è½½ v1/base.rbï¼ˆå¦‚æœéœ€è¦ï¼‰

# 2. æ¸…ç©ºæµ‹è¯•æ•°æ®è¡¨ï¼ˆæŒä¹…åŒ–ï¼‰
reset_test_data_only()       # æ¸…ç©º Flight ç­‰æµ‹è¯•è¡¨

# 3. åŠ è½½æ‰€æœ‰ä¸šåŠ¡æ•°æ®åŒ…ï¼ˆæŒä¹…åŒ–ï¼‰
load_all_data_packs()        # è‡ªåŠ¨åŠ è½½ v1 ç›®å½•ä¸‹æ‰€æœ‰æ•°æ®åŒ…
                             # flights.rb, hotels.rb, cars.rb, ...

# 4. æ‰§è¡Œè‡ªå®šä¹‰å‡†å¤‡é€»è¾‘
prepare()                    # éªŒè¯å™¨è‡ªå®šä¹‰å‡†å¤‡

# 5. ä¿å­˜æ‰§è¡ŒçŠ¶æ€
save_execution_state()       # æŒä¹…åŒ–æ‰§è¡ŒçŠ¶æ€

# ç»“æœï¼š
# - City è¡¨æœ‰æ•°æ®ï¼ˆæ°¸ä¹…ä¿ç•™ï¼‰
# - Flight, Hotel, Train ç­‰è¡¨æœ‰æµ‹è¯•æ•°æ®ï¼ˆä¾›ç”¨æˆ·æ“ä½œï¼‰
# - æ‰§è¡ŒçŠ¶æ€å·²ä¿å­˜
```

### execute_verify() æµç¨‹

```ruby
# 1. æ¢å¤æ‰§è¡ŒçŠ¶æ€
restore_execution_state()  # æ¢å¤å‡†å¤‡é˜¶æ®µä¿å­˜çš„çŠ¶æ€

# 2. æ‰§è¡ŒéªŒè¯
verify()                   # éªŒè¯ç”¨æˆ·æ“ä½œç»“æœ

# 3. æ¸…ç†æ‰§è¡ŒçŠ¶æ€
cleanup_execution_state()  # åˆ é™¤æ‰§è¡ŒçŠ¶æ€

# 4. å›æ»šåˆ° checkpoint
rollback_to_checkpoint()   # æ¸…ç©ºæµ‹è¯•æ•°æ®å’Œè®¢å•ï¼Œä¿ç•™åŸºç¡€æ•°æ®

# ç»“æœï¼š
# - City è¡¨æœ‰æ•°æ®ï¼ˆä¿ç•™ï¼‰
# - Flight, Hotel ç­‰è¡¨ä¸ºç©ºï¼ˆå·²æ¸…é™¤ï¼‰
# - Booking è¡¨ä¸ºç©ºï¼ˆå·²æ¸…é™¤ï¼‰
# - æ•°æ®åº“æ¢å¤å¹²å‡€çŠ¶æ€
```

## æ•°æ®åˆ†ç±»

### åŸºç¡€æ•°æ®ï¼ˆæ°¸ä¹…ä¿ç•™ï¼‰

**ä½ç½®**: `v1/base.rb`

- **City**: 240+ åŸå¸‚æ•°æ®ï¼ŒåŒ…å«æœºåœºä»£ç ã€ä¸»é¢˜æ ‡ç­¾
- **Destination**: ç›®çš„åœ°æ•°æ®ï¼Œä¸ City å…³è”
- **Demoç”¨æˆ·**: demo@fliggy.comï¼Œç”¨äºæ¼”ç¤ºå’Œæµ‹è¯•

**ç‰¹ç‚¹**:
- æ‰€æœ‰éªŒè¯å™¨å…±äº«
- æ°¸ä¹…ä¿ç•™ï¼Œä¸è¢«æ¸…é™¤
- åœ¨ `reset_test_data_only()` å’Œ `rollback_to_checkpoint()` ä¸­è·³è¿‡

### æµ‹è¯•æ•°æ®ï¼ˆå…¨é‡åŠ è½½ï¼‰

**ä½ç½®**: `v1/*.rb`ï¼ˆé™¤ base.rb å¤–çš„æ‰€æœ‰æ–‡ä»¶ï¼‰

å½“å‰åŒ…å«çš„æ•°æ®åŒ…ï¼š
- **flights.rb**: èˆªç­æ•°æ®ï¼ˆæ·±åœ³â†’åŒ—äº¬ã€ä¸Šæµ·â†’æ·±åœ³ï¼‰
- **hotels.rb / hotels_seed.rb**: é…’åº—æ•°æ®
- **cars.rb**: æ±½è½¦ç§Ÿèµæ•°æ®
- **bus_tickets.rb**: å·´å£«ç¥¨æ•°æ®
- **tour_group_products.rb**: è·Ÿå›¢æ¸¸æ•°æ®
- **abroad_tickets.rb**: å¢ƒå¤–ç¥¨åŠ¡æ•°æ®
- **abroad_shopping.rb**: å¢ƒå¤–è´­ç‰©æ•°æ®
- **deep_travel.rb**: æ·±åº¦æ¸¸æ•°æ®
- **hotel_packages.rb**: é…’åº—å¥—é¤æ•°æ®
- **internet_services.rb**: äº’è”ç½‘æœåŠ¡æ•°æ®

**ç‰¹ç‚¹**:
- prepare é˜¶æ®µè‡ªåŠ¨å…¨é‡åŠ è½½
- éªŒè¯åæ¸…é™¤ï¼ˆrollback_to_checkpointï¼‰
- éªŒè¯å™¨æ— éœ€æŒ‡å®šåŠ è½½å“ªäº›æ•°æ®åŒ…

### è®¢å•æ•°æ®ï¼ˆéªŒè¯è¿‡ç¨‹äº§ç”Ÿï¼‰

**æ¥æº**: ç”¨æˆ·æ“ä½œäº§ç”Ÿ

- **Booking**: æœºç¥¨è®¢å•
- **HotelBooking**: é…’åº—è®¢å•
- **TrainBooking**: ç«è½¦ç¥¨è®¢å•
- **å…¶ä»–è®¢å•**: CarOrder, BusTicketOrder ç­‰

**ç‰¹ç‚¹**:
- éªŒè¯è¿‡ç¨‹ä¸­äº§ç”Ÿ
- éªŒè¯åæ¸…é™¤ï¼ˆrollback_to_checkpointï¼‰

## Checkpoint æœºåˆ¶

### ä»€ä¹ˆæ˜¯ Checkpointï¼Ÿ

Checkpoint = `v1/base.rb` åŠ è½½å®Œæˆåçš„æ•°æ®åº“çŠ¶æ€

- âœ… åŒ…å«ï¼šCity, Destination, Demoç”¨æˆ·
- âŒ ä¸åŒ…å«ï¼šFlight, Hotel, Train ç­‰ä¸šåŠ¡æ•°æ®
- âŒ ä¸åŒ…å«ï¼šBooking, HotelBooking ç­‰è®¢å•æ•°æ®

### ä¸ºä»€ä¹ˆéœ€è¦ Checkpointï¼Ÿ

**é—®é¢˜åœºæ™¯**ï¼š
```
åˆå§‹çŠ¶æ€: æ•°æ®åº“ä¸ºç©º
éªŒè¯å™¨è¦æ±‚: éœ€è¦ City æ•°æ®ï¼ˆFlight å…³è” departure_cityï¼‰
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```ruby
def ensure_checkpoint
  if City.count == 0
    load Rails.root.join('app/validators/support/data_packs/v1/base.rb')
  end
end
```

**æ‰§è¡Œæ—¶æœº**ï¼š
- åœ¨ `execute_prepare()` å¼€å§‹æ—¶è°ƒç”¨
- ç¡®ä¿åŸºç¡€æ•°æ®å­˜åœ¨åå†åŠ è½½æµ‹è¯•æ•°æ®

### å›æ»šåˆ° Checkpoint

**ç›®çš„**ï¼šéªŒè¯å®Œæˆåæ¢å¤æ•°æ®åº“åˆ°å¹²å‡€çŠ¶æ€

```ruby
def rollback_to_checkpoint
  # 1. æ¸…ç©ºæµ‹è¯•æ•°æ®ï¼ˆFlight, Hotel, Train ç­‰ï¼‰
  # 2. æ¸…ç©ºè®¢å•æ•°æ®ï¼ˆBooking, HotelBooking ç­‰ï¼‰
  # 3. ä¿ç•™åŸºç¡€æ•°æ®ï¼ˆCity, Destinationï¼‰
end
```

**ç»“æœ**ï¼š
- City è¡¨æœ‰æ•°æ®ï¼ˆä¿ç•™ï¼‰
- Flight è¡¨ä¸ºç©ºï¼ˆæ¸…é™¤ï¼‰
- Booking è¡¨ä¸ºç©ºï¼ˆæ¸…é™¤ï¼‰
- æ•°æ®åº“çŠ¶æ€ = Checkpoint çŠ¶æ€

## å®é™…æ‰§è¡Œç¤ºä¾‹

### åœºæ™¯ï¼šBookFlightValidator å®Œæ•´æµç¨‹

```bash
# === åˆå§‹çŠ¶æ€ ===
City.count      # => 0
Flight.count    # => 0
Hotel.count     # => 0
Booking.count   # => 0

# === 1. execute_prepare ===
validator = BookFlightValidator.new
validator.execute_prepare

# â†’ ensure_checkpoint(): City ä¸ºç©ºï¼ŒåŠ è½½ base.rb
City.count      # => 240 (åŸºç¡€æ•°æ®)
Destination.count # => 240+

# â†’ reset_test_data_only(): æ¸…ç©ºæµ‹è¯•è¡¨ï¼ˆå·²ç»æ˜¯ç©ºçš„ï¼‰
Flight.count    # => 0
Hotel.count     # => 0

# â†’ load_all_data_packs(): åŠ è½½ v1 ä¸‹æ‰€æœ‰æ•°æ®åŒ…
# ğŸ“¦ æ­£åœ¨åŠ è½½ v1 æ•°æ®åŒ…...
#   â†’ åŠ è½½ abroad_shopping.rb
#   â†’ åŠ è½½ abroad_tickets.rb
#   â†’ åŠ è½½ bus_tickets.rb
#   â†’ åŠ è½½ cars.rb
#   â†’ åŠ è½½ deep_travel.rb
#   â†’ åŠ è½½ flights.rb
#   â†’ åŠ è½½ hotel_packages.rb
#   â†’ åŠ è½½ hotels.rb
#   â†’ åŠ è½½ hotels_seed.rb
#   â†’ åŠ è½½ internet_services.rb
#   â†’ åŠ è½½ tour_group_products.rb
# âœ“ æ‰€æœ‰æ•°æ®åŒ…åŠ è½½å®Œæˆ

Flight.count    # => 6 (æµ‹è¯•èˆªç­)
Hotel.count     # => N (é…’åº—æ•°æ®)
Car.count       # => M (æ±½è½¦ç§Ÿèµæ•°æ®)
# ... å…¶ä»–ä¸šåŠ¡æ•°æ®

# â†’ prepare(): éªŒè¯å™¨è‡ªå®šä¹‰å‡†å¤‡é€»è¾‘
# è¿”å›ä»»åŠ¡ä¿¡æ¯ç»™ Agent

# === 2. Agent æ“ä½œ ===
# Agent é€šè¿‡ç•Œé¢æœç´¢èˆªç­ã€åˆ›å»ºè®¢å•
Booking.count   # => 1 (Agent åˆ›å»ºçš„è®¢å•)

# === 3. execute_verify ===
result = validator.execute_verify

# â†’ restore_execution_state(): æ¢å¤å‡†å¤‡é˜¶æ®µçš„çŠ¶æ€
# â†’ verify(): éªŒè¯è®¢å•æ˜¯å¦æ­£ç¡®
# â†’ cleanup_execution_state(): æ¸…ç†æ‰§è¡ŒçŠ¶æ€
# â†’ rollback_to_checkpoint(): å›æ»šåˆ° checkpoint

# === æœ€ç»ˆçŠ¶æ€ ===
City.count      # => 240 (ä¿ç•™)
Flight.count    # => 0 (æ¸…é™¤)
Hotel.count     # => 0 (æ¸…é™¤)
Booking.count   # => 0 (æ¸…é™¤)
```

## è®¾è®¡ä¼˜åŠ¿

### 1. é™ä½ç»´æŠ¤æˆæœ¬

- âœ… æ‰€æœ‰æ•°æ®ç»Ÿä¸€åœ¨ data_packs ç®¡ç†
- âœ… ç‰ˆæœ¬åŒ–å‘½åï¼Œä¿®æ”¹æ—¶åˆ›å»ºæ–°ç‰ˆæœ¬
- âœ… æ— éœ€åœ¨éªŒè¯å™¨ä¸­æŒ‡å®šåŠ è½½å“ªäº›æ•°æ®åŒ…

### 2. è‡ªåŠ¨åŒ–åŠ è½½

- âœ… prepare é˜¶æ®µè‡ªåŠ¨åŠ è½½æ‰€æœ‰æ•°æ®åŒ…
- âœ… æ–°å¢æ•°æ®åŒ…æ— éœ€ä¿®æ”¹ä»£ç ï¼Œè‡ªåŠ¨è¯†åˆ«
- âœ… éªŒè¯å™¨ä¸“æ³¨ä¸šåŠ¡é€»è¾‘ï¼Œæ— éœ€å…³å¿ƒæ•°æ®åŠ è½½

### 3. æ•°æ®éš”ç¦»

- âœ… åŸºç¡€æ•°æ®ï¼ˆCityï¼‰å’Œæµ‹è¯•æ•°æ®ï¼ˆFlightï¼‰åˆ†ç¦»
- âœ… éªŒè¯å™¨åªä¿®æ”¹æµ‹è¯•æ•°æ®ï¼Œä¸å½±å“åŸºç¡€æ•°æ®
- âœ… æ¯æ¬¡éªŒè¯å‰æ¸…ç©ºæµ‹è¯•è¡¨ï¼Œç¡®ä¿å¹²å‡€ç¯å¢ƒ

### 4. å¯é‡å¤æ€§

- âœ… æ¯æ¬¡éªŒè¯å‰æ¸…ç©ºæµ‹è¯•è¡¨
- âœ… æ¯æ¬¡éªŒè¯åå›æ»šåˆ° checkpoint
- âœ… ç¡®ä¿éªŒè¯å™¨å¯é‡å¤æ‰§è¡Œ

### 5. æ€§èƒ½ä¼˜åŒ–

- âœ… ä½¿ç”¨ `delete_all` è€Œä¸æ˜¯ `destroy_all`ï¼ˆè·³è¿‡å›è°ƒï¼‰
- âœ… é‡ç½® ID åºåˆ—é¿å…å†²çª
- âœ… æ‰¹é‡åŠ è½½ï¼Œå‡å°‘å•æ¬¡åŠ è½½å¼€é”€

### 6. ç‰ˆæœ¬ç®¡ç†

- âœ… æ•°æ®åŒ…ç‰ˆæœ¬åŒ–ï¼ˆv1, v2, v3ï¼‰
- âœ… ä¿®æ”¹æ•°æ®æ—¶åˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œä¿æŒå‘åå…¼å®¹
- âœ… å…¨å±€åˆ‡æ¢ç‰ˆæœ¬ï¼Œæ‰€æœ‰éªŒè¯å™¨åŒæ­¥æ›´æ–°

## ä½¿ç”¨æ–¹å¼

### æ–¹å¼ 1: é€šè¿‡éªŒè¯å™¨è‡ªåŠ¨åŠ è½½ï¼ˆæ¨èï¼‰

```ruby
validator = BookFlightValidator.new
validator.execute_prepare  # è‡ªåŠ¨åŠ è½½ base.rb + v1 ä¸‹æ‰€æœ‰æ•°æ®åŒ…
```

### æ–¹å¼ 2: æ‰‹åŠ¨åŠ è½½åŸºç¡€æ•°æ®

```bash
rails runner "load Rails.root.join('app/validators/support/data_packs/v1/base.rb')"
```

### æ–¹å¼ 3: æ‰‹åŠ¨åŠ è½½å®Œæ•´æ¼”ç¤ºæ•°æ®

```bash
# åŠ è½½åŸºç¡€æ•°æ®
rails runner "load Rails.root.join('app/validators/support/data_packs/v1/base.rb')"

# åŠ è½½æ‰€æœ‰ä¸šåŠ¡æ•°æ®åŒ…
rails runner "Dir.glob(Rails.root.join('app/validators/support/data_packs/v1/*.rb')).reject { |f| File.basename(f) == 'base.rb' }.sort.each { |f| load f }"
```

### æ–¹å¼ 4: é€šè¿‡ db:seed åŠ è½½ï¼ˆä¼šæ˜¾ç¤ºä½¿ç”¨è¯´æ˜ï¼‰

```bash
rails db:seed
# è¾“å‡ºä½¿ç”¨è¯´æ˜å’Œæ‰‹åŠ¨åŠ è½½å‘½ä»¤
```

## åˆ›å»ºæ–°æ•°æ®åŒ…

### æ­¥éª¤

1. **åˆ›å»ºæ–‡ä»¶**ï¼š`app/validators/support/data_packs/v1/<domain>.rb`
2. **ç¼–å†™æ•°æ®**ï¼šå‚è€ƒç°æœ‰æ•°æ®åŒ…çš„ç»“æ„
3. **æ— éœ€é…ç½®**ï¼šæ–°æ–‡ä»¶ä¼šè‡ªåŠ¨è¢« `load_all_data_packs` è¯†åˆ«å’ŒåŠ è½½
4. **æµ‹è¯•éªŒè¯**ï¼šè¿è¡Œä»»æ„éªŒè¯å™¨ï¼Œæ–°æ•°æ®åŒ…ä¼šè‡ªåŠ¨åŠ è½½

### ç¤ºä¾‹ï¼šåˆ›å»º trains.rb æ•°æ®åŒ…

```ruby
# app/validators/support/data_packs/v1/trains.rb
# frozen_string_literal: true

# trains_v1 æ•°æ®åŒ…
# ç”¨äºç«è½¦ç¥¨é¢„è®¢éªŒè¯ä»»åŠ¡

puts "æ­£åœ¨åŠ è½½ trains_v1 æ•°æ®åŒ…..."

base_date = Date.current + 3.days

[
  {
    train_number: "G1234",
    departure_city: "æ·±åœ³å¸‚",
    destination_city: "åŒ—äº¬å¸‚",
    departure_time: base_date.to_time.in_time_zone.change(hour: 8, min: 0),
    arrival_time: base_date.to_time.in_time_zone.change(hour: 17, min: 30),
    price: 933.5,
    available_seats: 100,
    train_date: base_date
  }
].each do |attrs|
  Train.create!(attrs)
end

puts "âœ“ trains_v1 æ•°æ®åŒ…åŠ è½½å®Œæˆï¼ˆ1ä¸ªè½¦æ¬¡ï¼‰"
```

åˆ›å»ºæ–‡ä»¶åï¼Œæ— éœ€ä»»ä½•é…ç½®ï¼Œä¸‹æ¬¡è¿è¡Œä»»ä½•éªŒè¯å™¨æ—¶ä¼šè‡ªåŠ¨åŠ è½½ã€‚

## ç‰ˆæœ¬è¿­ä»£

å½“éœ€è¦ä¿®æ”¹æ•°æ®æ—¶ï¼š

1. **åˆ›å»ºæ–°ç‰ˆæœ¬ç›®å½•**: `mkdir app/validators/support/data_packs/v2`
2. **å¤åˆ¶æ‰€æœ‰æ–‡ä»¶**: `cp app/validators/support/data_packs/v1/* app/validators/support/data_packs/v2/`
3. **ä¿®æ”¹æ•°æ®**: åœ¨ v2 ç›®å½•ä¸­ä¿®æ”¹éœ€è¦æ›´æ–°çš„æ•°æ®åŒ…
4. **åˆ‡æ¢ç‰ˆæœ¬**: ä¿®æ”¹ `BaseValidator::DATA_PACK_VERSION = 'v2'`
5. **ä¿ç•™æ—§ç‰ˆæœ¬**: v1 ç›®å½•ä¿ç•™ï¼Œä¿æŒå‘åå…¼å®¹

ç¤ºä¾‹ï¼š

```ruby
# app/validators/base_validator.rb
class BaseValidator
  # æ•°æ®åŒ…ç‰ˆæœ¬ï¼ˆå½“å‰ä½¿ç”¨ v2ï¼‰
  DATA_PACK_VERSION = 'v2'  # ä¿®æ”¹è¿™ä¸€è¡Œå³å¯å…¨å±€åˆ‡æ¢
  
  # ...
end
```

æ‰€æœ‰éªŒè¯å™¨ä¼šè‡ªåŠ¨ä½¿ç”¨ v2 ç‰ˆæœ¬çš„æ•°æ®åŒ…ã€‚

## æ•°æ®åŒ…è§„èŒƒ

### æ–‡ä»¶å‘½å

- æ ¼å¼ï¼š`<domain>.rb`
- ç¤ºä¾‹ï¼š`flights.rb`, `hotels.rb`, `trains.rb`
- domainï¼šä¸šåŠ¡é¢†åŸŸï¼ˆflights, hotels, trainsç­‰ï¼‰

### æ–‡ä»¶ç»“æ„

```ruby
# frozen_string_literal: true

# <domain>_v<version> æ•°æ®åŒ…
# ç”¨äº <å…·ä½“éªŒè¯ä»»åŠ¡æè¿°>
#
# æ•°æ®è¯´æ˜ï¼š
# - <æ•°æ®é›†1æè¿°>
# - <æ•°æ®é›†2æè¿°>

puts "æ­£åœ¨åŠ è½½ <domain>_v<version> æ•°æ®åŒ…..."

# ==================== åŠ¨æ€æ—¥æœŸè®¾ç½® ====================
base_date = Date.current + 3.days  # ä½¿ç”¨åŠ¨æ€æ—¥æœŸ
base_datetime = base_date.to_time.in_time_zone

# ==================== æ•°æ®åˆ›å»º ====================
[
  {
    field1: "value1",
    field2: 100,
    date_field: base_date  # ä½¿ç”¨åŠ¨æ€æ—¥æœŸ
  }
].each do |attrs|
  Model.create!(attrs)
end

puts "âœ“ <domain>_v<version> æ•°æ®åŒ…åŠ è½½å®Œæˆï¼ˆ<æ•°é‡>æ¡è®°å½•ï¼‰"
```

### æœ€ä½³å®è·µ

1. **æ˜ç¡®æ•°æ®ç”¨é€”**ï¼šåœ¨æ³¨é‡Šä¸­è¯´æ˜æ•°æ®åŒ…çš„ç”¨é€”å’Œç‰¹å¾
2. **ä½¿ç”¨åŠ¨æ€æ—¥æœŸ**ï¼šä½¿ç”¨ `Date.current + N.days` è€Œä¸æ˜¯å›ºå®šæ—¥æœŸ
3. **è¾“å‡ºæ¸…æ™°æ—¥å¿—**ï¼šåŠ è½½å¼€å§‹å’Œç»“æŸæ—¶è¾“å‡ºæ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•
4. **æ•°æ®å…³è”æ­£ç¡®**ï¼šç¡®ä¿å¤–é”®å…³è”æ­£ç¡®ï¼ˆå¦‚ Flight çš„ departure_city å¿…é¡»åœ¨ City è¡¨ä¸­å­˜åœ¨ï¼‰
5. **ä¸ä½¿ç”¨æ˜¾å¼ ID**ï¼šè®©æ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆ IDï¼Œé¿å…å†²çª
6. **æ•°æ®é‡é€‚ä¸­**ï¼šæµ‹è¯•æ•°æ®åº”è¶³å¤Ÿä½†ä¸è¿‡å¤šï¼Œé¿å…å½±å“æ€§èƒ½

## æ³¨æ„äº‹é¡¹

1. **ä¸è¦ä¿®æ”¹å·²å‘å¸ƒçš„æ•°æ®åŒ…**ï¼šåˆ›å»ºæ–°ç‰ˆæœ¬è€Œéä¿®æ”¹ç°æœ‰ç‰ˆæœ¬
2. **ç¡®ä¿æ•°æ®å®Œæ•´æ€§**ï¼šå¤–é”®å…³è”å¿…é¡»æ­£ç¡®
3. **å¿…é¡»ä½¿ç”¨åŠ¨æ€æ—¥æœŸ**ï¼šä½¿ç”¨ `Date.current + N.days` è€Œä¸æ˜¯å›ºå®šæ—¥æœŸ
4. **æµ‹è¯•æ•°æ®çœŸå®æ€§**ï¼šæ•°æ®åº”æ¥è¿‘çœŸå®åœºæ™¯
5. **ä¸è¦åœ¨ db/seeds.rb ä¸­æ·»åŠ æ•°æ®**ï¼šæ‰€æœ‰æ•°æ®ç»Ÿä¸€åœ¨ data_packs ç®¡ç†
6. **æ–°å¢æ•°æ®åŒ…æ— éœ€é…ç½®**ï¼šåˆ›å»ºæ–‡ä»¶åä¼šè‡ªåŠ¨åŠ è½½

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆè‡ªåŠ¨åŠ è½½æ‰€æœ‰æ•°æ®åŒ…ï¼Ÿ

A: ç®€åŒ–éªŒè¯å™¨å¼€å‘ã€‚éªŒè¯å™¨æ— éœ€å…³å¿ƒåŠ è½½å“ªäº›æ•°æ®åŒ…ï¼Œä¸“æ³¨ä¸šåŠ¡é€»è¾‘ã€‚æ–°å¢æ•°æ®åŒ…æ— éœ€ä¿®æ”¹ä»£ç ã€‚

### Q: å¦‚ä½•åªåŠ è½½ç‰¹å®šæ•°æ®åŒ…ï¼Ÿ

A: å½“å‰æ¶æ„ä¸æ”¯æŒé€‰æ‹©æ€§åŠ è½½ã€‚å¦‚éœ€æ­¤åŠŸèƒ½ï¼Œå¯ä»¥ï¼š
1. å°†ä¸éœ€è¦çš„æ•°æ®åŒ…ç§»å‡º v1 ç›®å½•
2. æˆ–åˆ›å»ºå•ç‹¬çš„ç‰ˆæœ¬ç›®å½•ï¼ˆå¦‚ v1_minimalï¼‰ä»…åŒ…å«éœ€è¦çš„æ•°æ®åŒ…

### Q: ä¸ºä»€ä¹ˆä¸åœ¨ db/seeds.rb ä¸­åŠ è½½æ•°æ®ï¼Ÿ

A: ç»Ÿä¸€ç®¡ç†é™ä½ç»´æŠ¤æˆæœ¬ã€‚æ‰€æœ‰æ•°æ®é€šè¿‡ data_packs ç‰ˆæœ¬åŒ–ç®¡ç†ï¼Œé¿å…é‡å¤ç»´æŠ¤ã€‚

### Q: å¦‚ä½•æŸ¥çœ‹å½“å‰æ•°æ®åº“çŠ¶æ€ï¼Ÿ

A: ä½¿ç”¨ rails console:
```ruby
City.count         # åŸºç¡€æ•°æ®
Flight.count       # æµ‹è¯•æ•°æ®
Booking.count      # è®¢å•æ•°æ®
```

### Q: prepare åä¸ºä»€ä¹ˆæ‰€æœ‰è¡¨éƒ½æœ‰æ•°æ®ï¼Ÿ

A: è¿™æ˜¯æ­£ç¡®çš„ã€‚prepare åŠ è½½çš„æ•°æ®æ˜¯æŒä¹…åŒ–çš„ï¼Œä¾›ç”¨æˆ·æ“ä½œä½¿ç”¨ã€‚verify å®Œæˆåä¼šé€šè¿‡ rollback_to_checkpoint æ¸…é™¤ã€‚

### Q: å¦‚ä½•æ¸…ç©ºæ‰€æœ‰æ•°æ®é‡æ–°å¼€å§‹ï¼Ÿ

A: 
```bash
# æ–¹å¼1: é‡ç½®æ•°æ®åº“
rails db:reset

# æ–¹å¼2: æ‰‹åŠ¨æ¸…ç©º
rails runner "Flight.delete_all; Hotel.delete_all; Booking.delete_all; City.delete_all; Destination.delete_all"

# ç„¶åé‡æ–°åŠ è½½åŸºç¡€æ•°æ®
rails runner "load Rails.root.join('app/validators/support/data_packs/v1/base.rb')"
```

### Q: å¦‚ä½•å‡çº§æ•°æ®åŒ…ç‰ˆæœ¬ï¼Ÿ

A: 
1. åˆ›å»ºæ–°ç‰ˆæœ¬ç›®å½•ï¼š`mkdir app/validators/support/data_packs/v2`
2. å¤åˆ¶å¹¶ä¿®æ”¹æ•°æ®åŒ…
3. ä¿®æ”¹ `BaseValidator::DATA_PACK_VERSION = 'v2'`
4. æ‰€æœ‰éªŒè¯å™¨è‡ªåŠ¨åˆ‡æ¢åˆ° v2

## ç›¸å…³æ–‡ä»¶

- `db/seeds.rb`: ç©ºå…¥å£ï¼Œæä¾›ä½¿ç”¨è¯´æ˜
- `app/validators/support/data_packs/v1/base.rb`: åŸºç¡€æ•°æ®åŒ…
- `app/validators/support/data_packs/v1/*.rb`: å„ä¸šåŠ¡æ•°æ®åŒ…
- `app/validators/support/data_packs/ARCHITECTURE.md`: æ¶æ„è¯¦ç»†æ–‡æ¡£
- `app/validators/base_validator.rb`: æ•°æ®åŒ…åŠ è½½é€»è¾‘
- `app/validators/*_validator.rb`: å…·ä½“éªŒè¯å™¨å®ç°
