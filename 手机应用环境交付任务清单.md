# 手机应用环境交付任务清单

> **项目名称**: 旅行预订平台 - Agent 训练任务集  
> **交付类型**: 服务端 + APK (云手机部署)  
> **技术架构**: Rails 7.2 + PostgreSQL + Stimulus + Turbo  
> **交付时间**: 2024年  
> **验证器版本**: v1.0 (已实现)

---

## 一、服务端部署任务清单

| 序号 | 任务项 | 要求描述 | 验收标准 | 优先级 | 状态 |
|------|--------|----------|----------|--------|------|
| 1.1 | 服务端环境准备 | 部署在单台 8核32G 服务器上 | 服务正常运行，资源占用≤80% | P0 | ✅ 已完成 |
| 1.2 | 端口配置 | 服务端口使用 5001-5050 之间 | 端口配置正确，无冲突 | P0 | ⬜ 待完成 |
| 1.3 | Docker 镜像构建 | 提供 Dockerfile 和 docker-compose.yml | 一键部署成功 | P0 | ⬜ 待完成 |
| 1.4 | 数据库初始化 | PostgreSQL 数据库自动初始化 | 数据包加载成功，测试数据完整 | P0 | ✅ 已完成 |
| 1.5 | 数据版本隔离 | 实现 data_version 隔离机制 | session_id 数据互不干扰 | P0 | ✅ 已完成 |

---

## 二、API 接口开发任务清单

### 2.1 会话管理接口

| 序号 | 接口路径 | 请求方法 | 功能描述 | 验收标准 | 状态 |
|------|----------|----------|----------|----------|------|
| 2.1.1 | `/api/tasks/:id/start` | POST | 创建训练会话 | 返回 task_json + session_id | ⬜ 待完成 |
| 2.1.2 | `/api/tasks/:id` | GET | 获取任务详情 | 返回完整任务配置 | ⬜ 待完成 |

### 2.2 Setup 接口

| 序号 | 接口路径 | 请求方法 | 功能描述 | 验收标准 | 状态 |
|------|----------|----------|----------|----------|------|
| 2.2.1 | `/api/setup/run` | POST | 环境初始化 | 根据 task_id 初始化数据 | ⬜ 待完成 |

### 2.3 Verify 接口（核心）

| 序号 | 接口路径 | 请求方法 | 功能描述 | 验收标准 | 状态 |
|------|----------|----------|----------|----------|------|
| 2.3.1 | `/api/verify/run` | POST | 执行验证 | 返回 score/reason/execution_status | ⬜ 待完成 |
| 2.3.2 | - | - | 验证参数 | task_id + session_id 必填 | ⬜ 待完成 |
| 2.3.3 | - | - | 返回格式 | 符合规范返回结构（见下表） | ⬜ 待完成 |

**Verify 返回结构验收标准**:

```json
{
  "score": 0.0-1.0,           // 必填：任务得分
  "reason": "string",          // 必填：失败原因或成功信息
  "execution_status": "success|fail",  // 必填：执行状态
  "metadata": {                // 可选：详细信息
    "details": {
      "process": [],
      "result": [
        {
          "child_verify_id": "string",
          "score": 0.0-1.0,
          "weight": 0.0-1.0,
          "child_reason": {}
        }
      ]
    }
  }
}
```

---

## 三、验证器用例实现任务清单

### 3.1 机票预订场景（2个用例）✅

| 用例ID | 用例名称 | validator_id | 任务描述 | 评分维度 | 状态 |
|--------|----------|--------------|----------|----------|------|
| UC-01 | 预订深圳到北京的低价机票 | `book_flight_sz_to_bj` | 搜索后天航班，选择最低价并创建订单 | 订单创建(20%) + 出发城市(10%) + 目的城市(10%) + 日期(20%) + 最低价(40%) | ✅ 已实现 |
| UC-02 | 搜索上海到深圳最便宜航班 | `search_cheapest_sh_to_sz` | 考虑折扣价，找出最终价格最低的航班 | 订单创建(20%) + 航线(10%) + 日期(10%) + 最低价(30%) + 金额准确(30%) | ✅ 已实现 |

### 3.2 火车票预订场景（3个用例）✅

| 用例ID | 用例名称 | validator_id | 任务描述 | 评分维度 | 状态 |
|--------|----------|--------------|----------|----------|------|
| UC-03 | 预订明天上海到杭州最早高铁 | `book_earliest_train_sh_to_hz` | 搜索明天车次，选择最早发车的 | 订单创建(20%) + 出发城市(10%) + 到达城市(10%) + 日期(20%) + 最早时间(40%) | ✅ 已实现 |
| UC-04 | 搜索后天北京到天津最便宜车票 | `search_cheapest_train_bj_to_tj` | 对比不同车次和座位类型价格 | 订单创建(20%) + 航线(10%) + 日期(20%) + 最便宜座位(30%) + 金额准确(20%) | ✅ 已实现 |
| UC-11 | 预订后天东京到京都上午新干线 | `book_japan_train_morning` | 境外票务，上午时段筛选 | 订单创建(20%) + 国家(10%) + 路线(20%) + 日期(20%) + 上午时段(30%) | ✅ 已实现 |

### 3.3 酒店预订场景（2个用例）✅

| 用例ID | 用例名称 | validator_id | 任务描述 | 评分维度 | 状态 |
|--------|----------|--------------|----------|----------|------|
| UC-05 | 预订后天深圳的经济型酒店 | `book_budget_hotel_shenzhen` | 预算≤500元，找性价比最高的 | 订单(20%) + 城市(15%) + 日期(15%) + 价格(30%) + 性价比(20%) | ✅ 已实现 |
| UC-15 | 搜索北京评分最高的高档酒店 | `search_high_rated_hotel_beijing` | 4星级及以上，评分最高 | 订单(20%) + 城市(15%) + 星级(15%) + 评分(35%) + 信息准确(15%) | ✅ 已实现 |

### 3.4 跟团游场景（2个用例）✅

| 用例ID | 用例名称 | validator_id | 任务描述 | 评分维度 | 状态 |
|--------|----------|--------------|----------|----------|------|
| UC-06 | 预订价格合适的三亚跟团游 | `book_tour_package_sanya` | 5天4晚，2人，预算≤5000元/人 | 订单(20%) + 目的地(15%) + 天数(15%) + 价格(30%) + 人数(20%) | ✅ 已实现 |
| UC-07 | 搜索预算5000元内云南旅游产品 | `search_budget_tour_yn` | 找出预算内销量最高的产品 | 订单创建(20%) + 目的地(15%) + 价格(30%) + 销量排序(35%) | ✅ 已实现 |

### 3.5 租车场景（2个用例）✅

| 用例ID | 用例名称 | validator_id | 任务描述 | 评分维度 | 状态 |
|--------|----------|--------------|----------|----------|------|
| UC-08 | 租赁后天深圳经济型轿车 | `book_economy_car_sz` | 3天租期，预算≤200元/天 | 订单(20%) + 城市(15%) + 类型(25%) + 价格(25%) + 天数(15%) | ✅ 已实现 |
| UC-09 | 搜索成都适合家庭的7座SUV | `search_family_car_cd` | 理解"适合家庭"=7座SUV | 订单创建(20%) + 城市(20%) + 类型SUV(25%) + 座位数7座(35%) | ✅ 已实现 |

### 3.6 大巴票场景（2个用例）✅

| 用例ID | 用例名称 | validator_id | 任务描述 | 评分维度 | 状态 |
|--------|----------|--------------|----------|----------|------|
| UC-10 | 预订明天上午广州到深圳大巴票 | `book_morning_bus_gz_to_sz` | 上午（12:00前）出发 | 订单(20%) + 路线(20%) + 日期(20%) + 上午时段(40%) | ✅ 已实现 |
| UC-12 | 搜索后天杭州到深圳最快班次 | `search_fastest_bus_hz_to_sz` | 计算行程时间，找最短的 | 订单创建(20%) + 路线(20%) + 日期(20%) + 最短时间(40%) | ✅ 已实现 |

### 3.7 境外票务和上网服务场景（3个用例）✅

| 用例ID | 用例名称 | validator_id | 任务描述 | 评分维度 | 状态 |
|--------|----------|--------------|----------|----------|------|
| UC-13 | 购买日本7天无限流量SIM卡 | `book_japan_sim_card` | 地区+有效期+流量要求匹配 | 订单(20%) + 类型SIM(20%) + 地区日本(20%) + 有效期7天(20%) + 无限流量(20%) | ✅ 已实现 |
| UC-14 | 搜索覆盖5国以上的欧洲WiFi | `search_multi_country_wifi` | 理解"多国覆盖"，解析国家数量 | 订单(20%) + 类型WiFi(20%) + 地区欧洲(20%) + 国家数量≥5(40%) | ✅ 已实现 |
| UC-16 | 搜索明天欧洲最便宜的火车票 | `search_cheapest_europe_train` | 境外火车票全局价格对比 | 订单创建(20%) + 地区欧洲(15%) + 日期(15%) + 最低价(50%) | ✅ 已实现 |

**总计**: 16个验证器用例，全部已实现 ✅

---

## 四、数据包开发任务清单

### 4.1 基础数据包（必需）✅

| 序号 | 数据包名称 | 文件路径 | 数据内容 | 验收标准 | 状态 |
|------|------------|----------|----------|----------|------|
| 4.1.1 | 基础配置 | `app/validators/support/data_packs/v1/base.rb` | 城市、测试用户、乘客信息 | 数据加载成功，测试用户可用 | ✅ 已完成 |
| 4.1.2 | 测试用户 | `app/validators/support/data_packs/v1/demo_user.rb` | 测试账号 demo@travel01.com | 用户创建成功，可登录 | ✅ 已完成 |
| 4.1.3 | 航班数据 | `app/validators/support/data_packs/v1/flights.rb` | 10+航班，覆盖4条航线，价格梯度 | 包含折扣价、时间段分布合理 | ✅ 已完成 |
| 4.1.4 | 火车数据 | `app/validators/support/data_packs/v1/trains.rb` | 10+车次，3种座位类型，价格梯度 | 包含时刻表、余票信息 | ✅ 已完成 |

### 4.2 扩展数据包（已完成）✅

| 序号 | 数据包名称 | 文件路径 | 数据内容 | 状态 |
|------|------------|----------|----------|------|
| 4.2.1 | 酒店数据（全量） | `app/validators/support/data_packs/v1/hotels_all.rb` | 10+酒店，覆盖多城市，3-5星级 | ✅ 已完成 |
| 4.2.2 | 跟团游数据（全量） | `app/validators/support/data_packs/v1/tour_group_products_all.rb` | 云南、三亚等目的地产品 | ✅ 已完成 |
| 4.2.3 | 租车数据 | `app/validators/support/data_packs/v1/cars.rb` | 深圳、成都等城市车辆 | ✅ 已完成 |
| 4.2.4 | 大巴数据 | `app/validators/support/data_packs/v1/bus_tickets.rb` | 广州-深圳、杭州-深圳班次 | ✅ 已完成 |
| 4.2.5 | 境外票务数据 | `app/validators/support/data_packs/v1/abroad_tickets.rb` | 日本新干线、欧洲火车票 | ✅ 已完成 |
| 4.2.6 | 境外上网数据 | `app/validators/support/data_packs/v1/internet_services.rb` | SIM卡、WiFi设备 | ✅ 已完成 |
| 4.2.7 | 机票套餐 | `app/validators/support/data_packs/v1/flight_packages.rb` | 机票+酒店套餐 | ✅ 已完成 |
| 4.2.8 | 酒店套餐 | `app/validators/support/data_packs/v1/hotel_packages.rb` | 酒店住宿套餐 | ✅ 已完成 |
| 4.2.9 | 深度游 | `app/validators/support/data_packs/v1/deep_travel.rb` | 深度旅游产品 | ✅ 已完成 |
| 4.2.10 | 境外购物 | `app/validators/support/data_packs/v1/abroad_shopping.rb` | 境外购物服务 | ✅ 已完成 |
| 4.2.11 | 签证服务 | `app/validators/support/data_packs/v1/visa_services.rb` | 签证办理服务 | ✅ 已完成 |
| 4.2.12 | 深圳品牌更新 | `app/validators/support/data_packs/v1/update_shenzhen_brands.rb` | 深圳酒店品牌修正 | ✅ 已完成 |

---

## 五、验证器测试任务清单

| 序号 | 测试任务 | 测试方法 | 验收标准 | 状态 |
|------|----------|----------|----------|------|
| 5.1 | 单元测试 | 每个 validator 执行 `simulate` 方法 | 所有用例 100% 通过 | ⬜ 待完成 |
| 5.2 | 集成测试 | 通过 API 接口执行 prepare → verify 流程 | 返回正确的 score 和 reason | ⬜ 待完成 |
| 5.3 | 并发测试 | 多个 session_id 同时执行 | 数据隔离，互不干扰 | ⬜ 待完成 |
| 5.4 | 错误场景测试 | 测试错误订单、缺失数据等场景 | score=0, reason 描述准确 | ⬜ 待完成 |
| 5.5 | 性能测试 | 单个 verify 接口响应时间 | ≤3秒 | ⬜ 待完成 |

---

## 六、APK 集成任务清单

| 序号 | 任务项 | 要求描述 | 验收标准 | 状态 |
|------|--------|----------|----------|------|
| 6.1 | 启动参数接收 | 接收 session_id 参数 | ADB am start 携带参数成功 | ⬜ 待完成 |
| 6.2 | 会话绑定 | 绑定云手机实例与 session_id | 数据隔离生效 | ⬜ 待完成 |
| 6.3 | Setup 调用 | 启动时自动调用 setup 接口 | 环境初始化完成 | ⬜ 待完成 |
| 6.4 | 界面功能完整性 | 所有预订流程可操作 | 16个用例对应的功能全部可用 | ⬜ 待完成 |

---

## 七、文档交付任务清单

| 序号 | 文档名称 | 内容要求 | 格式 | 状态 |
|------|----------|----------|------|------|
| 7.1 | 部署手册 | Docker 部署步骤、环境变量配置 | Markdown | ⬜ 待完成 |
| 7.2 | API 接口文档 | 所有接口的请求/响应示例 | OpenAPI 3.0 | ⬜ 待完成 |
| 7.3 | 验证器用例说明 | 16个用例的详细描述、评分标准 | Excel + Markdown | ⬜ 待完成 |
| 7.4 | 数据包结构说明 | 数据包加载机制、字段定义 | Markdown | ⬜ 待完成 |
| 7.5 | 故障排查手册 | 常见问题及解决方案 | Markdown | ⬜ 待完成 |

---

## 八、交付物清单

### 8.1 代码交付物

- [x] 完整源代码（Git 仓库）
- [x] 16个验证器实现（app/validators/*_validator.rb）
- [x] 12个数据包文件（app/validators/support/data_packs/v1/*.rb）
- [ ] Dockerfile 和 docker-compose.yml
- [x] 数据库迁移文件（db/migrate）
- [ ] 测试用例（spec/validators/*_spec.rb）

### 8.2 可执行文件

- [ ] Docker 镜像文件（.tar 格式）
- [ ] APK 安装包（如需提供）
- [ ] 数据库备份文件（初始化数据）

### 8.3 文档交付物

- [ ] 部署手册（DEPLOYMENT.md）
- [ ] API 接口文档（api-docs.yaml）
- [ ] 验证器用例说明（validator_tasks.xlsx）
- [ ] 数据结构说明（DATA_STRUCTURE.md）
- [ ] 故障排查手册（TROUBLESHOOTING.md）

---

## 九、验收标准总结

### 9.1 功能性验收

| 验收项 | 标准 | 权重 | 当前状态 |
|--------|------|------|----------|
| 16个验证器全部可用 | 100% 通过单元测试 | 40% | ✅ 已实现 |
| API 接口符合规范 | 返回格式 100% 符合 | 30% | ⬜ 开发中 |
| 数据隔离机制有效 | 并发测试通过 | 20% | ✅ 已实现 |
| 性能达标 | verify 响应≤3秒 | 10% | ⬜ 待测试 |

### 9.2 非功能性验收

| 验收项 | 标准 | 状态 |
|--------|------|------|
| 代码规范 | 通过 RuboCop 检查 | ⬜ 待完成 |
| 测试覆盖率 | ≥90% | ⬜ 待完成 |
| 文档完整性 | 所有必需文档齐全 | ⬜ 待完成 |
| 安全性 | 无 SQL 注入、XSS 等漏洞 | ⬜ 待完成 |

### 9.3 交付时间节点

| 阶段 | 时间节点 | 交付内容 | 状态 |
|------|----------|----------|------|
| 第一阶段 | Week 1-2 | 服务端部署 + API 接口开发 | 🔄 进行中 |
| 第二阶段 | Week 3-4 | 8个核心验证器实现（机票、酒店、火车、租车） | ✅ 已完成 |
| 第三阶段 | Week 5-6 | 8个扩展验证器实现（大巴、境外票务、上网服务） | ✅ 已完成 |
| 第四阶段 | Week 7 | 集成测试 + APK 对接 | ⬜ 待开始 |
| 第五阶段 | Week 8 | 文档编写 + 最终验收 | ⬜ 待开始 |

---

## 十、16个验证器用例详细配置表

| # | validator_id | 任务描述 | 出发地 | 目的地 | 日期 | 特殊要求 | 评分维度 | 超时(秒) | 状态 |
|---|--------------|----------|--------|--------|------|----------|----------|----------|------|
| 1 | `book_flight_sz_to_bj` | 预订深圳→北京低价机票 | 深圳 | 北京 | 后天 | 选择最低价 | 订单(20%)+出发城市(10%)+目的城市(10%)+日期(20%)+最低价(40%) | 300 | ✅ |
| 2 | `search_cheapest_sh_to_sz` | 搜索上海→深圳最便宜航班 | 上海 | 深圳 | 后天 | 考虑折扣价 | 订单(20%)+航线(10%)+日期(10%)+最低价(30%)+金额(30%) | 300 | ✅ |
| 3 | `book_earliest_train_sh_to_hz` | 预订上海→杭州最早高铁 | 上海 | 杭州 | 明天 | 最早发车时间 | 订单(20%)+出发(10%)+到达(10%)+日期(20%)+最早(40%) | 300 | ✅ |
| 4 | `search_cheapest_train_bj_to_tj` | 搜索北京→天津最便宜车票 | 北京 | 天津 | 后天 | 对比所有座位类型 | 订单(20%)+航线(10%)+日期(20%)+最便宜座位(30%)+金额(20%) | 300 | ✅ |
| 5 | `book_budget_hotel_shenzhen` | 预订深圳经济型酒店 | - | 深圳 | 后天 | 预算≤500元，性价比最高 | 订单(20%)+城市(15%)+日期(15%)+价格(30%)+性价比(20%) | 300 | ✅ |
| 6 | `book_tour_package_sanya` | 预订三亚5天4晚跟团游 | - | 三亚 | - | 2人，预算≤5000元/人 | 订单(20%)+目的地(15%)+天数(15%)+价格(30%)+人数(20%) | 300 | ✅ |
| 7 | `search_budget_tour_yn` | 搜索云南旅游产品 | - | 云南 | - | 预算≤5000元，销量最高 | 订单(20%)+目的地(15%)+价格(30%)+销量(35%) | 300 | ✅ |
| 8 | `book_economy_car_sz` | 租赁深圳经济型轿车 | - | 深圳 | 后天 | 3天，预算≤200元/天 | 订单(20%)+城市(15%)+类型(25%)+价格(25%)+天数(15%) | 300 | ✅ |
| 9 | `search_family_car_cd` | 搜索成都7座SUV | - | 成都 | - | 适合家庭=7座SUV | 订单(20%)+城市(20%)+类型SUV(25%)+座位7座(35%) | 300 | ✅ |
| 10 | `book_morning_bus_gz_to_sz` | 预订广州→深圳上午大巴 | 广州 | 深圳 | 明天 | 上午（12:00前）出发 | 订单(20%)+路线(20%)+日期(20%)+上午(40%) | 300 | ✅ |
| 11 | `book_japan_train_morning` | 预订东京→京都上午新干线 | 东京 | 京都 | 后天 | 上午时段，境外票务 | 订单(20%)+国家(10%)+路线(20%)+日期(20%)+上午(30%) | 300 | ✅ |
| 12 | `search_fastest_bus_hz_to_sz` | 搜索杭州→深圳最快班次 | 杭州 | 深圳 | 后天 | 行程时间最短 | 订单(20%)+路线(20%)+日期(20%)+最短时间(40%) | 300 | ✅ |
| 13 | `book_japan_sim_card` | 购买日本7天无限流量SIM卡 | - | 日本 | - | 7天有效期，无限流量 | 订单(20%)+类型SIM(20%)+地区(20%)+有效期(20%)+流量(20%) | 300 | ✅ |
| 14 | `search_multi_country_wifi` | 搜索欧洲多国WiFi设备 | - | 欧洲 | - | 覆盖≥5个国家 | 订单(20%)+类型WiFi(20%)+地区(20%)+国家数≥5(40%) | 300 | ✅ |
| 15 | `search_high_rated_hotel_beijing` | 搜索北京高档酒店 | - | 北京 | 后天 | ≥4星级，评分最高 | 订单(20%)+城市(15%)+星级(15%)+评分(35%)+信息(15%) | 300 | ✅ |
| 16 | `search_cheapest_europe_train` | 搜索欧洲最便宜火车票 | - | 欧洲 | 明天 | 全局价格对比 | 订单(20%)+地区(15%)+日期(15%)+最低价(50%) | 300 | ✅ |

**总计**: 16个验证器用例，全部已实现 ✅

---

## 十一、当前项目进度总结

### ✅ 已完成的工作

1. **核心验证器（16个）** - 100% 完成
   - 机票预订场景：2个 ✅
   - 火车票预订场景：3个 ✅
   - 酒店预订场景：2个 ✅
   - 跟团游场景：2个 ✅
   - 租车场景：2个 ✅
   - 大巴票场景：2个 ✅
   - 境外票务和上网场景：3个 ✅

2. **数据包（12个）** - 100% 完成
   - 基础数据包：4个 ✅
   - 扩展数据包：8个 ✅

3. **核心功能**
   - BaseValidator 基类实现 ✅
   - 数据版本隔离机制（data_version） ✅
   - 断言系统（add_assertion） ✅
   - 状态持久化（execution_state_data） ✅
   - 模拟执行（simulate 方法） ✅

### 🔄 进行中的工作

1. **API 接口开发**
   - 验证接口框架设计
   - 会话管理机制
   - 返回格式规范化

### ⬜ 待完成的工作

1. **API 接口完整实现**
   - `/api/tasks/:id/start` - 创建训练会话
   - `/api/tasks/:id` - 获取任务详情
   - `/api/setup/run` - 环境初始化
   - `/api/verify/run` - 执行验证

2. **测试套件**
   - 单元测试（16个 validator 的 simulate 测试）
   - 集成测试（API 端到端测试）
   - 并发测试（数据隔离验证）
   - 性能测试（响应时间验证）

3. **部署相关**
   - Docker 镜像构建
   - docker-compose 配置
   - 端口配置（5001-5050）
   - 数据库备份脚本

4. **文档编写**
   - 部署手册
   - API 接口文档（OpenAPI 规范）
   - 验证器用例说明
   - 数据结构文档
   - 故障排查手册

5. **APK 集成**
   - 启动参数接收
   - 会话绑定机制
   - Setup 接口自动调用
   - 界面功能完整性验证

---

## 十二、后续工作优先级建议

### P0 - 紧急（本周完成）

1. API 接口开发 - 完成 4 个核心接口
2. 单元测试 - 验证 16 个 validator 的 simulate 方法
3. 基础文档 - API 接口文档和验证器用例说明

### P1 - 重要（下周完成）

1. Docker 部署配置
2. 集成测试和并发测试
3. 部署手册和故障排查手册

### P2 - 次要（两周内完成）

1. APK 集成对接
2. 性能测试和优化
3. 代码规范检查（RuboCop）

---

**更新时间**: 2024年1月  
**更新内容**: 基于当前实际实现的 validators 更新任务清单，标注已完成和待完成项  
**验证器版本**: v1.0 - 16个验证器全部实现完成
