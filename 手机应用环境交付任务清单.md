# 手机应用环境交付任务清单

> **项目名称**: 旅行预订平台 - Agent 训练任务集  
> **交付类型**: 服务端 + APK (云手机部署)  
> **技术架构**: Rails 7.2 + PostgreSQL + Stimulus + Turbo  
> **交付时间**: 2024年  
> **验证器版本**: v1.0

---

## 一、服务端部署任务清单

| 序号 | 任务项 | 要求描述 | 验收标准 | 优先级 | 状态 |
|------|--------|----------|----------|--------|------|
| 1.1 | 服务端环境准备 | 部署在单台 8核32G 服务器上 | 服务正常运行，资源占用≤80% | P0 | ⬜ 待完成 |
| 1.2 | 端口配置 | 服务端口使用 5001-5050 之间 | 端口配置正确，无冲突 | P0 | ⬜ 待完成 |
| 1.3 | Docker 镜像构建 | 提供 Dockerfile 和 docker-compose.yml | 一键部署成功 | P0 | ⬜ 待完成 |
| 1.4 | 数据库初始化 | PostgreSQL 数据库自动初始化 | 数据包加载成功，测试数据完整 | P0 | ⬜ 待完成 |
| 1.5 | 数据版本隔离 | 实现 data_version 隔离机制 | session_id 数据互不干扰 | P0 | ⬜ 待完成 |

---

## 二、API 接口开发任务清单

### 2.1 会话管理接口

| 序号 | 接口路径 | 请求方法 | 功能描述 | 验收标准 | 状态 |
|------|----------|----------|----------|----------|------|
| 2.1.1 | `/api/tasks/:id/start` | POST | 创建训练会话 | 返回 task_json + session_id | ⬜ 待完成 |
| 2.1.2 | `/api/tasks/:id` | GET | 获取任务详情 | 返回完整任务配置 | ⬜ 待完成 |

### 2.2 Setup 接口

| 序号 | 接口路径 | 请求方法 | 功能描述 | 验收标准 | 状态 |
|------|----------|----------|----------|----------|------|
| 2.2.1 | `/api/setup/run` | POST | 环境初始化 | 根据 task_id 初始化数据 | ⬜ 待完成 |

### 2.3 Verify 接口（核心）

| 序号 | 接口路径 | 请求方法 | 功能描述 | 验收标准 | 状态 |
|------|----------|----------|----------|----------|------|
| 2.3.1 | `/api/verify/run` | POST | 执行验证 | 返回 score/reason/execution_status | ⬜ 待完成 |
| 2.3.2 | - | - | 验证参数 | task_id + session_id 必填 | ⬜ 待完成 |
| 2.3.3 | - | - | 返回格式 | 符合规范返回结构（见下表） | ⬜ 待完成 |

**Verify 返回结构验收标准**:

```json
{
  "score": 0.0-1.0,           // 必填：任务得分
  "reason": "string",          // 必填：失败原因或成功信息
  "execution_status": "success|fail",  // 必填：执行状态
  "metadata": {                // 可选：详细信息
    "details": {
      "process": [],
      "result": [
        {
          "child_verify_id": "string",
          "score": 0.0-1.0,
          "weight": 0.0-1.0,
          "child_reason": {}
        }
      ]
    }
  }
}
```

---

## 三、验证器用例实现任务清单

### 3.1 机票预订场景（3个用例）

| 用例ID | 用例名称 | validator_id | 任务描述 | 评分维度 | 状态 |
|--------|----------|--------------|----------|----------|------|
| UC-01 | 预订深圳到北京的低价机票 | `book_flight_sz_to_bj` | 搜索后天航班，选择最低价并创建订单 | 订单创建(20%) + 航线(20%) + 日期(20%) + 最低价(40%) | ⬜ 待完成 |
| UC-02 | 搜索上海到深圳最便宜航班 | `search_cheapest_sh_to_sz` | 考虑折扣价，找出最终价格最低的航班 | 搜索(20%) + 识别最低价(30%) + 订单创建(20%) + 金额准确(30%) | ⬜ 待完成 |
| UC-16 | 机票价格变动测试 | - | 验证价格变更后的重新搜索和预订 | 价格识别(40%) + 决策正确性(60%) | ⬜ 待完成 |

### 3.2 火车票预订场景（3个用例）

| 用例ID | 用例名称 | validator_id | 任务描述 | 评分维度 | 状态 |
|--------|----------|--------------|----------|----------|------|
| UC-03 | 预订明天上海到杭州最早高铁 | `book_earliest_train_sh_to_hz` | 搜索明天车次，选择最早发车的 | 订单创建(20%) + 路线(20%) + 日期(20%) + 最早时间(40%) | ⬜ 待完成 |
| UC-04 | 搜索后天北京到天津最便宜车票 | `search_cheapest_train_bj_to_tj` | 对比不同车次和座位类型价格 | 搜索(20%) + 识别最低价(30%) + 订单(20%) + 金额(30%) | ⬜ 待完成 |
| UC-11 | 预订后天东京到京都上午新干线 | `book_japan_train_morning` | 境外票务，上午时段筛选 | 订单(20%) + 地区(10%) + 路线(20%) + 日期(20%) + 时段(30%) | ⬜ 待完成 |

### 3.3 酒店预订场景（2个用例）

| 用例ID | 用例名称 | validator_id | 任务描述 | 评分维度 | 状态 |
|--------|----------|--------------|----------|----------|------|
| UC-05 | 预订后天深圳的经济型酒店 | `book_budget_hotel_shenzhen` | 预算≤500元，找性价比最高的 | 订单(20%) + 城市(15%) + 日期(15%) + 价格(30%) + 性价比(20%) | ⬜ 待完成 |
| UC-15 | 搜索北京评分最高的高档酒店 | `search_high_rated_hotel_beijing` | 4星级及以上，评分最高 | 订单(20%) + 城市(15%) + 星级(15%) + 评分(35%) + 信息准确(15%) | ⬜ 待完成 |

### 3.4 跟团游场景（2个用例）

| 用例ID | 用例名称 | validator_id | 任务描述 | 评分维度 | 状态 |
|--------|----------|--------------|----------|----------|------|
| UC-06 | 预订价格合适的三亚跟团游 | `book_tour_package_sanya` | 5天4晚，2人，预算≤5000元/人 | 订单(20%) + 目的地(15%) + 天数(15%) + 价格(30%) + 人数(20%) | ⬜ 待完成 |
| UC-07 | 搜索预算5000元内云南旅游产品 | `search_budget_tour_yn` | 找出预算内销量最高的产品 | 搜索(20%) + 价格识别(20%) + 销量最高(30%) + 订单(30%) | ⬜ 待完成 |

### 3.5 租车场景（2个用例）

| 用例ID | 用例名称 | validator_id | 任务描述 | 评分维度 | 状态 |
|--------|----------|--------------|----------|----------|------|
| UC-08 | 租赁后天深圳经济型轿车 | `book_economy_car_sz` | 3天租期，预算≤200元/天 | 订单(20%) + 城市(15%) + 类型(25%) + 价格(25%) + 天数(15%) | ⬜ 待完成 |
| UC-09 | 搜索成都适合家庭的7座SUV | `search_family_car_cd` | 理解"适合家庭"=7座SUV | 搜索(20%) + 城市(20%) + 类型(30%) + 座位数(30%) | ⬜ 待完成 |

### 3.6 大巴票场景（2个用例）

| 用例ID | 用例名称 | validator_id | 任务描述 | 评分维度 | 状态 |
|--------|----------|--------------|----------|----------|------|
| UC-10 | 预订明天上午广州到深圳大巴票 | `book_morning_bus_gz_to_sz` | 上午（12:00前）出发 | 订单(20%) + 路线(20%) + 日期(20%) + 时段(40%) | ⬜ 待完成 |
| UC-11 | 搜索后天杭州到深圳最快班次 | `search_fastest_bus_hz_to_sz` | 计算行程时间，找最短的 | 搜索(20%) + 识别最短时间(30%) + 订单(20%) + 信息准确(30%) | ⬜ 待完成 |

### 3.7 境外上网场景（3个用例）

| 用例ID | 用例名称 | validator_id | 任务描述 | 评分维度 | 状态 |
|--------|----------|--------------|----------|----------|------|
| UC-12 | 购买日本7天无限流量SIM卡 | `book_japan_sim_card` | 地区+有效期+流量要求匹配 | 订单(20%) + 类型(20%) + 地区(20%) + 有效期(20%) + 流量(20%) | ⬜ 待完成 |
| UC-13 | 搜索覆盖5国以上的欧洲WiFi | `search_multi_country_wifi` | 理解"多国覆盖"，解析国家数量 | 订单(20%) + 类型(20%) + 地区(20%) + 国家数量(40%) | ⬜ 待完成 |
| UC-14 | 搜索明天欧洲最便宜的火车票 | `search_cheapest_europe_train` | 全局价格对比，找最低价 | 搜索(20%) + 识别最低价(40%) + 订单(20%) + 金额准确(20%) | ⬜ 待完成 |

---

## 四、数据包开发任务清单

### 4.1 基础数据包（必需）

| 序号 | 数据包名称 | 文件路径 | 数据内容 | 验收标准 | 状态 |
|------|------------|----------|----------|----------|------|
| 4.1.1 | 基础配置 | `app/validators/support/data_packs/v1/base.rb` | 城市、测试用户、乘客信息 | 数据加载成功，测试用户可用 | ⬜ 待完成 |
| 4.1.2 | 航班数据 | `app/validators/support/data_packs/v1/flights.rb` | 10+航班，覆盖4条航线，价格梯度 | 包含折扣价、时间段分布合理 | ⬜ 待完成 |
| 4.1.3 | 酒店数据 | `app/validators/support/data_packs/v1/hotels.rb` | 10+酒店，3-5星级，多城市分布 | 包含评分、价格、房型信息 | ⬜ 待完成 |
| 4.1.4 | 火车数据 | `app/validators/support/data_packs/v1/trains.rb` | 10+车次，3种座位类型，价格梯度 | 包含时刻表、余票信息 | ⬜ 待完成 |

### 4.2 扩展数据包（可选）

| 序号 | 数据包名称 | 文件路径 | 数据内容 | 状态 |
|------|------------|----------|----------|------|
| 4.2.1 | 跟团游数据 | `app/validators/support/data_packs/v1/tour_group_products.rb` | 云南、三亚等目的地产品 | ⬜ 待完成 |
| 4.2.2 | 租车数据 | `app/validators/support/data_packs/v1/cars.rb` | 深圳、成都等城市车辆 | ⬜ 待完成 |
| 4.2.3 | 大巴数据 | `app/validators/support/data_packs/v1/bus_tickets.rb` | 广州-深圳、杭州-深圳班次 | ⬜ 待完成 |
| 4.2.4 | 境外票务数据 | `app/validators/support/data_packs/v1/abroad_tickets.rb` | 日本新干线、欧洲火车票 | ⬜ 待完成 |
| 4.2.5 | 境外上网数据 | `app/validators/support/data_packs/v1/internet_services.rb` | SIM卡、WiFi设备 | ⬜ 待完成 |

---

## 五、验证器测试任务清单

| 序号 | 测试任务 | 测试方法 | 验收标准 | 状态 |
|------|----------|----------|----------|------|
| 5.1 | 单元测试 | 每个 validator 执行 `simulate` 方法 | 所有用例 100% 通过 | ⬜ 待完成 |
| 5.2 | 集成测试 | 通过 API 接口执行 prepare → verify 流程 | 返回正确的 score 和 reason | ⬜ 待完成 |
| 5.3 | 并发测试 | 多个 session_id 同时执行 | 数据隔离，互不干扰 | ⬜ 待完成 |
| 5.4 | 错误场景测试 | 测试错误订单、缺失数据等场景 | score=0, reason 描述准确 | ⬜ 待完成 |
| 5.5 | 性能测试 | 单个 verify 接口响应时间 | ≤3秒 | ⬜ 待完成 |

---

## 六、APK 集成任务清单

| 序号 | 任务项 | 要求描述 | 验收标准 | 状态 |
|------|--------|----------|----------|------|
| 6.1 | 启动参数接收 | 接收 session_id 参数 | ADB am start 携带参数成功 | ⬜ 待完成 |
| 6.2 | 会话绑定 | 绑定云手机实例与 session_id | 数据隔离生效 | ⬜ 待完成 |
| 6.3 | Setup 调用 | 启动时自动调用 setup 接口 | 环境初始化完成 | ⬜ 待完成 |
| 6.4 | 界面功能完整性 | 所有预订流程可操作 | 16个用例对应的功能全部可用 | ⬜ 待完成 |

---

## 七、文档交付任务清单

| 序号 | 文档名称 | 内容要求 | 格式 | 状态 |
|------|----------|----------|------|------|
| 7.1 | 部署手册 | Docker 部署步骤、环境变量配置 | Markdown | ⬜ 待完成 |
| 7.2 | API 接口文档 | 所有接口的请求/响应示例 | OpenAPI 3.0 | ⬜ 待完成 |
| 7.3 | 验证器用例说明 | 16个用例的详细描述、评分标准 | Excel + Markdown | ⬜ 待完成 |
| 7.4 | 数据包结构说明 | 数据包加载机制、字段定义 | Markdown | ⬜ 待完成 |
| 7.5 | 故障排查手册 | 常见问题及解决方案 | Markdown | ⬜ 待完成 |

---

## 八、交付物清单

### 8.1 代码交付物

- [ ] 完整源代码（Git 仓库）
- [ ] Dockerfile 和 docker-compose.yml
- [ ] 数据库迁移文件（db/migrate）
- [ ] 数据包文件（app/validators/support/data_packs/v1/*.rb）
- [ ] 测试用例（spec/validators/*_spec.rb）

### 8.2 可执行文件

- [ ] Docker 镜像文件（.tar 格式）
- [ ] APK 安装包（如需提供）
- [ ] 数据库备份文件（初始化数据）

### 8.3 文档交付物

- [ ] 部署手册（DEPLOYMENT.md）
- [ ] API 接口文档（api-docs.yaml）
- [ ] 验证器用例说明（validator_tasks.xlsx）
- [ ] 数据结构说明（DATA_STRUCTURE.md）
- [ ] 故障排查手册（TROUBLESHOOTING.md）

---

## 九、验收标准总结

### 9.1 功能性验收

| 验收项 | 标准 | 权重 |
|--------|------|------|
| 16个验证器全部可用 | 100% 通过单元测试 | 40% |
| API 接口符合规范 | 返回格式 100% 符合 | 30% |
| 数据隔离机制有效 | 并发测试通过 | 20% |
| 性能达标 | verify 响应≤3秒 | 10% |

### 9.2 非功能性验收

| 验收项 | 标准 |
|--------|------|
| 代码规范 | 通过 RuboCop 检查 |
| 测试覆盖率 | ≥90% |
| 文档完整性 | 所有必需文档齐全 |
| 安全性 | 无 SQL 注入、XSS 等漏洞 |

### 9.3 交付时间节点

| 阶段 | 时间节点 | 交付内容 |
|------|----------|----------|
| 第一阶段 | Week 1-2 | 服务端部署 + API 接口开发 |
| 第二阶段 | Week 3-4 | 8个核心验证器实现（机票、酒店、火车、租车） |
| 第三阶段 | Week 5-6 | 8个扩展验证器实现（大巴、境外票务、上网服务） |
| 第四阶段 | Week 7 | 集成测试 + APK 对接 |
| 第五阶段 | Week 8 | 文档编写 + 最终验收 |

---

## 十、16个验证器用例详细配置表

| validator_id | 任务描述 | 出发地 | 目的地 | 日期 | 特殊要求 | 评分维度 | 超时(秒) |
|--------------|----------|--------|--------|------|----------|----------|----------|
| `book_flight_sz_to_bj` | 预订深圳→北京低价机票 | 深圳市 | 北京市 | 后天 | 选择最低价 | 订单(20%)+航线(20%)+日期(20%)+最低价(40%) | 300 |
| `search_cheapest_sh_to_sz` | 搜索上海→深圳最便宜航班 | 上海市 | 深圳市 | 后天 | 考虑折扣价 | 搜索(20%)+最低价(30%)+订单(20%)+金额(30%) | 300 |
| `book_earliest_train_sh_to_hz` | 预订上海→杭州最早高铁 | 上海 | 杭州 | 明天 | 最早发车时间 | 订单(20%)+路线(20%)+日期(20%)+最早(40%) | 300 |
| `search_cheapest_train_bj_to_tj` | 搜索北京→天津最便宜车票 | 北京 | 天津 | 后天 | 对比所有座位类型 | 搜索(20%)+最低价(30%)+订单(20%)+金额(30%) | 300 |
| `book_budget_hotel_shenzhen` | 预订深圳经济型酒店 | - | 深圳市 | 后天 | 预算≤500元，性价比最高 | 订单(20%)+城市(15%)+日期(15%)+价格(30%)+性价比(20%) | 300 |
| `search_high_rated_hotel_beijing` | 搜索北京高档酒店 | - | 北京市 | 后天 | ≥4星，评分最高 | 订单(20%)+城市(15%)+星级(15%)+评分(35%)+信息(15%) | 300 |
| `book_tour_package_sanya` | 预订三亚跟团游 | - | 三亚 | - | 5天4晚，2人，≤5000元/人 | 订单(20%)+目的地(15%)+天数(15%)+价格(30%)+人数(20%) | 300 |
| `search_budget_tour_yn` | 搜索云南旅游产品 | - | 云南 | - | 预算≤5000元，销量最高 | 搜索(20%)+价格(20%)+销量(30%)+订单(30%) | 300 |
| `book_economy_car_sz` | 租赁深圳经济型轿车 | - | 深圳 | 后天 | 3天，≤200元/天 | 订单(20%)+城市(15%)+类型(25%)+价格(25%)+天数(15%) | 300 |
| `search_family_car_cd` | 搜索成都家庭SUV | - | 成都 | - | 7座SUV | 搜索(20%)+城市(20%)+类型(30%)+座位数(30%) | 300 |
| `book_morning_bus_gz_to_sz` | 预订广州→深圳上午大巴 | 广州 | 深圳 | 明天 | 上午（12:00前） | 订单(20%)+路线(20%)+日期(20%)+时段(40%) | 300 |
| `search_fastest_bus_hz_to_sz` | 搜索杭州→深圳最快班次 | 杭州 | 深圳 | 后天 | 行程时间最短 | 搜索(20%)+最短时间(30%)+订单(20%)+信息(30%) | 300 |
| `book_japan_sim_card` | 购买日本SIM卡 | - | 日本 | - | 7天无限流量 | 订单(20%)+类型(20%)+地区(20%)+有效期(20%)+流量(20%) | 300 |
| `search_multi_country_wifi` | 搜索欧洲多国WiFi | - | 欧洲 | - | 覆盖≥5国 | 订单(20%)+类型(20%)+地区(20%)+国家数(40%) | 300 |
| `search_cheapest_europe_train` | 搜索欧洲最便宜火车票 | - | 欧洲境内 | 明天 | 全局最低价 | 搜索(20%)+最低价(40%)+订单(20%)+金额(20%) | 300 |
| `book_japan_train_morning` | 预订东京→京都新干线 | 东京站 | 京都站 | 后天 | 上午（12:00前） | 订单(20%)+地区(10%)+路线(20%)+日期(20%)+时段(30%) | 300 |

---

## 十一、技术规格总结

### 11.1 系统要求

- **服务器配置**: 8核32G 单机部署
- **操作系统**: Ubuntu 20.04+ / CentOS 7+
- **数据库**: PostgreSQL 14+
- **Ruby 版本**: 3.2+
- **Rails 版本**: 7.2
- **端口范围**: 5001-5050

### 11.2 核心技术栈

- **后端框架**: Ruby on Rails 7.2
- **数据库**: PostgreSQL + ActiveRecord
- **前端**: Stimulus + Turbo + Tailwind CSS
- **任务队列**: GoodJob（基于 PostgreSQL）
- **测试框架**: RSpec
- **容器化**: Docker + Docker Compose

### 11.3 关键设计特性

- **数据版本隔离**: 使用 `data_version` 字段隔离不同 session 的数据
- **行级安全**: PostgreSQL RLS 机制确保数据隔离
- **自动数据加载**: 数据包在 validator 初始化时自动加载
- **统一验证框架**: 继承 `BaseValidator` 类，标准化验证流程
- **评分系统**: 多维度加权评分，透明化评分过程

---

## 附录：联系方式与支持

- **技术支持**: [support@example.com](mailto:support@example.com)
- **文档仓库**: https://github.com/yourorg/travel-agent-tasks
- **问题反馈**: 提交 GitHub Issues
- **交付验收**: 联系项目负责人安排验收会议

---

**文档版本**: v1.0  
**最后更新**: 2024年  
**文档状态**: 草稿 → 待甲方审核
